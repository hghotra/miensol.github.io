<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.60c3ca86afa5e5c4da02.css">html{font-size:100}body{margin:0 0 0 calc(100vw - 100%);color:#222;line-height:1.625;font-size:1rem;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}body,h1,h2,h3,h4,h5,h6{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif}h1,h2,h3,h4,h5,h6{font-weight:600}h1{font-size:2.5rem;line-height:3.25rem;margin-top:6.5rem;margin-bottom:1.625rem}h2{font-size:1.6875rem;line-height:2.4375rem}h2,h3{margin-top:3.25rem;margin-bottom:.8125rem}h3{font-size:1.375rem;line-height:1.625rem}h4{font-size:1.2rem;margin-top:2.4375rem}h4,h5{line-height:1.625rem;margin-bottom:.8125rem}h5,h6{font-size:1rem;margin-top:4.0625rem}h6{line-height:1.625rem;margin-bottom:.8125rem}img{max-width:100%;margin:inherit auto}hr,img{border:0;display:block}hr{color:#222;height:1.625rem;margin:3.25rem auto;background-size:100% 26px;background-image:linear-gradient(180deg,transparent 1px,transparent 11px,#222 0,#222 15px,transparent 0,transparent 26px);width:6.25rem}a{color:#5d93ff;text-decoration:none}a:active,a:focus,a:hover{color:#f7a046}b,strong{font-weight:600}ul{list-style:square;margin-bottom:1.625rem}ul li{padding:0 .3125rem;margin-bottom:.625rem}p{line-height:1.625rem;margin-bottom:1.625rem}blockquote{padding:0;text-align:center}figure{display:block;width:100%;height:auto}figcaption{line-height:1.21875rem;margin-top:.40625rem;color:#222;font-size:.875rem;font-style:italic;margin-bottom:0;text-align:center}.anchor{margin-left:-1.875rem!important;padding-right:.875rem!important}@media screen and (min-width:685px){figure.float-left,figure.float-right{max-width:19.375rem;padding:0 1.625rem}.float-right{float:right}.float-left{float:left}}blockquote{background:#ededed;border-left:8px solid #5d93ff;box-shadow:0 3px 15px rgba(0,0,0,.15);color:#222;font-size:1.1em;font-style:italic;font-weight:300;line-height:1.6;margin:0;padding:1.2em;position:relative;vertical-align:super;z-index:0;overflow:hidden;text-align:start}blockquote:before{color:#5d93ff;content:"\201C";font-size:5em;left:0;position:absolute;top:-35px}blockquote p:before{color:#ddd;content:"\201C";font-size:50em;line-height:.65em;right:.095em;position:absolute;z-index:-1}blockquote span{color:#5d93ff;display:block;font-size:1.4em;font-weight:300;letter-spacing:.0625rem;margin-top:.5em}code[class*=language-],pre[class*=language-]{color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#073642}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{color:#657b83;background:#eee8d5}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.Author-module--author__photo--36xCH{display:inline-block;margin-bottom:0;border-radius:50%;background-clip:padding-box}.Author-module--author__title--2CaTb{font-size:1.125rem;font-weight:600;line-height:1.82813rem;margin:.8125rem 0}.Author-module--author__title-link--Yrism{color:#222}.Author-module--author__title-link--Yrism:focus,.Author-module--author__title-link--Yrism:hover{color:#222}.Author-module--author__subtitle--cAaEB{color:#888;line-height:1.625rem;margin-bottom:1.625rem}.Icon-module--icon--Gpyvw{display:inline-block;width:1em;height:1em;stroke-width:0;stroke:currentColor;fill:currentColor;font-style:normal;font-weight:400;speak:none;margin-right:.2em;text-align:center;font-variant:normal;text-transform:none;line-height:1em;margin-left:.2em;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.Contacts-module--contacts--1rGd1{margin-bottom:1.625rem}.Contacts-module--contacts__list--3OgdW{display:flex;flex-flow:row wrap;flex-grow:0;flex-shrink:0;list-style:none;padding:0;margin:.625rem -.1875rem;width:8.75rem}.Contacts-module--contacts__list-item--16p9q{padding:0;margin:.25rem;display:flex;align-content:center;align-items:center;justify-content:center;height:2.1875rem;width:2.1875rem;line-height:2.1875rem;border-radius:50%;text-align:center;border:1px solid #ebebeb}.Contacts-module--contacts__list-item-link--2MIDn{border:0;display:flex;color:#222}.Contacts-module--contacts__list-item-link--2MIDn:focus,.Contacts-module--contacts__list-item-link--2MIDn:hover{color:#5d93ff}.Copyright-module--copyright--1ariN{color:#b6b6b6;font-size:.875rem}.Menu-module--menu--Efbin{margin-bottom:1.625rem}.Menu-module--menu__list--31Zeo{list-style:none;padding:0;margin:0}.Menu-module--menu__list-item--1lJ6B{padding:0;margin:.625rem 0}.Menu-module--menu__list-item-link--10Ush{font-size:1rem;color:#222;font-weight:400;border:0}.Menu-module--menu__list-item-link--10Ush:focus,.Menu-module--menu__list-item-link--10Ush:hover{color:#5d93ff;border-bottom:1px solid #5d93ff}.Menu-module--menu__list-item-link--active--2CbUO{color:#222;border-bottom:1px solid #222}.Sidebar-module--sidebar--X4z2p{width:100%}.Sidebar-module--sidebar__inner--Jdc5s{position:relative;padding:1.5625rem 1.25rem 0}@media screen and (min-width:685px){.Sidebar-module--sidebar--X4z2p{width:calc(41.625% - 1.09375rem)}.Sidebar-module--sidebar--X4z2p:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Sidebar-module--sidebar--X4z2p:last-child{margin-right:0}.Sidebar-module--sidebar--X4z2p:nth-child(12n){margin-right:0;float:right}.Sidebar-module--sidebar--X4z2p:nth-child(12n+1){clear:both}.Sidebar-module--sidebar__inner--Jdc5s{padding:1.875rem 1.25rem 0}.Sidebar-module--sidebar__inner--Jdc5s:after{background:#e6e6e6;background:linear-gradient(180deg,#e6e6e6 0,#e6e6e6 48%,#fff);position:absolute;content:"";width:.0625rem;height:33.75rem;top:30px;right:-10px;bottom:0}}@media screen and (min-width:960px){.Sidebar-module--sidebar--X4z2p{width:calc(33.3% - 1.25rem)}.Sidebar-module--sidebar--X4z2p:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Sidebar-module--sidebar--X4z2p:last-child{margin-right:0}.Sidebar-module--sidebar--X4z2p:nth-child(3n){margin-right:0;float:right}.Sidebar-module--sidebar--X4z2p:nth-child(3n+1){clear:both}.Sidebar-module--sidebar__inner--Jdc5s{padding:2.5rem}}.Layout-module--layout--3Pyz6{max-width:66.875rem;margin-left:auto;margin-right:auto}.Layout-module--layout--3Pyz6:before{content:"";display:table}.Layout-module--layout--3Pyz6:after{content:"";display:table;clear:both}.Feed-module--feed__item--2D5rE{margin-bottom:2.03125rem}.Feed-module--feed__item--2D5rE:last-child{margin-bottom:.8125rem}.Feed-module--feed__item-title--3nigr{font-size:1.6875rem;line-height:2.4375rem;margin-top:0;margin-bottom:.8125rem}.Feed-module--feed__item-title-link--iFMRs{color:#222}.Feed-module--feed__item-title-link--iFMRs:focus,.Feed-module--feed__item-title-link--iFMRs:hover{color:#222;border-bottom:1px solid #222}.Feed-module--feed__item-description--1uO8e{font-size:1rem;line-height:1.625rem;margin-bottom:1.21875rem}.Feed-module--feed__item-meta-time--3t1fg{font-size:.875rem;color:#222;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-divider--N-Q0A{margin:0 .3125rem}.Feed-module--feed__item-meta-category-link--23f8F{font-size:.875rem;color:#f7a046;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-category-link--23f8F:focus,.Feed-module--feed__item-meta-category-link--23f8F:hover{color:#5d93ff}.Feed-module--feed__item-readmore--1u6bI{font-size:1rem;color:#5d93ff}.Feed-module--feed__item-readmore--1u6bI:focus,.Feed-module--feed__item-readmore--1u6bI:hover{color:#5d93ff;border-bottom:1px solid #5d93ff}.Page-module--page--2nMky{margin-bottom:3.25rem}.Page-module--page__inner--2M_vz{padding:1.5625rem 1.25rem}.Page-module--page__title--GPD8L{font-size:2.5rem;font-weight:600;line-height:3.25rem;margin-top:0;margin-bottom:2.35625rem}.Page-module--page__body--Ic6i6{font-size:1rem;line-height:1.625rem;margin:0 0 1.625rem}@media screen and (min-width:685px){.Page-module--page--2nMky{width:calc(58.275% - .78125rem)}.Page-module--page--2nMky:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Page-module--page--2nMky:last-child{margin-right:0}.Page-module--page--2nMky:nth-child(12n){margin-right:0;float:right}.Page-module--page--2nMky:nth-child(12n+1){clear:both}.Page-module--page__inner--2M_vz{padding:1.875rem 1.25rem}}@media screen and (min-width:960px){.Page-module--page--2nMky{width:calc(66.6% - .625rem)}.Page-module--page--2nMky:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Page-module--page--2nMky:last-child{margin-right:0}.Page-module--page--2nMky:nth-child(3n){margin-right:0;float:right}.Page-module--page--2nMky:nth-child(3n+1){clear:both}.Page-module--page__inner--2M_vz{padding:2.5rem 2.1875rem}}.Pagination-module--pagination--2H3nO{margin-top:3.25rem;display:flex}.Pagination-module--pagination__prev--bet5s{width:50%;text-align:left}.Pagination-module--pagination__prev-link--1Nzs6{color:#f7a046;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__prev-link--1Nzs6:focus,.Pagination-module--pagination__prev-link--1Nzs6:hover{color:#5d93ff}.Pagination-module--pagination__prev-link--disable--Yklx9{pointer-events:none;color:#bbb}.Pagination-module--pagination__next--3hFiN{width:50%;text-align:right}.Pagination-module--pagination__next-link--3FUtA{color:#f7a046;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__next-link--3FUtA:focus,.Pagination-module--pagination__next-link--3FUtA:hover{color:#5d93ff}.Pagination-module--pagination__next-link--disable--30UwZ{pointer-events:none;color:#bbb}.Author-module--author--2Yefr{border-top:1px solid #e6e6e6;max-width:40rem;padding-top:1.25rem;line-height:1.625rem;margin-top:1.625rem;margin-bottom:3.25rem}.Author-module--author__bio-contact--8_j8F{display:block;text-decoration:underline}@media screen and (min-width:685px){.Author-module--author--2Yefr{margin-left:auto;margin-right:auto}}.Content-module--content--3p512{max-width:59.0625rem;padding:0 .9375rem;margin:0 auto}.Content-module--content__title--2BDW9{font-size:2rem;max-width:40rem;font-weight:600;text-align:center;line-height:2.68125rem;margin:1.625rem auto 0}.Content-module--content__body--2TrQ- figure{margin-bottom:1.625rem}.Content-module--content__body--2TrQ- figure blockquote{font-style:italic;text-align:center;margin-top:0;padding:1.625rem 0}.Content-module--content__body--2TrQ- figure blockquote p{max-width:40rem;font-size:1.6817rem;margin-top:0;margin-bottom:1.625rem;line-height:2.4375rem}.Content-module--content__body--2TrQ- a{text-decoration:underline}.Content-module--content__body--2TrQ- *{max-width:40rem;margin-left:auto;margin-right:auto}.Content-module--content__body--2TrQ- img{max-width:100%}@media screen and (min-width:960px){.Content-module--content--3p512{padding:0}.Content-module--content__title--2BDW9{font-size:3rem;line-height:3.65625rem;margin-top:3.65625rem;margin-bottom:2.4375rem}.Content-module--content__body--2TrQ-,.Content-module--content__body--2TrQ- p{font-size:1.125rem;line-height:1.82813rem;margin-bottom:1.82813rem}}.Meta-module--meta__date--29eD7{font-style:italic}.Tags-module--tags--1L_ct{margin-bottom:.8125rem}.Tags-module--tags__list--91FqN{list-style:none;margin:0 -.625rem;padding:0}.Tags-module--tags__list-item--1M30P{display:inline-block;margin:.625rem .3125rem}.Tags-module--tags__list-item-link--3SL_8{display:inline-block;height:2.1875rem;padding:0 1.5rem;line-height:2.1875rem;border:1px solid #e6e6e6;text-decoration:none;border-radius:1.25rem;color:#222}.Tags-module--tags__list-item-link--3SL_8:focus,.Tags-module--tags__list-item-link--3SL_8:hover{color:#5d93ff}.Post-module--post__comments--25y6I,.Post-module--post__footer--3WzWU{max-width:40rem;margin:0 auto;padding:0 .9375rem}.Post-module--post__home-button--16Kl0{display:block;max-width:5.625rem;height:2.1875rem;padding:0 1.5rem;line-height:2.1875rem;text-align:center;color:#222;border:1px solid #e6e6e6;border-radius:1.25rem;font-size:1rem;font-weight:400;margin-left:auto;margin-right:auto;margin-top:1.625rem}.Post-module--post__home-button--16Kl0:focus,.Post-module--post__home-button--16Kl0:hover{color:#5d93ff}@media screen and (min-width:960px){.Post-module--post__comments--25y6I,.Post-module--post__footer--3WzWU{padding:0}.Post-module--post__home-button--16Kl0{position:fixed;max-width:auto;margin:0;top:30px;left:30px}}</style><meta name="generator" content="Gatsby 2.21.9"/><link rel="alternate" type="application/rss+xml" title="Piotr Mionskowski" href="/feed.xml"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-49294874-1"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-49294874-1', {"send_page_view":false});
      }
      </script><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link rel="icon" href="/favicon-32x32.png?v=6c7ff033d8d3a409da0f2d709d5b2f23"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#F7A046"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=6c7ff033d8d3a409da0f2d709d5b2f23"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=6c7ff033d8d3a409da0f2d709d5b2f23"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=6c7ff033d8d3a409da0f2d709d5b2f23"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=6c7ff033d8d3a409da0f2d709d5b2f23"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=6c7ff033d8d3a409da0f2d709d5b2f23"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=6c7ff033d8d3a409da0f2d709d5b2f23"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=6c7ff033d8d3a409da0f2d709d5b2f23"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=6c7ff033d8d3a409da0f2d709d5b2f23"/><title data-react-helmet="true">Nonintrusive http proxy in nodejs - Piotr Mionskowski</title><meta data-react-helmet="true" name="description" content="In my previous posts I wrote about problems that might occur when
using http proxy written in nodejs to debug http issues.
Today I’m going to describe how to use nodejs builtin parser to 
overcome these problems. Nodejs streams Node.js has decent support for handling streams. Especially
the  function takes a lot of…"/><meta data-react-helmet="true" property="og:site_name" content="Nonintrusive http proxy in nodejs - Piotr Mionskowski"/><meta data-react-helmet="true" property="og:image" content="https://miensol.pl//piotr-bright.jpg"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:title" content="Nonintrusive http proxy in nodejs - Piotr Mionskowski"/><meta data-react-helmet="true" name="twitter:description" content="In my previous posts I wrote about problems that might occur when
using http proxy written in nodejs to debug http issues.
Today I’m going to describe how to use nodejs builtin parser to 
overcome these problems. Nodejs streams Node.js has decent support for handling streams. Especially
the  function takes a lot of…"/><meta data-react-helmet="true" name="twitter:image" content="https://miensol.pl//piotr-bright.jpg"/><link as="script" rel="preload" href="/webpack-runtime-81078feff732a01ca8b6.js"/><link as="script" rel="preload" href="/framework-ff21b39501fa5007c91d.js"/><link as="script" rel="preload" href="/532a2f07-5faf1395916999ba184f.js"/><link as="script" rel="preload" href="/app-6174af72088d24da11e8.js"/><link as="script" rel="preload" href="/styles-8636a280cbc61d53ad10.js"/><link as="script" rel="preload" href="/c39ba592b6b5047a9857340a927d4f5e647ac87b-a4bdae0c130dc607cbb4.js"/><link as="script" rel="preload" href="/70ba16277e1f8ff187315c677a20c57a8b12f94a-076ebef65155af783aeb.js"/><link as="script" rel="preload" href="/component---src-templates-post-template-tsx-c32fd150628cfd6dfdcc.js"/><link as="fetch" rel="preload" href="/page-data/non-intrusive-http-proxy-in-nodejs/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="Layout-module--layout--3Pyz6"><div><a class="Post-module--post__home-button--16Kl0" href="/">All Articles</a><div><div class="Content-module--content--3p512"><h1 class="Content-module--content__title--2BDW9">Nonintrusive http proxy in nodejs</h1><div class="Content-module--content__body--2TrQ-"><p>In my previous posts I wrote about problems that might occur when
using http proxy written in nodejs to debug http issues.
Today I’m going to describe how to use nodejs builtin parser to
overcome these problems.</p>
<h2 id="nodejs-streams" style="position:relative;"><a href="#nodejs-streams" aria-label="nodejs streams permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Nodejs streams</h2>
<p>Node.js has decent support for handling streams. Especially
the <code class="language-text">pipe</code> function takes a lot of burden away - whereas previously
it had to be carefully handled by programmer.
As a first step let’s use a simple socket server and tunnel http requests
through it:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> stdout <span class="token operator">=</span> process<span class="token punctuation">.</span>stdout<span class="token punctuation">;</span>
<span class="token keyword">var</span> server <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">clientSocket</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> serverSocket <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">,</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

      clientSocket<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>serverSocket<span class="token punctuation">)</span><span class="token punctuation">;</span>
      clientSocket<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>

      serverSocket<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>clientSocket<span class="token punctuation">)</span><span class="token punctuation">;</span>
      serverSocket<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">9000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>The above code creates a socket server listening on port <code class="language-text">9000</code>.
When it gets a connection from client it will immediately try to
connect to other server listening on port <code class="language-text">8888</code> - this is a port
used by Fiddler or Charles. After the connection is established
it uses <code class="language-text">pipe</code> function to pass all data coming in on port <code class="language-text">9000</code>
to port <code class="language-text">8888</code> as well as to standard output just so we can see
what data is sent from client. We also need to pass data returned
from port <code class="language-text">8888</code> back to client that’s why there is the second pair
of <code class="language-text">pipe</code> calls.</p>
<p>With that we can already use <code class="language-text">curl</code> to see raw http traffic written
directly to standard output.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> http://wp.pl/ --proxy http://localhost:9000/</code></pre></div>
<h2 id="creating-http-proxy-on-network-level" style="position:relative;"><a href="#creating-http-proxy-on-network-level" aria-label="creating http proxy on network level permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Creating http proxy on network level</h2>
<p>The above example albeit simple doesn’t really provide any value as
we still need a <em>external</em> proxy to properly pass http traffic.
In order to make it a <strong>real</strong> http proxy we need to add parsing logic
that will extract information about target server where we should pass
incoming data too. While building a very simple http parser isn’t difficult
why don’t we use existing one that is built right into node.js core http module?</p>
<p>Using node.js http parser isn’t exactly documented and I guess it’s not
part of public API. Nevertheless it is exposed to client code intentionally
and a quick look through the core http module source code gives
enough examples of how to use it. With existing parser
instance the only thing left to do is to extract <code class="language-text">Host</code> header
value, use it to connect to target server. Here is a core part
of code required:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">socketRequest</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> requestParser <span class="token operator">=</span> HttpParsingStream<span class="token punctuation">.</span><span class="token function">createForRequest</span><span class="token punctuation">(</span>socketRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>

    requestParser<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'headers'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//pause the request until we setup necessary plumbing</span>
        req<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//extract information about target server</span>
        <span class="token keyword">var</span> hostNameHeader <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>host<span class="token punctuation">,</span>
            hostAndPort <span class="token operator">=</span> hostNameHeader<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            host <span class="token operator">=</span> hostAndPort<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            port <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>hostAndPort<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">80</span><span class="token punctuation">;</span>
        <span class="token comment">// now we now where to tunnel client request</span>
        <span class="token keyword">var</span> srvSocket <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> host<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//a response parser as a replacement for stdout</span>
            <span class="token keyword">var</span> responseParser <span class="token operator">=</span> HttpParsingStream<span class="token punctuation">.</span><span class="token function">createForResponse</span><span class="token punctuation">(</span>srvSocket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            srvSocket<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>responseParser<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//pipe data from server to client</span>
            srvSocket<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>socketRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//flush data buffered in parser to target server</span>
            requestParser<span class="token punctuation">.</span><span class="token function">writeCurrentChunks</span><span class="token punctuation">(</span>srvSocket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//pipe remaining data from client to target server</span>
            socketRequest<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>srvSocket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//resume processing</span>
            req<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//pipe data from client to request parser</span>
    socketRequest<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>requestParser<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">9000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>The above code makes use of <code class="language-text">HttpParsingStream</code> which is a hand
rolled writable <code class="language-text">Stream</code> that uses node.js http parser to emit
events. As you can see we first pipe client socket to <code class="language-text">requestParser</code>
to get information about target server. As soon as we get <code class="language-text">headers</code>
event the incoming client request is paused, we setup connection
to target server, write raw data buffered in <code class="language-text">requestParser</code>
and setup <code class="language-text">pipe</code>s in a similar fashion as in the previous example.
The most important property of this http proxy is that it
<strong>does not change</strong> data coming from client and from target server
in any way which is invaluable when debugging problems in
http implementations.</p>
<h2 id="httpparsingstream-explained" style="position:relative;"><a href="#httpparsingstream-explained" aria-label="httpparsingstream explained permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>HttpParsingStream explained</h2>
<p>The above example relies on 2 instances of <code class="language-text">HttpParsingStream</code>
for request and response respectively:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    stream <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'stream'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Writable <span class="token operator">=</span> stream<span class="token punctuation">.</span>Writable<span class="token punctuation">,</span>
    parsers <span class="token operator">=</span> http<span class="token punctuation">.</span>parsers<span class="token punctuation">,</span>
    HTTPParser <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">binding</span><span class="token punctuation">(</span><span class="token string">'http_parser'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>HTTPParser<span class="token punctuation">,</span>
    util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">HttpParsingStream</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">Writable</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> socket <span class="token operator">=</span> options<span class="token punctuation">.</span>socket<span class="token punctuation">;</span>
    <span class="token comment">//get an instance of node parser</span>
    <span class="token keyword">var</span> parser <span class="token operator">=</span> parsers<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//buffer for raw data</span>
    <span class="token keyword">var</span> streamChunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">//initialize as request or response parser</span>
    parser<span class="token punctuation">.</span><span class="token function">reinitialize</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>parserMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    parser<span class="token punctuation">.</span>socket <span class="token operator">=</span> socket<span class="token punctuation">;</span>
    socket<span class="token punctuation">.</span>parser <span class="token operator">=</span> parser<span class="token punctuation">;</span>
    <span class="token comment">//called by node http module when headers are parsed</span>
    parser<span class="token punctuation">.</span><span class="token function-variable function">onIncoming</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        that<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'headers'</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//this is one of ways to get 'end' event</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            that<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//free parser</span>
            <span class="token function">freeParser</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        that<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'socket.close'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">_write</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        streamChunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            chunk<span class="token operator">:</span> chunk<span class="token punctuation">,</span>
            encoding<span class="token operator">:</span> encoding
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//pass data to parser</span>
        parser<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> chunk<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        callback <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">//write data currently in buffer to other stream</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">writeCurrentChunks</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">writableStream</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        streamChunks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">chunkObj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            writableStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>chunkObj<span class="token punctuation">.</span>chunk<span class="token punctuation">,</span> chunkObj<span class="token punctuation">.</span>encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
util<span class="token punctuation">.</span><span class="token function">inherits</span><span class="token punctuation">(</span>HttpParsingStream<span class="token punctuation">,</span> Writable<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>The <code class="language-text">HttpParsingStream</code> accepts 2 options:</p>
<ul>
<li><code class="language-text">socket</code> for underlying request and response</li>
<li><code class="language-text">parserMode</code> used to properly initialise node.js http parser</li>
</ul>
<p>Here’s how we create objects with it:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">HttpParsingStream<span class="token punctuation">.</span><span class="token function-variable function">createForRequest</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HttpParsingStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        socket<span class="token operator">:</span> socket<span class="token punctuation">,</span>
        parserMode<span class="token operator">:</span> HTTPParser<span class="token punctuation">.</span><span class="token constant">REQUEST</span><span class="token punctuation">,</span>
        <span class="token comment">//used only for debugging</span>
        name<span class="token operator">:</span> <span class="token string">'request'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
HttpParsingStream<span class="token punctuation">.</span><span class="token function-variable function">createForResponse</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HttpParsingStream</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        socket<span class="token operator">:</span> socket<span class="token punctuation">,</span>
        parserMode<span class="token operator">:</span> HTTPParser<span class="token punctuation">.</span><span class="token constant">RESPONSE</span><span class="token punctuation">,</span>
        <span class="token comment">//used only for debugging</span>
        name<span class="token operator">:</span> <span class="token string">'response'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>Because <code class="language-text">HttpParsingStream</code> is a <code class="language-text">Writable</code> stream we can
use it as:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">socketRequest<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>HttpParsingStream<span class="token punctuation">.</span><span class="token function">createForRequest</span><span class="token punctuation">(</span>socketRequest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

serverSocket<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>HttpParsingStream<span class="token punctuation">.</span><span class="token function">createForResponse</span><span class="token punctuation">(</span>serverSocket<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>and let node.js code handle buffering, pausing and resuming.
There is also one additional function used to clean up and return
a parser instance back to pool - it’s a copy paste from node.js
http module source code:</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">freeParser</span><span class="token punctuation">(</span><span class="token parameter">parser<span class="token punctuation">,</span> req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        parser<span class="token punctuation">.</span>_headers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        parser<span class="token punctuation">.</span>onIncoming <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parser<span class="token punctuation">.</span>socket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            parser<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>onend <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            parser<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>ondata <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            parser<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>parser <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        parser<span class="token punctuation">.</span>socket <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        parser<span class="token punctuation">.</span>incoming <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        parsers<span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        parser <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        req<span class="token punctuation">.</span>parser <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h2 id="why-create-yet-another-http-proxy-implementation" style="position:relative;"><a href="#why-create-yet-another-http-proxy-implementation" aria-label="why create yet another http proxy implementation permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Why create yet another http proxy implementation?</h2>
<p>proxy-mirror a simple http debugging tool that I wrote
so far relies on an excellent http-proxy module.
However because http-proxy was created to be used mostly as a
reverse proxy to route http traffic to different http servers
it does not provide a way to access raw tcp data. With the above
code I now have an easy way to access the data - so I can
display it in a byte level manner - a feature of Fiddler that
I find handy from time to time.</p>
<p>Moreover the target server will receive a request from client in an unchanged
form. The same applies for response received by client.
This is extremely important when resolving issues related
to improper implementations of HTTP protocol.</p>
<p>I haven’t yet checked how the above code handles WebSocket
connections - I’ll explore that in a next post. For the referece
you can find full code in this <a href="https://gist.github.com/9726643" target="_blank" rel="nofollow noopener noreferrer">gist</a>.</p></div></div></div><div class="Post-module--post__footer--3WzWU"><div><p class="Meta-module--meta__date--29eD7">Published <!-- -->23 Mar 2014</p></div><div class="Tags-module--tags--1L_ct"><ul class="Tags-module--tags__list--91FqN"><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/nodejs/">nodejs</a></li><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/http/">http</a></li><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/proxy/">proxy</a></li></ul></div><div class="Author-module--author--2Yefr"><p>TDD fan eager to learn new things. Always focused, always eager to ask why?<a class="Author-module--author__bio-contact--8_j8F" href="mailto:piotr.mionskowski@gmail.com" rel="noopener noreferrer" target="_blank"><strong>Piotr Mionskowski</strong></a></p></div></div><div class="Post-module--post__comments--25y6I"><div><div id="disqus_thread"></div></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/non-intrusive-http-proxy-in-nodejs/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-6174af72088d24da11e8.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-78521276b246725d0e0f.js"],"component---src-templates-categories-list-template-tsx":["/component---src-templates-categories-list-template-tsx-1443a27db8e607e06eaf.js"],"component---src-templates-category-template-tsx":["/component---src-templates-category-template-tsx-9b2527fed1bbc12d167a.js"],"component---src-templates-index-template-tsx":["/component---src-templates-index-template-tsx-90ea64a37c4d7b280402.js"],"component---src-templates-not-found-template-tsx":["/component---src-templates-not-found-template-tsx-3d89186c897c9782220b.js"],"component---src-templates-page-template-tsx":["/component---src-templates-page-template-tsx-daedb109729ccd084ce5.js"],"component---src-templates-post-template-tsx":["/component---src-templates-post-template-tsx-c32fd150628cfd6dfdcc.js"],"component---src-templates-tag-template-tsx":["/component---src-templates-tag-template-tsx-0485877a475bb21e2d32.js"],"component---src-templates-tags-list-template-tsx":["/component---src-templates-tags-list-template-tsx-82656016ea107e26a0f3.js"]};/*]]>*/</script><script src="/component---src-templates-post-template-tsx-c32fd150628cfd6dfdcc.js" async=""></script><script src="/70ba16277e1f8ff187315c677a20c57a8b12f94a-076ebef65155af783aeb.js" async=""></script><script src="/c39ba592b6b5047a9857340a927d4f5e647ac87b-a4bdae0c130dc607cbb4.js" async=""></script><script src="/styles-8636a280cbc61d53ad10.js" async=""></script><script src="/app-6174af72088d24da11e8.js" async=""></script><script src="/532a2f07-5faf1395916999ba184f.js" async=""></script><script src="/framework-ff21b39501fa5007c91d.js" async=""></script><script src="/webpack-runtime-81078feff732a01ca8b6.js" async=""></script></body></html>