{"componentChunkName":"component---src-templates-post-template-tsx","path":"/clear-database-in-spring-boot-tests/","result":{"data":{"markdownRemark":{"id":"e53cbfb0-1b79-55c6-9a2e-f7a56519b857","html":"<p>Nowadays using a production like database in <em>unit</em><sup><a href=\"#sup-1\">1</a></sup> tests is a common practice. Calling a real database can increase our confidence that a tested code actually works. Having said that a database, by its very nature, brings external state into a test that will affect its behavior, hence we need to pay special attention to prepare the test execution. There are couple of ways to handle the database state in tests and I’m going to describe an approach I like most.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 640px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/02fae8050074badc44f5ac157c98e966/c08c5/disk.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAIEAQP/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHk1s4pgf/EABoQAAICAwAAAAAAAAAAAAAAAAECAxIAEBH/2gAIAQEAAQUCSN+COmka6FKjP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EAB0QAAIBBAMAAAAAAAAAAAAAAAECEQAQEiEiUaH/2gAIAQEABj8C57ZvKnMmwPdMsyG3b//EABkQAAMBAQEAAAAAAAAAAAAAAAABESFBUf/aAAgBAQABPyGum4KaIa9Y26ZHIsEWjK1wZ//aAAwDAQACAAMAAAAQ8M//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAcEAACAwADAQAAAAAAAAAAAAABEQAhQTFRYXH/2gAIAQEAAT8QoKF7ENJzePIUKMRCOOr+TIjlqyZqEaWB7UtDyFc//9k='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/02fae8050074badc44f5ac157c98e966/8ac56/disk.webp 240w,\n/static/02fae8050074badc44f5ac157c98e966/d3be9/disk.webp 480w,\n/static/02fae8050074badc44f5ac157c98e966/0ba47/disk.webp 640w\"\n          sizes=\"(max-width: 640px) 100vw, 640px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/02fae8050074badc44f5ac157c98e966/09b79/disk.jpg 240w,\n/static/02fae8050074badc44f5ac157c98e966/7cc5e/disk.jpg 480w,\n/static/02fae8050074badc44f5ac157c98e966/c08c5/disk.jpg 640w\"\n          sizes=\"(max-width: 640px) 100vw, 640px\"\n          type=\"image/jpeg\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/02fae8050074badc44f5ac157c98e966/c08c5/disk.jpg\"\n          alt=\"Database\"\n          title=\"Database\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n  </a>\n    </span>{: .center-image}</p>\n<h2 id=\"problems-with-spring-boot-transactional-tests\" style=\"position:relative;\"><a href=\"#problems-with-spring-boot-transactional-tests\" aria-label=\"problems with spring boot transactional tests permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Problems with Spring Boot Transactional tests</h2>\n<p>Spring Boot offers many helpers to make testing application easier. Among many you can use a <a href=\"https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-testing.html#boot-features-testing-spring-boot-applications-testing-autoconfigured-jpa-test\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">@DataJpaTest</code></a> which by default will configure an in-memory embedded database. You can use a production type database in tests by adding <code class=\"language-text\">@AutoConfigureTestDatabase(replace=Replace.NONE)</code> like so:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RunWith</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SpringRunner</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@DataJpaTest</span>\n<span class=\"token annotation punctuation\">@AutoConfigureTestDatabase</span><span class=\"token punctuation\">(</span>replace<span class=\"token operator\">=</span><span class=\"token class-name\">Replace</span><span class=\"token punctuation\">.</span>NONE<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ExampleRepositoryTests</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">// ...</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The <code class=\"language-text\">@DataJpaTest</code> uses <code class=\"language-text\">@Transactional</code> under the hood. A test is wrapped inside a transaction that is rolled back at the end. This means that when using e.g. Hibernate one needs to pay special attention to how the tested code is written. <a href=\"https://docs.spring.io/spring/docs/4.3.11.RELEASE/spring-framework-reference/htmlsingle/#testcontext-tx-enabling-transactions\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">As shown in the Java example below</a>, a manual flush is indeed required:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RunWith</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SpringRunner</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@ContextConfiguration</span><span class=\"token punctuation\">(</span>classes <span class=\"token operator\">=</span> <span class=\"token class-name\">TestConfig</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@Transactional</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HibernateUserRepositoryTests</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">createUser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// track initial state in test database:</span>\n        <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> count <span class=\"token operator\">=</span> <span class=\"token function\">countRowsInTable</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"user\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">User</span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        repository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Manual flush is required to avoid false positive in test</span>\n        sessionFactory<span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentSession</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">assertNumUsers</span><span class=\"token punctuation\">(</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Using <code class=\"language-text\">@Transactional</code> annotation on tests is certainly easy but <strong>I still don’t use it</strong> for the following reasons:</p>\n<ul>\n<li>The production code is using transactions with different scope.</li>\n<li>It is easy to forget about a flush and thus have false positive in test.</li>\n<li>On failure and when debugging it is hard to see what values were actually saved in db.</li>\n<li>It is much harder to write tests of production code that requires a transaction to be committed. </li>\n<li>The test code needs to be more tightly coupled to production code and <a href=\"http://blog.cleancoder.com/uncle-bob/2017/10/03/TestContravariance.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">we all know that it hinders refactoring</a>.</li>\n</ul>\n<h2 id=\"cleaning-database-with-sql\" style=\"position:relative;\"><a href=\"#cleaning-database-with-sql\" aria-label=\"cleaning database with sql permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cleaning database with SQL</h2>\n<p>In tests involving a database I reset its state <strong>before each</strong> test using plain old SQL. This makes the test code less dependent on how a transaction is scoped inside production code. Furthermore, one can easily review the values saved <strong>after a test failure</strong>. It turns out it is easy to write a JUnit <code class=\"language-text\">@Rule</code> or <a href=\"http://junit.org/junit5/docs/5.0.1/api/org/junit/jupiter/api/extension/BeforeEachCallback.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">BeforeEachCallback</code></a> that will remove all rows from all tables. Moreover, we can do so without hard coding table names which would increase maintenance cost.</p>\n<p>Let’s start with defining a <code class=\"language-text\">@Rule</code> in Kotlin in that will be called before each test:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>junit<span class=\"token punctuation\">.</span>rules<span class=\"token punctuation\">.</span>ExternalResource\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>stereotype<span class=\"token punctuation\">.</span>Component\n<span class=\"token keyword\">import</span> javax<span class=\"token punctuation\">.</span>sql<span class=\"token punctuation\">.</span>DataSource\n\n<span class=\"token annotation builtin\">@Component</span>\n<span class=\"token keyword\">class</span> <span class=\"token function\">DatabaseCleanerRule</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> dataSource<span class=\"token operator\">:</span> DataSource<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token function\">ExternalResource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">before</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>databaseCleaner <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// Consider inspecting dataSource to check if we are connecting to test database</span>\n            databaseCleaner <span class=\"token operator\">=</span> <span class=\"token function\">DatabaseCleaner</span><span class=\"token punctuation\">(</span>dataSource<span class=\"token operator\">::</span>getConnection<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        databaseCleaner<span class=\"token operator\">!!</span><span class=\"token punctuation\">.</span><span class=\"token function\">reset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">companion</span> <span class=\"token keyword\">object</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">internal</span> <span class=\"token keyword\">var</span> databaseCleaner<span class=\"token operator\">:</span> DatabaseCleaner<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Consider inspecting <code class=\"language-text\">dataSource</code> to check if we are about to connect to test database and <strong>not one used for development.</strong> It is very easy to use incorrect Spring Profile and wipe out your development data. Ask me how I know?</p>\n<p>We can use the <code class=\"language-text\">DatabaseCleanerRule</code> in a spring enabled test as any other JUnit rule e.g. <code class=\"language-text\">@Rule @Inject lateinit var cleanerRule: DatabaseCleanerRule</code>.</p>\n<p>Notice that we’ve delegated the actual important work to <code class=\"language-text\">DatabaseCleaner</code> class defined in Kotlin below. </p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">import</span> com<span class=\"token punctuation\">.</span>practi<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>iterator\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>slf4j<span class=\"token punctuation\">.</span>LoggerFactory\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>sql<span class=\"token punctuation\">.</span>Connection\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>sql<span class=\"token punctuation\">.</span>PreparedStatement\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>sql<span class=\"token punctuation\">.</span>SQLException\n\n<span class=\"token keyword\">class</span> <span class=\"token function\">DatabaseCleaner</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> connectionProvider<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> Connection<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> tablesToExclude <span class=\"token operator\">=</span> mutableSetOf<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">var</span> tablesForClearing<span class=\"token operator\">:</span> List<span class=\"token operator\">&lt;</span>TableRef<span class=\"token operator\">></span><span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">excludeTables</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">vararg</span> tableNames<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        tablesToExclude <span class=\"token operator\">+=</span> tableNames<span class=\"token punctuation\">.</span><span class=\"token function\">flatMap</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">listOf</span><span class=\"token punctuation\">(</span>it<span class=\"token punctuation\">,</span> it<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">reset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>notPrepared<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">prepare</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token function\">executeReset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> notPrepared <span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> tablesForClearing <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">prepare</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">connectionProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">use</span> <span class=\"token punctuation\">{</span> connection <span class=\"token operator\">-></span>\n            <span class=\"token keyword\">val</span> metaData <span class=\"token operator\">=</span> connection<span class=\"token punctuation\">.</span>metaData\n            <span class=\"token keyword\">val</span> tableRefs <span class=\"token operator\">=</span> metaData<span class=\"token punctuation\">.</span><span class=\"token function\">getTables</span><span class=\"token punctuation\">(</span>connection<span class=\"token punctuation\">.</span>catalog<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token function\">arrayOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"TABLE\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">use</span> <span class=\"token punctuation\">{</span> tables <span class=\"token operator\">-></span>\n                <span class=\"token function\">iterator</span><span class=\"token punctuation\">(</span>tables<span class=\"token operator\">::</span>next<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> tables<span class=\"token punctuation\">.</span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"TABLE_NAME\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">asSequence</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">filterNot</span><span class=\"token punctuation\">(</span>tablesToExclude<span class=\"token operator\">::</span>contains<span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token operator\">::</span>TableRef<span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n\n            tablesForClearing <span class=\"token operator\">=</span> tableRefs\n\n            LOG<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Prepared clean db command: {}\"</span><span class=\"token punctuation\">,</span> tablesForClearing<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">executeReset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">connectionProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">use</span> <span class=\"token punctuation\">{</span> connection <span class=\"token operator\">-></span>\n                <span class=\"token keyword\">val</span> reset <span class=\"token operator\">=</span> <span class=\"token function\">buildClearStatement</span><span class=\"token punctuation\">(</span>connection<span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">val</span> result <span class=\"token operator\">=</span> reset<span class=\"token punctuation\">.</span><span class=\"token function\">executeBatch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                result\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token operator\">:</span> SQLException<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">val</span> status <span class=\"token operator\">=</span> <span class=\"token function\">engineInnoDbStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            LOG<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Failed to remove rows because {}. InnoDb status: {}\"</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">,</span> status<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">throw</span> e\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">engineInnoDbStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> String <span class=\"token punctuation\">{</span> <span class=\"token operator\">..</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">buildClearStatement</span><span class=\"token punctuation\">(</span>connection<span class=\"token operator\">:</span> Connection<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> PreparedStatement <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> reset <span class=\"token operator\">=</span> connection<span class=\"token punctuation\">.</span><span class=\"token function\">prepareStatement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span>\n        reset<span class=\"token punctuation\">.</span><span class=\"token function\">addBatch</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SET FOREIGN_KEY_CHECKS = 0\"</span><span class=\"token punctuation\">)</span>\n        tablesForClearing<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span> <span class=\"token punctuation\">{</span> ref <span class=\"token operator\">-></span>\n            reset<span class=\"token punctuation\">.</span><span class=\"token function\">addBatch</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DELETE FROM `<span class=\"token interpolation\"><span class=\"token delimiter variable\">${</span>ref<span class=\"token punctuation\">.</span>name<span class=\"token delimiter variable\">}</span></span>`\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        reset<span class=\"token punctuation\">.</span><span class=\"token function\">addBatch</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SET FOREIGN_KEY_CHECKS = 1\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> reset\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">data</span> <span class=\"token keyword\">class</span> <span class=\"token function\">TableRef</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">val</span> name<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">companion</span> <span class=\"token keyword\">object</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> LOG <span class=\"token operator\">=</span> LoggerFactory<span class=\"token punctuation\">.</span><span class=\"token function\">getLogger</span><span class=\"token punctuation\">(</span>DatabaseCleaner<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">)</span><span class=\"token operator\">!!</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Notice that we’ve defined <code class=\"language-text\">tablesToExclude</code> set that allows us to omit certain tables. This comes in handy when you’re using a database migration tool that stores its state inside some table(s).</p>\n<p><a href=\"https://docs.oracle.com/javase/7/docs/api/java/sql/DatabaseMetaData.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">The JDBC metadata</a> allows us to introspect schema regardless of the database vendor. The <code class=\"language-text\">iterator</code> is a tiny Kotlin function that aids consuming iterator like objects:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">inline</span> <span class=\"token keyword\">fun</span> <span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> <span class=\"token function\">iterator</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">crossinline</span> next<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> Boolean<span class=\"token punctuation\">,</span> <span class=\"token keyword\">crossinline</span> value<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> T<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> AbstractIterator<span class=\"token operator\">&lt;</span><span class=\"token keyword\">out</span> T<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token keyword\">object</span> <span class=\"token operator\">:</span> AbstractIterator<span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">computeNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">setNext</span><span class=\"token punctuation\">(</span><span class=\"token function\">value</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The <code class=\"language-text\">buildClearStatement</code> constructs a large query that <code class=\"language-text\">DELETE</code>s all rows from each relevant table. The example above uses MySQL where it is very easy to disable foreign key checks. This is important since foreign keys would prevent rows to be removed unless we paid special attention to the order of removal. A more generic example of how to deal with referential integrity when clearing a database can be found in the <a href=\"https://github.com/jbogard/Respawn\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Respawn project</a>.</p>\n<p>Last but not least, when a <code class=\"language-text\">SQLException</code> is thrown we log the exception accompanied with <a href=\"https://dev.mysql.com/doc/refman/5.7/en/show-engine.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">SHOW ENGINE INNODB STATUS</code></a>. The status information can hint us about failure reason e.g. another test process executing against the same database or a rogue, runaway thread that locks some rows. </p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">engineInnoDbStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> String <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">connectionProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">use</span> <span class=\"token punctuation\">{</span> connection <span class=\"token operator\">-></span>\n        connection<span class=\"token punctuation\">.</span><span class=\"token function\">createStatement</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">executeQuery</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SHOW ENGINE INNODB STATUS \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">use</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">iterator</span><span class=\"token punctuation\">(</span>it<span class=\"token operator\">::</span>next<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> it<span class=\"token punctuation\">.</span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Status\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">asSequence</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">joinToString</span><span class=\"token punctuation\">(</span>System<span class=\"token punctuation\">.</span><span class=\"token function\">lineSeparator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The above examples show that it is not hard to manually reset the database. I’ve found that using this approach makes my tests more trustworthy and less coupled to the underlying persistence layer. In fact, we can easily switch e.g. from JPA to <code class=\"language-text\">JdbcTemplate</code> in a performance critical code area without a need to change a test.</p>\n<p><em><sup>1</sup></em><a name=\"sup-1\"></a> Whether it is actually unit or integration test is a different topic.</p>","fields":{"slug":"/clear-database-in-spring-boot-tests/","tagSlugs":["/tag/tests/","/tag/spring-boot/","/tag/database/","/tag/kotlin/"]},"excerpt":"Nowadays using a production like database in unit1 tests is a common practice. Calling a real database can increase our confidence that a tested code actually works. Having said that a database, by its very nature, brings external state into a test that will affect its behavior, hence we need to pay special attention…","frontmatter":{"date":"2017-10-13T22:14:00.000Z","description":null,"tags":["tests","spring boot","database","kotlin"],"title":"How to clear database in Spring Boot tests?","socialImage":null}}},"pageContext":{"slug":"/clear-database-in-spring-boot-tests/"}}}