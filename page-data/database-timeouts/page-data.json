{"componentChunkName":"component---src-templates-post-template-tsx","path":"/database-timeouts/","result":{"data":{"markdownRemark":{"id":"edc69431-75ca-5b63-9452-dc17666e82db","html":"<p>Last time I have outlined <a href=\"/the-importance-of-timeouts\">the importance of timeouts</a>. Without a carefully considered timeouts our application can become unresponsive easily. In this post I will focus on configuring various timeouts related to interaction with database. I am going to focus specifically on relational databases. The principles and practices however can be applied equally well to other types of databases.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 640px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f7abe2875ea078ff7e8f6c2905313058/c08c5/database-files.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.083333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAMFBP/EABYBAQEBAAAAAAAAAAAAAAAAAAQBAv/aAAwDAQACEAMQAAABpZqse6YIBr//xAAaEAACAgMAAAAAAAAAAAAAAAAAAQISAxMx/9oACAEBAAEFAp5Wi9mPkkt5/8QAFxEBAAMAAAAAAAAAAAAAAAAAAAECQf/aAAgBAwEBPwHEVf/EABgRAAIDAAAAAAAAAAAAAAAAAAABEkFh/9oACAECAQE/Aabwkf/EABoQAAICAwAAAAAAAAAAAAAAAAABEBExMlH/2gAIAQEABj8C4bozcKP/xAAbEAEAAwADAQAAAAAAAAAAAAABABEhUWGhwf/aAAgBAQABPyFunzMOj2zix8QChLgDACmGT//aAAwDAQACAAMAAAAQtB//xAAYEQADAQEAAAAAAAAAAAAAAAAAARExYf/aAAgBAwEBPxCJ31EVp//EABgRAQEAAwAAAAAAAAAAAAAAAAEAETFx/9oACAECAQE/EA5kzm6v/8QAHRABAAICAgMAAAAAAAAAAAAAAQARITFBUbHB8P/aAAgBAQABPxBJgU5X5qDtUmLvf2SKBpWKdOoSAJpLmtmAK4gLUBbbXLP/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/f7abe2875ea078ff7e8f6c2905313058/8ac56/database-files.webp 240w,\n/static/f7abe2875ea078ff7e8f6c2905313058/d3be9/database-files.webp 480w,\n/static/f7abe2875ea078ff7e8f6c2905313058/0ba47/database-files.webp 640w\"\n          sizes=\"(max-width: 640px) 100vw, 640px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/f7abe2875ea078ff7e8f6c2905313058/09b79/database-files.jpg 240w,\n/static/f7abe2875ea078ff7e8f6c2905313058/7cc5e/database-files.jpg 480w,\n/static/f7abe2875ea078ff7e8f6c2905313058/c08c5/database-files.jpg 640w\"\n          sizes=\"(max-width: 640px) 100vw, 640px\"\n          type=\"image/jpeg\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/f7abe2875ea078ff7e8f6c2905313058/c08c5/database-files.jpg\"\n          alt=\"Database\"\n          title=\"Database\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n  </a>\n    </span></p>\n<h2 id=\"different-kinds-of-timeouts\" style=\"position:relative;\"><a href=\"#different-kinds-of-timeouts\" aria-label=\"different kinds of timeouts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Different kinds of timeouts</h2>\n<p>Asking a database for results of a query is one of the most common activities a back end application will do. Let us decompose this simple task into steps:</p>\n<ol>\n<li><a href=\"#init\">Establish database connection(s) in pool</a></li>\n<li><a href=\"#pool\">Take the connection out of the pool</a></li>\n<li><a href=\"#validate\">Validate the acquired connection</a></li>\n<li><a href=\"#send\">Send statement(s) to database</a></li>\n<li><a href=\"#read\">Read query results</a></li>\n</ol>\n<p>Each of the above steps can involve a specific timeout configuration. The details depend on particular technology stack and type of database we are querying. </p>\n<h3 id=\"a-nameinitestablish-database-connections-in-poola\" style=\"position:relative;\"><a href=\"#a-nameinitestablish-database-connections-in-poola\" aria-label=\"a nameinitestablish database connections in poola permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a name=\"init\">Establish database connection(s) in pool</a></h3>\n<p>Dealing with raw database connections is almost always done with the help of connection pool. Establishing a connection to database is very expensive compared to running a simple statement. The pool alleviates this cost by reusing connections for as long as needed. </p>\n<p>The first timeout is the maximum duration until a database connection is established. In JDBC this can be controlled by:</p>\n<ul>\n<li>\n<p><code class=\"language-text\">connectTimeout</code> in <a href=\"https://dev.mysql.com/doc/connector-j/5.1/en/connector-j-reference-configuration-properties.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">MySQL JDBC driver</a> </p>\n<blockquote>\n<p>Timeout for socket connect (in milliseconds), with 0 being no timeout. Only works on JDK-1.4 or newer. Defaults to ‘0’.</p>\n</blockquote>\n<p>The default is <strong>infinite ‼️</strong></p>\n</li>\n<li>\n<p><code class=\"language-text\">socketTimeout</code> in <a href=\"https://dev.mysql.com/doc/connector-j/5.1/en/connector-j-reference-configuration-properties.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">MySQL JDBC driver</a> </p>\n<blockquote>\n<p>Timeout (in milliseconds) on network socket operations (0, the default means no timeout).</p>\n</blockquote>\n</li>\n<li>\n<p><code class=\"language-text\">loginTimeout</code> in <a href=\"https://docs.oracle.com/javase/8/docs/api/java/sql/DriverManager.html#setLoginTimeout-int-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">MySQL JDBC driver</a> </p>\n<blockquote>\n<p>Sets the maximum time in seconds that a driver will wait while attempting to connect to a database once the driver has been identified.</p>\n</blockquote>\n<p>The default value 0 means <strong>infinite ‼️</strong></p>\n</li>\n<li>\n<p><code class=\"language-text\">loginTimeout</code> in <a href=\"https://jdbc.postgresql.org/documentation/head/connect.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">PostgreSQL JDBC driver</a>:</p>\n<blockquote>\n<p>Specify how long to wait for establishment of a database connection. The timeout is specified in seconds.</p>\n</blockquote>\n<p><strong>Default is infinite ‼️</strong></p>\n</li>\n<li>\n<p><code class=\"language-text\">connectTimeout</code> in <a href=\"https://jdbc.postgresql.org/documentation/head/connect.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">PostgreSQL JDBC driver</a>:</p>\n<blockquote>\n<p>The timeout value used for socket connect operations. If connecting to the server takes longer than this value, the connection is broken. The timeout is specified in seconds and a value of zero means that it is disabled.</p>\n</blockquote>\n</li>\n<li>\n<p><code class=\"language-text\">socketTimeout</code> in <a href=\"https://jdbc.postgresql.org/documentation/head/connect.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">PostgreSQL JDBC driver</a>:</p>\n<blockquote>\n<p>The timeout value used for socket read operations. If reading from the server takes longer than this value, the connection is closed. This can be used as both a brute force global query timeout and a method of detecting network problems. The timeout is specified in seconds and a value of zero means that it is disabled.</p>\n</blockquote>\n</li>\n</ul>\n<p>You probably have noticed a recurring theme above: <strong>default timeouts are either infinite or disabled at the driver level</strong>. <em>In case of <code class=\"language-text\">socketTimeout</code> and <code class=\"language-text\">connectTimeout</code> there can still be a system level timeout involved both on <a href=\"https://linux.die.net/man/7/socket\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Linux</a> and <a href=\"https://msdn.microsoft.com/en-us/library/windows/desktop/ms740476(v=vs.85).aspx\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Windows</a>. However, those only work on blocking send and receive operations and how the JDBC driver interacts with the socket is an implementation detail for the most part.</em></p>\n<p>In order to demonstrate how the above timeouts work in practice we will use the following test cases:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> JdbcTimeoutTest <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation builtin\">@Test</span>\n    <span class=\"token keyword\">fun</span> `mysql getConnection`<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> mysqlDataSource <span class=\"token operator\">=</span> <span class=\"token function\">mysqlDataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token function\">assertTimeoutPreemptively</span><span class=\"token punctuation\">(</span>Duration<span class=\"token punctuation\">.</span><span class=\"token function\">ofMinutes</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            useResource <span class=\"token punctuation\">{</span> mysqlDataSource<span class=\"token punctuation\">.</span>connection <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation builtin\">@Test</span>\n    <span class=\"token keyword\">fun</span> `postgresql getConnection`<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> mysqlDataSource <span class=\"token operator\">=</span> <span class=\"token function\">postgreSQLDataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token function\">assertTimeoutPreemptively</span><span class=\"token punctuation\">(</span>Duration<span class=\"token punctuation\">.</span><span class=\"token function\">ofMinutes</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            useResource <span class=\"token punctuation\">{</span> mysqlDataSource<span class=\"token punctuation\">.</span>connection <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">useResource</span><span class=\"token punctuation\">(</span>resourceProvider<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> AutoCloseable<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> start <span class=\"token operator\">=</span> Instant<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">resourceProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">use</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Completed in <span class=\"token interpolation\"><span class=\"token delimiter variable\">${</span>Duration<span class=\"token punctuation\">.</span><span class=\"token function\">between</span><span class=\"token punctuation\">(</span>start<span class=\"token punctuation\">,</span> Instant<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token delimiter variable\">}</span></span>\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token operator\">:</span> Exception<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error <span class=\"token interpolation variable\">$e</span> after <span class=\"token interpolation\"><span class=\"token delimiter variable\">${</span>Duration<span class=\"token punctuation\">.</span><span class=\"token function\">between</span><span class=\"token punctuation\">(</span>start<span class=\"token punctuation\">,</span> Instant<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token delimiter variable\">}</span></span>\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">mysqlDataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> MysqlDataSource <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">MysqlDataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setURL</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"jdbc:mysql://localhost:3306/database\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>user <span class=\"token operator\">=</span> <span class=\"token string\">\"user\"</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setPassword</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"password\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">postgreSQLDataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> PGSimpleDataSource <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">PGSimpleDataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>user <span class=\"token operator\">=</span> <span class=\"token string\">\"user\"</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>password <span class=\"token operator\">=</span> <span class=\"token string\">\"password\"</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>databaseName <span class=\"token operator\">=</span> <span class=\"token string\">\"database\"</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>serverName <span class=\"token operator\">=</span> <span class=\"token string\">\"localhost\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>To simulate a misbehaving database server we’ll use <code class=\"language-text\">netcat</code> listening on standard MySQL and PostgreSQL port e.g.:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">nc</span> -k -l <span class=\"token number\">3306</span> <span class=\"token comment\"># listen on MySQL port, PostgreSQL uses 5432 by default</span></code></pre></div>\n<p>Both of the above tests will fail due to <code class=\"language-text\">assertTimeoutPreemptively</code>.</p>\n<p>The most appropriate candidate to use for establishing connection is <code class=\"language-text\">loginTimeout</code>. This works in PostgreSQL but does not with MySQL. Apparently the MySQL JDBC driver in versions 5.1, 6.0 and 8.0 implement the method as <a href=\"https://en.wikipedia.org/wiki/Noop\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Noop</a>. Interestingly it is possible to force MySQL driver to respect the timeout when it is set <strong>globally</strong> through a static method <code class=\"language-text\">java.sql.DriverManager.setLoginTimeout</code>. </p>\n<p>A slightly less correct option is to use <code class=\"language-text\">connectTimeout</code> or <code class=\"language-text\">socketTimeout</code>. The socket level options work oblivious to database protocol hence it is impossible to set the timeout accurately for the whole establish connection operation. Additionally, the <code class=\"language-text\">socketTimeout</code> is applied to socket read operations not only to initial connection handshake. The fake <code class=\"language-text\">netcat</code> server is not suitable for testing the <code class=\"language-text\">connectTimeout</code> however we can use it for <code class=\"language-text\">socketTimeout</code>. The PostgreSQL driver correctly reported error after about 2 seconds after setting <code class=\"language-text\">pgSimpleDataSource.socketTimeout = 2</code>. Unfortunately settings <code class=\"language-text\">socketTimeout</code> in MySQL driver had <strong>no effect</strong> on the <code class=\"language-text\">getConnection</code> behavior. Interestingly no matter what value I’ve set the <code class=\"language-text\">socketTimeout</code> to, the error was thrown after about 26 seconds. I have no idea why it behaves like that 🤔.</p>\n<p><strong>Be aware of the shortcomings of MySQL JDBC Driver.</strong></p>\n<h3 id=\"a-namepooltake-the-connection-out-of-the-poola\" style=\"position:relative;\"><a href=\"#a-namepooltake-the-connection-out-of-the-poola\" aria-label=\"a namepooltake the connection out of the poola permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a name=\"pool\">Take the connection out of the pool</a></h3>\n<p>Reusing database connections gives the application great performance boost. However, writing an efficient and bug free database connection pool is no easy task thus we should all rely on proven solutions. In JVM world there are multiple choices when it comes to JDBC:</p>\n<ul>\n<li><a href=\"https://brettwooldridge.github.io/HikariCP/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Hikari</a> Claims to be the fastest and has limited number of configuration knobs and sane defaults. My favorite by far.</li>\n<li><a href=\"https://commons.apache.org/proper/commons-dbcp/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">DBCP 2</a> A recently resurrected project which has a potential of being applicable to all resources pools with its <code class=\"language-text\">commons-pool2</code> module. </li>\n<li><a href=\"https://tomcat.apache.org/tomcat-8.0-doc/jdbc-pool.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Tomcat JDBC Connection Pool</a> Commonly used with lots of configuration options. Came to be as a replacement of dbcp.</li>\n</ul>\n<p>When there are no connections available in the pool, the code asking for it needs to wait until one is available. The amount of time a thread is blocked waiting for a connection needs to be considered carefully. It is important to note that there are 2 situations we need to consider. The first one is when the pool has reached its maximum size and all connections are being used already. This is when there is very little actual work required to acquire a connection. The second case is when all currently opened connections are in use but the pool is allowed to create a new connection because it is not yet full. Here we need to keep in mind that time to establish a connection to the database may easily be around 200ms hence timeout should not be too short. Below you’ll find how to configure the timeout in the mentioned connection pools:</p>\n<ul>\n<li>\n<p>Hikari: <code class=\"language-text\">connectionTimeout</code></p>\n<blockquote>\n<p>This property controls the maximum number of milliseconds that a client (that’s you) will wait for a connection from the pool. If this time is exceeded without a connection becoming available, a SQLException will be thrown. Lowest acceptable connection timeout is 250 ms. Default: 30000 (30 seconds)</p>\n</blockquote>\n</li>\n<li>\n<p>DBCP: <code class=\"language-text\">maxWaitMillis</code> </p>\n<blockquote>\n<p>The maximum number of milliseconds that the pool will wait (when there are no available connections) for a connection to be returned before throwing an exception, or -1 to wait indefinitely. </p>\n</blockquote>\n<p><strong>Default is infinite ‼️</strong></p>\n</li>\n<li>\n<p>Tomcat: <code class=\"language-text\">maxWait</code></p>\n<blockquote>\n<p>(int) The maximum number of milliseconds that the pool will wait (when there are no available connections) for a connection to be returned before throwing an exception. Default value is 30000 (30 seconds)</p>\n</blockquote>\n</li>\n</ul>\n<p>My rule of thumb is to set this timeout <strong>be under 5 seconds</strong>.</p>\n<h3 id=\"a-namevalidatevalidate-the-acquired-connectiona\" style=\"position:relative;\"><a href=\"#a-namevalidatevalidate-the-acquired-connectiona\" aria-label=\"a namevalidatevalidate the acquired connectiona permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a name=\"validate\">Validate the acquired connection</a></h3>\n<p>A database connection can be opened for several hours or even days. However, because there is network involved there are numerous cases where a socket that is seemingly open on the client side may in fact be part of a broken connection. A well behaving connection pool should avoid handing such connection to an application code. A common strategy to alleviate the problem is to test the connection just before it is taken out of the pool. In the past the test was performed using a simple SQL query e.g. <code class=\"language-text\">SELECT 1</code>. Nowadays there is a <a href=\"https://docs.oracle.com/javase/7/docs/api/java/sql/Connection.html#isValid(int)\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">isValid</code></a> method available on the JDBC <code class=\"language-text\">Connection</code> itself which moves the responsibility to the driver itself:</p>\n<blockquote>\n<p>Returns true if the connection has not been closed and is still valid. The driver shall submit a query on the connection or use some other mechanism that positively verifies the connection is still valid when this method is called.</p>\n</blockquote>\n<ul>\n<li>\n<p>Hikari: <code class=\"language-text\">validationTimeout</code>:</p>\n<blockquote>\n<p>This property controls the maximum amount of time that a connection will be tested for aliveness. This value must be less than the <code class=\"language-text\">connectionTimeout</code>. Lowest acceptable validation timeout is 250 ms. Default: 5000</p>\n</blockquote>\n</li>\n<li>\n<p>DBCP: <code class=\"language-text\">validationQueryTimeout</code>:</p>\n<blockquote>\n<p>The timeout in seconds before connection validation queries fail. If set to a positive value, this value is passed to the driver via the <code class=\"language-text\">setQueryTimeout</code> method of the <code class=\"language-text\">Statement</code> used to execute the validation query.</p>\n</blockquote>\n<p><strong>Default is infinite ‼️</strong></p>\n</li>\n<li>\n<p>Tomcat: <code class=\"language-text\">validationQueryTimeout</code>:</p>\n<blockquote>\n<p>(int) The timeout in seconds before a connection validation queries fail. This works by calling java.sql.Statement.setQueryTimeout(seconds) on the statement that executes the validationQuery. The pool itself doesn’t timeout the query, it is still up to the JDBC driver to enforce query timeouts. A value less than or equal to zero will disable this feature. The default value is -1.</p>\n</blockquote>\n<p><strong>Default is infinite ‼️</strong></p>\n</li>\n</ul>\n<h3 id=\"a-namesendsend-statements-to-databasea-and-a-namereadread-query-resultsa\" style=\"position:relative;\"><a href=\"#a-namesendsend-statements-to-databasea-and-a-namereadread-query-resultsa\" aria-label=\"a namesendsend statements to databasea and a namereadread query resultsa permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a name=\"send\">Send statement(s) to database</a> and <a name=\"read\">read query results</a></h3>\n<p>We have finally arrived at the most common usage. Every query that we send to a database should have a timeout configured either at the statement level or at the transaction level. When it comes to individual statements, there is <a href=\"https://docs.oracle.com/javase/7/docs/api/java/sql/Statement.html#setQueryTimeout(int)\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">setQueryTimeout</code></a> available:</p>\n<blockquote>\n<p>Sets the number of seconds the driver will wait for a Statement object to execute to the given number of seconds. By default there is no limit on the amount of time allowed for a running statement to complete. If the limit is exceeded, an SQLTimeoutException is thrown. A JDBC driver must apply this limit to the execute, executeQuery and executeUpdate methods.</p>\n</blockquote>\n<p>Additionally, it’s up to the driver to decide what the above timeout means exactly:</p>\n<blockquote>\n<p>Note: JDBC driver implementations may also apply this limit to ResultSet methods (consult your driver vendor documentation for details).</p>\n</blockquote>\n<blockquote>\n<p>Note: In the case of Statement batching, it is implementation defined as to whether the time-out is applied to individual SQL commands added via the addBatch method or to the entire batch of SQL commands invoked by the executeBatch method (consult your driver vendor documentation for details).</p>\n</blockquote>\n<p>A time required for a query to complete is very use case dependent thus we should <strong>not expect a sane default</strong> to be there. Instead, we need to ask ourself how long we are willing to wait for a query to complete. It is very easy to forget about this rule hence it is very handy to be able to set this timeout globally:</p>\n<ul>\n<li>\n<p>DBCP: <code class=\"language-text\">defaultQueryTimeout</code></p>\n<blockquote>\n<p>defaultQueryTimeout\tnull\tIf non-null, the value of this Integer property determines the query timeout that will be used for Statements created from connections managed by the pool. null means that the driver default will be used.</p>\n</blockquote>\n</li>\n<li>\n<p>Tomcat: <code class=\"language-text\">queryTimeout</code> available through <a href=\"https://tomcat.apache.org/tomcat-8.0-doc/jdbc-pool.html#JDBC_interceptors\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">QueryTimeoutInterceptor</a></p>\n<blockquote>\n<p>(int as String) The number of seconds to set for the query timeout. A value less than or equal to zero will disable this feature. The default value is 1 seconds.</p>\n</blockquote>\n</li>\n<li>Hikari: Not available but fairly easy to add by wrapping a DataSource e.g.:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> <span class=\"token function\">CustomTimeoutsDataSource</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">val</span> innerDataSource<span class=\"token operator\">:</span> DataSource<span class=\"token punctuation\">,</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> queryTimeoutProperties<span class=\"token operator\">:</span> DataSourceConfiguration<span class=\"token punctuation\">.</span>QueryTimeoutProperties<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> DataSource <span class=\"token keyword\">by</span> innerDataSource <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">getConnection</span><span class=\"token punctuation\">(</span>username<span class=\"token operator\">:</span> String<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> password<span class=\"token operator\">:</span> String<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">configureTimeouts</span><span class=\"token punctuation\">(</span>innerDataSource<span class=\"token punctuation\">.</span><span class=\"token function\">getConnection</span><span class=\"token punctuation\">(</span>username<span class=\"token punctuation\">,</span> password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">getConnection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">configureTimeouts</span><span class=\"token punctuation\">(</span>innerDataSource<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">configureTimeouts</span><span class=\"token punctuation\">(</span>connection<span class=\"token operator\">:</span> Connection<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span>Connection <span class=\"token operator\">=</span> <span class=\"token function\">CustomTimeoutsConnection</span><span class=\"token punctuation\">(</span>connection<span class=\"token punctuation\">,</span> queryTimeoutProperties<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">class</span> <span class=\"token function\">CustomTimeoutsConnection</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">val</span> innerConnection<span class=\"token operator\">:</span> Connection<span class=\"token punctuation\">,</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> queryTimeoutProperties<span class=\"token operator\">:</span> DataSourceConfiguration<span class=\"token punctuation\">.</span>QueryTimeoutProperties<span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">:</span> Connection <span class=\"token keyword\">by</span> innerConnection <span class=\"token punctuation\">{</span>\n\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token operator\">&lt;</span>T <span class=\"token operator\">:</span> Statement<span class=\"token operator\">></span> <span class=\"token function\">configure</span><span class=\"token punctuation\">(</span>prepareStatement<span class=\"token operator\">:</span> T<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> T <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">//0 means no timeout</span>\n            <span class=\"token keyword\">val</span> desiredTimeout <span class=\"token operator\">=</span> queryTimeoutProperties<span class=\"token punctuation\">.</span>statementQueryTimeoutInSeconds <span class=\"token operator\">?:</span> <span class=\"token number\">0</span>\n            prepareStatement<span class=\"token punctuation\">.</span>queryTimeout <span class=\"token operator\">=</span> desiredTimeout\n            LOG<span class=\"token punctuation\">.</span><span class=\"token function\">trace</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Configure timeout {} seconds for statement {}\"</span><span class=\"token punctuation\">,</span> desiredTimeout<span class=\"token punctuation\">,</span> prepareStatement<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span> prepareStatement\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">prepareStatement</span><span class=\"token punctuation\">(</span>sql<span class=\"token operator\">:</span> String<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> autoGeneratedKeys<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">configure</span><span class=\"token punctuation\">(</span>innerConnection<span class=\"token punctuation\">.</span><span class=\"token function\">prepareStatement</span><span class=\"token punctuation\">(</span>sql<span class=\"token punctuation\">,</span> autoGeneratedKeys<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">prepareStatement</span><span class=\"token punctuation\">(</span>sql<span class=\"token operator\">:</span> String<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> resultSetType<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span> resultSetConcurrency<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span> resultSetHoldability<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">configure</span><span class=\"token punctuation\">(</span>innerConnection<span class=\"token punctuation\">.</span><span class=\"token function\">prepareStatement</span><span class=\"token punctuation\">(</span>sql<span class=\"token punctuation\">,</span> resultSetType<span class=\"token punctuation\">,</span> resultSetConcurrency<span class=\"token punctuation\">,</span> resultSetHoldability<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">prepareStatement</span><span class=\"token punctuation\">(</span>sql<span class=\"token operator\">:</span> String<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">configure</span><span class=\"token punctuation\">(</span>innerConnection<span class=\"token punctuation\">.</span><span class=\"token function\">prepareStatement</span><span class=\"token punctuation\">(</span>sql<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">prepareStatement</span><span class=\"token punctuation\">(</span>sql<span class=\"token operator\">:</span> String<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> columnNames<span class=\"token operator\">:</span> Array<span class=\"token operator\">&lt;</span><span class=\"token keyword\">out</span> String<span class=\"token operator\">></span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">configure</span><span class=\"token punctuation\">(</span>innerConnection<span class=\"token punctuation\">.</span><span class=\"token function\">prepareStatement</span><span class=\"token punctuation\">(</span>sql<span class=\"token punctuation\">,</span> columnNames<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">prepareStatement</span><span class=\"token punctuation\">(</span>sql<span class=\"token operator\">:</span> String<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> resultSetType<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span> resultSetConcurrency<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">configure</span><span class=\"token punctuation\">(</span>innerConnection<span class=\"token punctuation\">.</span><span class=\"token function\">prepareStatement</span><span class=\"token punctuation\">(</span>sql<span class=\"token punctuation\">,</span> resultSetType<span class=\"token punctuation\">,</span> resultSetConcurrency<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">prepareStatement</span><span class=\"token punctuation\">(</span>sql<span class=\"token operator\">:</span> String<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> columnIndexes<span class=\"token operator\">:</span> IntArray<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=</span> <span class=\"token function\">configure</span><span class=\"token punctuation\">(</span>innerConnection<span class=\"token punctuation\">.</span><span class=\"token function\">prepareStatement</span><span class=\"token punctuation\">(</span>sql<span class=\"token punctuation\">,</span> columnIndexes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">prepareCall</span><span class=\"token punctuation\">(</span>sql<span class=\"token operator\">:</span> String<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">configure</span><span class=\"token punctuation\">(</span>innerConnection<span class=\"token punctuation\">.</span><span class=\"token function\">prepareCall</span><span class=\"token punctuation\">(</span>sql<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">prepareCall</span><span class=\"token punctuation\">(</span>sql<span class=\"token operator\">:</span> String<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> resultSetType<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span> resultSetConcurrency<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">configure</span><span class=\"token punctuation\">(</span>innerConnection<span class=\"token punctuation\">.</span><span class=\"token function\">prepareCall</span><span class=\"token punctuation\">(</span>sql<span class=\"token punctuation\">,</span> resultSetType<span class=\"token punctuation\">,</span> resultSetConcurrency<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">prepareCall</span><span class=\"token punctuation\">(</span>sql<span class=\"token operator\">:</span> String<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> resultSetType<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span> resultSetConcurrency<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span> resultSetHoldability<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">configure</span><span class=\"token punctuation\">(</span>innerConnection<span class=\"token punctuation\">.</span><span class=\"token function\">prepareCall</span><span class=\"token punctuation\">(</span>sql<span class=\"token punctuation\">,</span> resultSetType<span class=\"token punctuation\">,</span> resultSetConcurrency<span class=\"token punctuation\">,</span> resultSetHoldability<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">createStatement</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">configure</span><span class=\"token punctuation\">(</span>innerConnection<span class=\"token punctuation\">.</span><span class=\"token function\">createStatement</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">createStatement</span><span class=\"token punctuation\">(</span>resultSetType<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span> resultSetConcurrency<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">configure</span><span class=\"token punctuation\">(</span>innerConnection<span class=\"token punctuation\">.</span><span class=\"token function\">createStatement</span><span class=\"token punctuation\">(</span>resultSetType<span class=\"token punctuation\">,</span> resultSetConcurrency<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">createStatement</span><span class=\"token punctuation\">(</span>resultSetType<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span> resultSetConcurrency<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span> resultSetHoldability<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">configure</span><span class=\"token punctuation\">(</span>innerConnection<span class=\"token punctuation\">.</span><span class=\"token function\">createStatement</span><span class=\"token punctuation\">(</span>resultSetType<span class=\"token punctuation\">,</span> resultSetConcurrency<span class=\"token punctuation\">,</span> resultSetHoldability<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> String <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token string\">\"CustomTimeoutsConnection(innerConnection=<span class=\"token interpolation variable\">$innerConnection</span>)\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">companion</span> <span class=\"token keyword\">object</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> LOG <span class=\"token operator\">=</span> LoggerFactory<span class=\"token punctuation\">.</span><span class=\"token function\">getLogger</span><span class=\"token punctuation\">(</span>CustomTimeoutsDataSource<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The JDBC level <code class=\"language-text\">queryTimeout</code> is enforced at the application code side i.e. there’s a code executed after the timeout elapses which stops the query execution. Recent releases of both MySQL and PostgreSQL offer a database server level statement timeout capabilities. </p>\n<ul>\n<li>\n<p>MySQL: <a href=\"https://dev.mysql.com/doc/refman/5.7/en/optimizer-hints.html#optimizer-hints-execution-time\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">MAX_EXECUTION_TIME</code></a></p>\n<blockquote>\n<p>The MAX<em>EXECUTION</em>TIME hint is permitted only for SELECT statements. It places a limit N (a timeout value in milliseconds) on how long a statement is permitted to execute before the server terminates it:</p>\n</blockquote>\n</li>\n<li>\n<p>PostgreSQL: <a href=\"https://www.postgresql.org/docs/9.6/static/runtime-config-client.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">statement_timeout</code></a></p>\n<blockquote>\n<p>Abort any statement that takes more than the specified number of milliseconds, starting from the time the command arrives at the server from the client. If log<em>min</em>error<em>statement is set to ERROR or lower, the statement that timed out will also be logged. A value of zero (the default) turns this off.\nSetting statement</em>timeout in postgresql.conf is not recommended because it would affect all sessions.</p>\n</blockquote>\n</li>\n</ul>\n<p>If you are using a JPA provider like Hibernate, you might be urged to use <a href=\"https://docs.jboss.org/hibernate/entitymanager/3.5/reference/en/html/configuration.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">javax.persistence.query.timeout</code></a>. However, from my experience using Hibernate this timeout, when configured globally, is enforced in some uses cases and completely ignored in others. There were multiple bugs reported related to this feature: <a href=\"https://bugs.eclipse.org/bugs/show_bug.cgi?id=303360\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Bug 303360</a>, <a href=\"https://hibernate.atlassian.net/browse/HHH-9929\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">HHH-9929</a>, <a href=\"https://forum.hibernate.org/viewtopic.php?p=2466990\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">“Query timeout in persistence.xml doesn’t work”</a> and some of them are still not addressed.</p>\n<p>There is no transaction scoped timeout available in JDBC. However, one can still apply the timeout in the application code through e.g. <a href=\"https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/transaction/annotation/Transactional.html#timeout--\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">@Transactional.timeout</code></a>. </p>\n<h3 id=\"keep-all-timeouts-short\" style=\"position:relative;\"><a href=\"#keep-all-timeouts-short\" aria-label=\"keep all timeouts short permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Keep all timeouts short</h3>\n<p>The best timeout is a short one. It is often tempting to increase a query or wait timeout in face of performance or throughput problems. However, doing so will increase the amount of resources blocked on the server and is thus a rarely a good choice. Blocking more and more resources on server e.g. threads, may at some point, cause the entire server to <a href=\"https://en.wikipedia.org/wiki/Thrashing_(computer_science)\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">collapse abruptly</a>. I keep the timeouts as short as possible especially when certain API is called often. If you are looking for a good read on the topic I highly recommend <a href=\"https://pragprog.com/book/mnee/release-it\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Release It!</a> by Michael T. Nygard. This books covers many resiliency related topics including timeouts and provides strategies to avoid increasing them.</p>","fields":{"slug":"/database-timeouts/","tagSlugs":["/tag/database/","/tag/timeout/","/tag/jdbc/","/tag/query/","/tag/transaction/"]},"excerpt":"Last time I have outlined the importance of timeouts. Without a carefully considered timeouts our application can become unresponsive easily. In this post I will focus on configuring various timeouts related to interaction with database. I am going to focus specifically on relational databases. The principles and…","frontmatter":{"date":"2017-10-31T22:14:00.000Z","description":null,"tags":["database","timeout","jdbc","query","transaction"],"title":"Database timeouts","socialImage":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAMFBP/EABYBAQEBAAAAAAAAAAAAAAAAAAQBAv/aAAwDAQACEAMQAAABpZqse6YIBr//xAAaEAACAgMAAAAAAAAAAAAAAAAAAQISAxMx/9oACAEBAAEFAp5Wi9mPkkt5/8QAFxEBAAMAAAAAAAAAAAAAAAAAAAECQf/aAAgBAwEBPwHEVf/EABgRAAIDAAAAAAAAAAAAAAAAAAABEkFh/9oACAECAQE/Aabwkf/EABoQAAICAwAAAAAAAAAAAAAAAAABEBExMlH/2gAIAQEABj8C4bozcKP/xAAbEAEAAwADAQAAAAAAAAAAAAABABEhUWGhwf/aAAgBAQABPyFunzMOj2zix8QChLgDACmGT//aAAwDAQACAAMAAAAQtB//xAAYEQADAQEAAAAAAAAAAAAAAAAAARExYf/aAAgBAwEBPxCJ31EVp//EABgRAQEAAwAAAAAAAAAAAAAAAAEAETFx/9oACAECAQE/EA5kzm6v/8QAHRABAAICAgMAAAAAAAAAAAAAAQARITFBUbHB8P/aAAgBAQABPxBJgU5X5qDtUmLvf2SKBpWKdOoSAJpLmtmAK4gLUBbbXLP/2Q==","aspectRatio":1.92,"src":"/static/f7abe2875ea078ff7e8f6c2905313058/f422e/database-files.jpg","srcSet":"/static/f7abe2875ea078ff7e8f6c2905313058/40426/database-files.jpg 240w,\n/static/f7abe2875ea078ff7e8f6c2905313058/9104c/database-files.jpg 480w,\n/static/f7abe2875ea078ff7e8f6c2905313058/f422e/database-files.jpg 640w","sizes":"(max-width: 640px) 100vw, 640px"}}}}}},"pageContext":{"slug":"/database-timeouts/"}}}