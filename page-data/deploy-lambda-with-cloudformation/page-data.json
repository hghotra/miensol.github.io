{"componentChunkName":"component---src-templates-post-template-tsx","path":"/deploy-lambda-with-cloudformation/","result":{"data":{"markdownRemark":{"id":"f644a938-882e-5d91-9f9f-364d8fbd3803","html":"<p>Serverless deployments are popular these days. With a minimal cost you can have your own code wait and respond to various events. AWS Lambda, Azure Functions are just 2 examples of serverless offering from the biggest cloud providers. For a long time I had thought about them only in the context of ad-hoc setups not suitable for a long term development. This was until I found out that you can, with a little effort, version and deploy the serverless API just as a traditional back-end. In this post I am going to show how to deploy AWS Lambda functions with the help of the tool <a href=\"https://adambar.pl/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Adam</a> created at <a href=\"https://brightinventions.pl/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Bright Inventions</a> called <a href=\"https://github.com/bright/cloudform\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">cloudform</a>.</p>\n<p><img src=\"..//images/lambda/lambda.png\" alt=\"Lambda function\"></p>\n<h2 id=\"step-1-define-a-template\" style=\"position:relative;\"><a href=\"#step-1-define-a-template\" aria-label=\"step 1 define a template permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 1: Define a template</h2>\n<p>Letâ€™s install the <a href=\"https://github.com/bright/cloudform\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">cloudform</a> <code class=\"language-text\">npm i --save-dev cloudform</code> and define a minimal template:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> cloudform<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> Lambda<span class=\"token punctuation\">,</span> <span class=\"token constant\">IAM</span><span class=\"token punctuation\">,</span> Fn <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'cloudform'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> LambdaExecutionRole <span class=\"token operator\">=</span> <span class=\"token string\">'LambdaExecutionRole'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">cloudform</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    Resources<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        HelloWorld<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Lambda<span class=\"token punctuation\">.</span>Function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            Code<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                ZipFile<span class=\"token operator\">:</span> <span class=\"token string\">\"exports.wrtiteToConsole = function (event, context, callback){ console.log('Hello'); callback(null); }\"</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            Handler<span class=\"token operator\">:</span> <span class=\"token string\">\"index.wrtiteToConsole\"</span><span class=\"token punctuation\">,</span>\n            Role<span class=\"token operator\">:</span> Fn<span class=\"token punctuation\">.</span><span class=\"token function\">GetAtt</span><span class=\"token punctuation\">(</span>LambdaExecutionRole<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Arn\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            Runtime<span class=\"token operator\">:</span> <span class=\"token string\">\"nodejs6.10\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span>LambdaExecutionRole<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IAM<span class=\"token punctuation\">.</span>Role</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            AssumeRolePolicyDocument<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                Statement<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n                    Effect<span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n                    Principal<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> Service<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"lambda.amazonaws.com\"</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                    Action<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"sts:AssumeRole\"</span><span class=\"token punctuation\">]</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            Path<span class=\"token operator\">:</span> <span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span>\n            ManagedPolicyArns<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>There are only 2 resources defined in the template.  <code class=\"language-text\">HelloWorld</code> is the AWS Lambda function definition. We have set the <code class=\"language-text\">Runtime</code> property to use <code class=\"language-text\">nodejs6.10</code> hence the <code class=\"language-text\">Code.ZipFile</code> contains a JavaScript code. Despite the name <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-lambda-function-code.html#cfn-lambda-function-code-zipfile\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">ZipFile</code></a> should contain application source code in plain text. Obviously the <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-lambda-function-code.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">ZipFile</code></a> may only be used for the most simple functions. The <code class=\"language-text\">S3Bucket</code> and <code class=\"language-text\">S3Key</code> properties can be used to deploy a more involved function implementation. The <code class=\"language-text\">Handler</code> defines which function from <code class=\"language-text\">Code</code> the Lambda runtime should invoke. In case of <code class=\"language-text\">ZipFile</code> the first part is always <code class=\"language-text\">index</code>. </p>\n<p>The <code class=\"language-text\">Role</code> is a required setting for every AWS Lambda function. It defines what entitlements the code invoked by the Lambda runtime has. In the above template we define a policy which can be assumed by <code class=\"language-text\">lambda.amazonaws.com</code> and references a pre-defined AWS managed policy <a href=\"https://docs.aws.amazon.com/lambda/latest/dg/intro-permission-model.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">AWSLambdaBasicExecutionRole</code></a>. The <code class=\"language-text\">AWSLambdaBasicExecutionRole</code> makes it possible for the Lambda function logs to be pushed to Cloud Watch.</p>\n<h2 id=\"step-2-create-the-aws-lambda-function\" style=\"position:relative;\"><a href=\"#step-2-create-the-aws-lambda-function\" aria-label=\"step 2 create the aws lambda function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 2: Create the AWS Lambda function</h2>\n<p>Deploying our Lambda function using CloudFormation requires a single command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws cloudformation create-stack <span class=\"token punctuation\">\\</span>\n    --capabilities CAPABILITY_IAM <span class=\"token punctuation\">\\</span>\n    --stack-name lambda-example <span class=\"token punctuation\">\\</span>\n    --template-body file://<span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span>node_modules/.bin/cloudform aws-template.ts<span class=\"token punctuation\">)</span></code></pre></div>\n<p>The <code class=\"language-text\">--capabilities CAPABILITY_IAM</code> is required whenever the CloudFormation has to define Roles, Policies or related resources. The <code class=\"language-text\">--template-body file://&lt;(node_modules/.bin/cloudform aws-template.ts)</code> instructs CloudFormation to use a template defined in a file. The <code class=\"language-text\">&lt;(...)</code> is <a href=\"https://superuser.com/questions/1059781/what-exactly-is-in-bash-and-in-zsh\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">bash and zsh way to pass an output of a command</a> to other program as if the output was a file. After waiting a bit for the invocation to complete we will see the following in the AWS Console:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 960px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/db231600f8b624947a1b37ee4784ae95/ca3c3/aws-console.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 78.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAACl0lEQVQ4y4VUW3LbMAzkoXurHqA/vUD75ZkmcWzHSSRZb4miqAcl6rEFqKj1R6blzJoUCILAYmnxfDrj6fiM0/mCXw+PeHh6QikrRHECzw8gK4UkTREniVtLpVBWlZvbrkNZlkilRnX4BvX1C4RSNa7XV4RRBGMM+r6HGQaM4+gw0Nrhz9r8tX347XbTdxAcoKIbm6YB1hXLsmxBewM7Wkx22kBrO62YF2Chn2VZHezIe5sPr4Wqa/jBjTKM0VGgmQI2ukFRSoyDxWxnd2CZgTL08fr8iJOf4vQW4PgaINfG+czjdqngILptXbC26zFNkwtoKdgyLZszYaHsFPF2vFzw/ccBh4uPo58g04Pz231FXWukRLq1FvvQZDMdcWWIn36g8okrguwsPDXikjW4lgZRM6LQxtHDPj0lJGqtkeU5NGXFBPPo2g5N3UKWFSqpoKoaStbQSmMaRirPYrULzt6BqMkhSRUcI8tyiKZpnSz4Y8+Sy95L/QzTuM3czKIoSTqVu1TXDURL2XB07uw+5ml2HP4L3KiaMk7iDHlaoNUtlWy4y5oES6WRHlk63BymIc+L/yDfspOSMpTgSlnoIi8KvJCw397eEWUlejM4gZs7AbvvHSxgJ/TN3t/vEQRvcrkMS+JcP8TNYE6Zz3sbY55n18CJVU5jvbO7gHGSOmGz0718mAa2s40FP37s8eFbGCFMqWx6y7s6eAguqabXwh3jd12RePl7XzM/LKkNGi09gobAa3eOfHhdEHWS+BQdEckfXhjD8zyHIAic2D3vHXEc0YGaAmnqYofOoXVz3+/o3b8OZyv4No6sWkNlhO55cRYp6fLnWdJ7LXF9iXC5xgjJFlGHo7zELc3gJxVuiaTZR5zGKGjvNyOVyhJWZID3AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/db231600f8b624947a1b37ee4784ae95/8ac56/aws-console.webp 240w,\n/static/db231600f8b624947a1b37ee4784ae95/d3be9/aws-console.webp 480w,\n/static/db231600f8b624947a1b37ee4784ae95/e46b2/aws-console.webp 960w,\n/static/db231600f8b624947a1b37ee4784ae95/f992d/aws-console.webp 1440w,\n/static/db231600f8b624947a1b37ee4784ae95/62ac3/aws-console.webp 1850w\"\n          sizes=\"(max-width: 960px) 100vw, 960px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/db231600f8b624947a1b37ee4784ae95/8ff5a/aws-console.png 240w,\n/static/db231600f8b624947a1b37ee4784ae95/e85cb/aws-console.png 480w,\n/static/db231600f8b624947a1b37ee4784ae95/d9199/aws-console.png 960w,\n/static/db231600f8b624947a1b37ee4784ae95/07a9c/aws-console.png 1440w,\n/static/db231600f8b624947a1b37ee4784ae95/ca3c3/aws-console.png 1850w\"\n          sizes=\"(max-width: 960px) 100vw, 960px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/db231600f8b624947a1b37ee4784ae95/d9199/aws-console.png\"\n          alt=\"AWS Lambda Screen\"\n          title=\"AWS Lambda Screen\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n  </a>\n    </span></p>\n<p>It is possible to use the AWS Console editor to test and change the function. However, if we are to treat the serverless approach seriously we should not forget about the standard practices like versioning of our source code.</p>\n<h2 id=\"step-3-update-and-version-aws-lambda-function\" style=\"position:relative;\"><a href=\"#step-3-update-and-version-aws-lambda-function\" aria-label=\"step 3 update and version aws lambda function permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 3: Update and version AWS Lambda function</h2>\n<p>Since we have defined the AWS Lambda function using a cloudform template we can version it as any other code. The whole serverless infrastructure we use and configure is treated as a source code allowing for an easy replication of deployment environments, audit trail and change management. Letâ€™s see how we can use cloudform to add another function that will be called by the first one.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> cloudform<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> Lambda<span class=\"token punctuation\">,</span> <span class=\"token constant\">IAM</span><span class=\"token punctuation\">,</span> Fn <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'cloudform'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> FunctionProperties <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'cloudform/types/lambda/function'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> readFileSync <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'fs'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span>\n    LambdaExecutionRole <span class=\"token operator\">=</span> <span class=\"token string\">'LambdaExecutionRole'</span><span class=\"token punctuation\">,</span>\n    Alice <span class=\"token operator\">=</span> <span class=\"token string\">'Alice'</span><span class=\"token punctuation\">,</span>\n    Bob <span class=\"token operator\">=</span> <span class=\"token string\">'Bob'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">lambdaFunction</span><span class=\"token punctuation\">(</span>\n    <span class=\"token parameter\">functionCode<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n    options<span class=\"token operator\">?</span><span class=\"token operator\">:</span> Partial<span class=\"token operator\">&lt;</span>FunctionProperties<span class=\"token operator\">></span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Lambda<span class=\"token punctuation\">.</span>Function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        Code<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> ZipFile<span class=\"token operator\">:</span> functionCode <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        Handler<span class=\"token operator\">:</span> <span class=\"token string\">\"index.main\"</span><span class=\"token punctuation\">,</span>\n        Role<span class=\"token operator\">:</span> Fn<span class=\"token punctuation\">.</span><span class=\"token function\">GetAtt</span><span class=\"token punctuation\">(</span>LambdaExecutionRole<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Arn\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        Runtime<span class=\"token operator\">:</span> <span class=\"token string\">\"nodejs6.10\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token operator\">...</span>options\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token function\">cloudform</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    Resources<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">[</span>Alice<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token function\">lambdaFunction</span><span class=\"token punctuation\">(</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Alice.js'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n            Environment<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                Variables<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                    BobFunction<span class=\"token operator\">:</span> Fn<span class=\"token punctuation\">.</span><span class=\"token function\">GetAtt</span><span class=\"token punctuation\">(</span>Bob<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Arn\"</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span>Bob<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token function\">lambdaFunction</span><span class=\"token punctuation\">(</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Bob.js'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token operator\">...</span> <span class=\"token comment\">// LambdaExecutionRole see below</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>As you can see above, weâ€™ve extracted a function <code class=\"language-text\">lambdaFunction</code> to simplify Lambda function declaration. Both <code class=\"language-text\">Alice</code> and <code class=\"language-text\">Bob</code> functionâ€™s bodies are defined in separate files. Interestingly  <code class=\"language-text\">Alice</code> function, during the invocation, will have access to <code class=\"language-text\">BobFunction</code> environment variable pointing to <code class=\"language-text\">Bob</code> function <a href=\"https://docs.aws.amazon.com/general/latest/gr/aws-arns-and-namespaces.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ARN</a>.</p>\n<p>Our <code class=\"language-text\">LambdaExecutionRole</code> lacks a permission to invoke another Lambda function. Letâ€™s fix that:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\">    <span class=\"token punctuation\">[</span>LambdaExecutionRole<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IAM<span class=\"token punctuation\">.</span>Role</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        AssumeRolePolicyDocument<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            Statement<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n                Effect<span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n                Principal<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> Service<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"lambda.amazonaws.com\"</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                Action<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"sts:AssumeRole\"</span><span class=\"token punctuation\">]</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        Path<span class=\"token operator\">:</span> <span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span>\n        ManagedPolicyArns<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        Policies<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n            PolicyName<span class=\"token operator\">:</span> <span class=\"token string\">\"AllowCallingOtherLambda\"</span><span class=\"token punctuation\">,</span>\n            PolicyDocument<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                Version<span class=\"token operator\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\n                Statement<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n                    Sid<span class=\"token operator\">:</span> <span class=\"token string\">\"InvokeLambdaPermission\"</span><span class=\"token punctuation\">,</span>\n                    Effect<span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n                    Action<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"lambda:InvokeFunction\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                    Resource<span class=\"token operator\">:</span> <span class=\"token string\">\"*\"</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>The <code class=\"language-text\">Alice</code> and <code class=\"language-text\">Bob</code> sources export <code class=\"language-text\">main</code> functions invoked by AWS Lambda runtime:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// Alice.ts</span>\n<span class=\"token keyword\">import</span> aws <span class=\"token keyword\">from</span> <span class=\"token string\">'aws-sdk'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> context<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> callback<span class=\"token operator\">:</span> <span class=\"token builtin\">Function</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">new</span> <span class=\"token class-name\">aws<span class=\"token punctuation\">.</span>Lambda</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        FunctionName<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span>BobFunction<span class=\"token operator\">!</span><span class=\"token punctuation\">,</span>\n        Payload<span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>message<span class=\"token operator\">:</span> <span class=\"token string\">\"Hi!. I'm Alice.\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error<span class=\"token operator\">:</span> Error<span class=\"token punctuation\">,</span> data<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>Payload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'FromBob'</span><span class=\"token punctuation\">,</span> error <span class=\"token operator\">||</span> response<span class=\"token punctuation\">)</span>\n        <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Bob.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> context<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> callback<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'FromAlice'</span><span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span>\n    <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>message<span class=\"token operator\">:</span> <span class=\"token string\">\"Hi! I'm Bob. Nice to meet you!\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Since we now use TypeScript for <code class=\"language-text\">Alice</code> and <code class=\"language-text\">Bob</code> source we need to install the compiler <code class=\"language-text\">npm i --save-dev typescript @types/node aws-sdk</code>. Unfortunately currently in <a href=\"https://github.com/bright/cloudform\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">cloudform</a> it is not possible to use custom <code class=\"language-text\">tsconfig.json</code> for the compilation. Fortunately we can invoke the compiler manually and use its outputs as any other Node.js source code. With a <code class=\"language-text\">tsconfig.json</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"compilerOptions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"module\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"commonjs\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"target\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"es6\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"strict\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> \n    <span class=\"token property\">\"strictPropertyInitialization\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"esModuleInterop\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"exclude\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"node_modules\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"compileOnSave\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>we can use the following commands to compile and deploy Lambda functions:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">./node_modules/.bin/tsc\n\naws cloudformation update-stack <span class=\"token punctuation\">\\</span>\n    --capabilities CAPABILITY_IAM <span class=\"token punctuation\">\\</span>\n    --stack-name lambda-example <span class=\"token punctuation\">\\</span>\n    --template-body file://<span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span>node -e <span class=\"token string\">\"console.log<span class=\"token variable\"><span class=\"token punctuation\">((</span>require<span class=\"token punctuation\">(</span>'.<span class=\"token operator\">/</span>aws<span class=\"token operator\">-</span>template'<span class=\"token punctuation\">)</span>.default<span class=\"token punctuation\">))</span></span>\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>After the stack update completes we now should have 2 Lambda functions available. When we invoke the <code class=\"language-text\">Alice</code> function, weâ€™ll see that the 2 AWS Lambda functions communicate:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">START RequestId: 6a87c764-251e-11e8-b921-f9ca7649c7d7 Version: $LATEST\n2018-03-11T11:22:00.615Z\t6a87c764-251e-11e8-b921-f9ca7649c7d7\tAlice says: Hi!. I&#39;m Alice.\n2018-03-11T11:22:01.676Z\t6a87c764-251e-11e8-b921-f9ca7649c7d7\tBob says: Hi! I&#39;m Bob. Nice to meet you!\nEND RequestId: 6a87c764-251e-11e8-b921-f9ca7649c7d7\nREPORT RequestId: 6a87c764-251e-11e8-b921-f9ca7649c7d7\tDuration: 1110.68 ms\tBilled Duration: 1200 ms \tMemory Size: 128 MB\tMax Memory Used: 34 MB\t</code></pre></div>\n<p>Serverless infrastructure offers endless possibilities. With <a href=\"https://github.com/bright/cloudform\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">cloudform</a> we can take AWS Lambda development, change management and deployment to the next level.</p>","fields":{"slug":"/deploy-lambda-with-cloudformation/","tagSlugs":["/tag/aws/","/tag/cloudformation/","/tag/lambda/","/tag/cloudform/"]},"excerpt":"Serverless deployments are popular these days. With a minimal cost you can have your own code wait and respond to various events. AWS Lambda, Azure Functions are just 2 examples of serverless offering from the biggest cloud providers. For a long time I had thought about them only in the context of ad-hoc setups notâ€¦","frontmatter":{"date":"2018-03-11T00:00:00.000Z","description":null,"tags":["aws","cloudformation","lambda","cloudform"],"title":"How to deploy Lambda function with CloudFormation?","socialImage":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsSAAALEgHS3X78AAACpklEQVQ4y41Uz2sTQRjdJC1FWts0M5tW8SJ4qVTEm3jyKHoRT4LgSQTFm1iDzU7TtP6g1YvgRf0D9OZREAX1ICIeFD0IitLixbOYZCeb8X0z3+xu/JF04WMmmZ03733vzQYBPzoSIzwumKuh0UpqHcnELEuDcVNH4ZRblwWtqsHQJ84AL5kVaWIl2qgkVrJrVkMCPc3rJTeGgwFzDOtmvWoI1DQssDarluVTe7CqFHQ0E2g1FFAWGHAe87OoE6hnpmlBE8x7qAP8bhGKApN0twaa+32c5EJ221yzsm9xe1i2HAjmpUOSHOX/ZlA/kiUnH/MN9G4yNWdYHz2wVjvBouJZPLDsiKUz55RjKUtbAvMs7ViX05h/4ejEbM6T1BxF5uwYGJ1AXwnxsu+RuM/stDVFWcAuan9mTuW/sQn6cyaOEDMY0sNBlMeEgNmctbw5/wAL/5AqtmH+iSJjpTZ8JhFyJ/8b9mzPzJF/S3V9SdndZCZshHiJ+SPbQyU73MuTeUWDpB5KFEtF9ZZos9gLgIPuSqbmPM5uTjXQjV3MrjmRgdZEEfO3tBFMWo6laHJbxgDyPndzyKh5bw61Lc1lnL/HztWWBY3E6+75aq4VssZfIj5MXuf9Y7EqF7zUIo/7ULGNho2HAAPh7y4fKHejftI6m/NV12dLWftmR4J4PXX4OTe9ZVlEopZnj7zxwfIhrcdkjkvBRdQZ1DvUgge7YN1U4pdruHhB/3fulnO3R3rZR30fUT1iaj91N2wLXtELcySPXuK+tVFz/e2QGXC9Oor5R5bciSnslFOrSia06Q5kfcf4gcdz/Z8okc+rZ7lo1kJDahj4M+oe6hhOnK7oxfI4ahI1YTcuI1eXpyhjKTO6s/hKu5ukwj3o9Rus3UYdRlzG/aG/AScLOvFAMSI+AAAAAElFTkSuQmCC","aspectRatio":0.967741935483871,"src":"/static/54e244bcba02c336b0120b27ecca2cc4/b49f9/lambda.png","srcSet":"/static/54e244bcba02c336b0120b27ecca2cc4/2b087/lambda.png 240w,\n/static/54e244bcba02c336b0120b27ecca2cc4/19ca5/lambda.png 480w,\n/static/54e244bcba02c336b0120b27ecca2cc4/b49f9/lambda.png 619w","sizes":"(max-width: 619px) 100vw, 619px"}}}}}},"pageContext":{"slug":"/deploy-lambda-with-cloudformation/"}}}