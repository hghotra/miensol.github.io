{"componentChunkName":"component---src-templates-post-template-tsx","path":"/how-to-call-a-load-balanced-ecs-service/","result":{"data":{"markdownRemark":{"id":"6b57620b-0aa5-51fa-af0b-a995ec0563d9","html":"<p>A service running <a href=\"https://aws.amazon.com/ecs/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ECS</a> can call plethora of AWS APIs. It can read messages from queues, publish messages to <a href=\"https://aws.amazon.com/sns/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">SNS</a> topics, query a database. These are all valid ways to communicate with the service. However, often the most appropriate way is to call the service by an HTTP API. In this post Iâ€™ll describe how to configure an ECS service running inside VPC so that other services can call its API.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 640px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ec257d456bb857219a90eb6a0e5b6758/c08c5/containers.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAwAE/8QAFQEBAQAAAAAAAAAAAAAAAAAAAQL/2gAMAwEAAhADEAAAAcz50qCil//EABkQAAIDAQAAAAAAAAAAAAAAAAABAhIhMf/aAAgBAQABBQK8UXSG0RWYS7//xAAWEQADAAAAAAAAAAAAAAAAAAAAARL/2gAIAQMBAT8BhEo//8QAFxEAAwEAAAAAAAAAAAAAAAAAAAESAv/aAAgBAgEBPwG9Fs//xAAaEAACAgMAAAAAAAAAAAAAAAAAMQEREBLh/9oACAEBAAY/AkXrFHMIR//EABsQAQACAgMAAAAAAAAAAAAAAAEAIRExQWGB/9oACAEBAAE/IRKK8lIM+WLbwdQDkgxprUQQ/9oADAMBAAIAAwAAABBvD//EABYRAAMAAAAAAAAAAAAAAAAAAAEQUf/aAAgBAwEBPxATV//EABURAQEAAAAAAAAAAAAAAAAAABBh/9oACAECAQE/ELD/AP/EABsQAQADAQADAAAAAAAAAAAAAAEAESFBMWGh/9oACAEBAAE/EE7KcUaS5cgdfWORqpepZ9gCgHhInWjilqLwE//Z'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/ec257d456bb857219a90eb6a0e5b6758/8ac56/containers.webp 240w,\n/static/ec257d456bb857219a90eb6a0e5b6758/d3be9/containers.webp 480w,\n/static/ec257d456bb857219a90eb6a0e5b6758/0ba47/containers.webp 640w\"\n          sizes=\"(max-width: 640px) 100vw, 640px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/ec257d456bb857219a90eb6a0e5b6758/09b79/containers.jpg 240w,\n/static/ec257d456bb857219a90eb6a0e5b6758/7cc5e/containers.jpg 480w,\n/static/ec257d456bb857219a90eb6a0e5b6758/c08c5/containers.jpg 640w\"\n          sizes=\"(max-width: 640px) 100vw, 640px\"\n          type=\"image/jpeg\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/ec257d456bb857219a90eb6a0e5b6758/c08c5/containers.jpg\"\n          alt=\"containers\"\n          title=\"containers\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n  </a>\n    </span></p>\n<h2 id=\"deploy-an-ecs-service-to-multiple-hosts\" style=\"position:relative;\"><a href=\"#deploy-an-ecs-service-to-multiple-hosts\" aria-label=\"deploy an ecs service to multiple hosts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deploy an ECS service to multiple hosts</h2>\n<p>Whenever we care about availability of a service running inside AWS, we need to have it running in at least 2 availability zones. For that reason when defining the ECS Cluster Auto Scaling Group we need to specify at least 2 VPC Subnets running in different availability zones.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"ECSMainCluster\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AWS::ECS::Cluster\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Properties\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"ClusterName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Main Cluster\"</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token property\">\"ECSAutoScalingGroup\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AWS::AutoScaling::AutoScalingGroup\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Properties\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"VPCZoneIdentifier\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"PrivateASubnet\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"PrivateBSubnet\"</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"LaunchConfigurationName\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ContainerHostInstances\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"MinSize\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"MaxSize\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"6\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"DesiredCapacity\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2\"</span>                \n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token property\">\"ServiceA\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AWS::ECS::Service\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Properties\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"Cluster\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ECSMainCluster\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"DesiredCount\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"LoadBalancers\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"ContainerName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"serviceA\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"ContainerPort\"</span><span class=\"token operator\">:</span> <span class=\"token number\">8080</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"TargetGroupArn\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ServiceAAlbTargetGroup\"</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"DeploymentConfiguration\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"MinimumHealthyPercent\"</span><span class=\"token operator\">:</span> <span class=\"token number\">50</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Role\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ECSServiceRole\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"TaskDefinition\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ServiceATask\"</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Notice how we are using 2 private subnets as <code class=\"language-text\">VPCZoneIdentifier</code>. The <code class=\"language-text\">MinSize</code> is also set to 2 which will cause both availability zones to have at least 1 instance running. For brevity subnets and VPC definitions are not included. You can find more details about how to configure the EC2 instances inside ECS cluster <a href=\"/how-to-deploy-a-service-to-amazon-elastic-container-service-with-cloud-formation\">in my previous post</a>.</p>\n<p>The <code class=\"language-text\">ServiceA</code> deployed in <code class=\"language-text\">ECSMainCluster</code> is also specifying that at it has <a href=\"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs_services.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">DesiredCount</code></a> of 2 which instructs ECS to have at least 2 instances of the service running. The <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-service.html#cfn-ecs-service-loadbalancers\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">LoadBalancers</code></a> and <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ecs-service.html#cfn-ecs-service-role\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">Role</code></a> attributes are required for the load balanced setup. The <code class=\"language-text\">ECSServiceRole</code> must allow the ECS agent to make calls to the load balancer API. The <code class=\"language-text\">LoadBalancers</code> reference <a href=\"https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-target-groups.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">an ALB target group</a> to which the running ECS task should be added.</p>\n<h2 id=\"a-private-load-balancer\" style=\"position:relative;\"><a href=\"#a-private-load-balancer\" aria-label=\"a private load balancer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>A private load balancer</h2>\n<p>In order for us to be able to call an API exposed by ECS service running on multiple instances we will use <a href=\"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/service-load-balancing.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">an internal Application Load Balancer</a>. By internal, I mean that the load balancer will not be accessible outside of the VPC.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"PrivateApiLoadBalancer\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AWS::ElasticLoadBalancingV2::LoadBalancer\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Properties\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"Subnets\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"PrivateASubnet\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"PrivateBSubnet\"</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"PrivateApiLoadBalancer\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Scheme\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"internal\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"SecurityGroups\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"HttpHttpsProxySecurityGroup\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token property\">\"HttpHttpsProxySecurityGroup\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AWS::EC2::SecurityGroup\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Properties\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"GroupDescription\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Enable http and https access\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"VpcId\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"VPC\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"SecurityGroupIngress\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"IpProtocol\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"tcp\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"FromPort\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"80\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"ToPort\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"80\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"CidrIp\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"VPCCidr\"</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"IpProtocol\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"tcp\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"FromPort\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"443\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"ToPort\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"443\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"CidrIp\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"VPCCidr\"</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"SecurityGroupEgress\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"IpProtocol\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"-1\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"CidrIp\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"VPCCidr\"</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>There are only 2 important aspects to the <code class=\"language-text\">PrivateApiLoadBalancer</code>. First, it is attached to the same subnets as our ECS task definition. Secondly, it has a security group configured which allows for incoming HTTP/HTTPS traffic and outgoing traffic to any IP in the VPC CIDR address. The egress rule is required for the load balancer to be able to check the health of its targets.</p>\n<p>For the load balancer to perform some actions we need to configure listeners that define its behavior in response to incoming traffic.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"PrivateApiLoadBalancerHttpListener\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AWS::ElasticLoadBalancingV2::Listener\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Properties\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"Port\"</span><span class=\"token operator\">:</span> <span class=\"token number\">80</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Protocol\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"HTTP\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"LoadBalancerArn\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"PrivateApiLoadBalancer\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"DefaultActions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"forward\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"TargetGroupArn\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"PrivateApiLoadBalancerInvalidHostGroup\"</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token property\">\"PrivateApiLoadBalancerInvalidHostGroup\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AWS::ElasticLoadBalancingV2::TargetGroup\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Properties\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"Protocol\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"HTTP\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Port\"</span><span class=\"token operator\">:</span> <span class=\"token number\">80</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"VpcId\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"VPC\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"invalid-target-group\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The <code class=\"language-text\">PrivateApiLoadBalancerHttpListener</code> specifies that the HTTP request to <code class=\"language-text\">PrivateApiLoadBalancer</code> on port 80 should be routed to <code class=\"language-text\">PrivateApiLoadBalancerInvalidHostGroup</code>. The <code class=\"language-text\">AWS::ElasticLoadBalancingV2::Listener</code> requires us to set the <code class=\"language-text\">DefaultActions</code>. The above setup allows us to fail in a consistent manner. Unless there are <code class=\"language-text\">AWS::ElasticLoadBalancingV2::ListenerRule</code> which match an incoming the HTTP request it will be routed to an empty <code class=\"language-text\">AWS::ElasticLoadBalancingV2::TargetGroup</code> which in turn will result in 502 Bad Gateway. This allows us to effectively decouple the <code class=\"language-text\">DefaultActions</code> of the load balancer listener from a specific ECS service instance.</p>\n<h2 id=\"attach-ecs-service-to-an-application-load-balancer\" style=\"position:relative;\"><a href=\"#attach-ecs-service-to-an-application-load-balancer\" aria-label=\"attach ecs service to an application load balancer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Attach ECS service to an Application Load Balancer</h2>\n<p>It is time to route a request from the Application Load Balancer to the ECS service instances. The <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticloadbalancingv2-listenerrule.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">AWS::ElasticLoadBalancingV2::ListenerRule</code></a> allows us to configure such behavior:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"ServiceAAlbHttpListenerRule\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AWS::ElasticLoadBalancingV2::ListenerRule\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Properties\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"Actions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"forward\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"TargetGroupArn\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ServiceAAlbTargetGroup\"</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Priority\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Conditions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"Field\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"host-header\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Values\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"service-a.in.example.com\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"ListenerArn\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"PrivateApiLoadBalancerHttpListener\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token property\">\"ServiceAAlbTargetGroup\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AWS::ElasticLoadBalancingV2::TargetGroup\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Properties\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"Protocol\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"HTTP\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Port\"</span><span class=\"token operator\">:</span> <span class=\"token number\">8080</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"HealthCheckPath\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/application-status/health\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"HealthyThresholdCount\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"UnhealthyThresholdCount\"</span><span class=\"token operator\">:</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"HealthCheckIntervalSeconds\"</span><span class=\"token operator\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"HealthCheckTimeoutSeconds\"</span><span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"VpcId\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"VPC\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"service-a-target-group\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The <code class=\"language-text\">ServiceAAlbHttpListenerRule</code> states that any request with a <code class=\"language-text\">Host</code> equal to <code class=\"language-text\">service-a.in.example.com</code> should be routed to an instance from the <code class=\"language-text\">ServiceAAlbTargetGroup</code>. The <code class=\"language-text\">ServiceAAlbTargetGroup</code> group is referenced from the <code class=\"language-text\">ServiceA</code> definition and contains all running and healthy instances of our task. This means that in order to call the HTTP API exposed by <code class=\"language-text\">ServiceA</code> we will simply use the <code class=\"language-text\">service-a.in.example.com</code> domain name.</p>\n<h2 id=\"a-private-dns-record\" style=\"position:relative;\"><a href=\"#a-private-dns-record\" aria-label=\"a private dns record permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>A private DNS record</h2>\n<p>The last part is to define a <a href=\"https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/hosted-zone-private-creating.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Private Hosted Zone</a> and <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-route53-recordset.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">a DNS Record Set</a> so that a DNS look up, happening inside the VPC, for <code class=\"language-text\">service-a.in.example.com</code> results in an IP address of the <code class=\"language-text\">PrivateApiLoadBalancer</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"PrivateHostedZone\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AWS::Route53::HostedZone\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Properties\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"VPCs\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"VPCId\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"VPC\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"VPCRegion\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AWS::Region\"</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"in.example.com\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n <span class=\"token property\">\"ServiceALoadBalancerDNSRecord\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AWS::Route53::RecordSet\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Properties\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"Name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"service-a.in.example.com\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"HostedZoneId\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"PrivateHostedZone\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"ResourceRecords\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"Fn::GetAtt\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"PrivateApiLoadBalancer\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"DNSName\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"TTL\"</span><span class=\"token operator\">:</span> <span class=\"token number\">60</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"CNAME\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The <code class=\"language-text\">PrivateHostedZone</code> merely defines the name of the domain which we will use for addressing ECS services running inside our VPC. It is recommended to use a domain name that you control so that a mistake in the DNS configuration will not cause your services to call an address that you do not own. The <code class=\"language-text\">ServiceALoadBalancerDNSRecord</code> defines a CNAME that uses <code class=\"language-text\">PrivateApiLoadBalancer</code> AWS assigned DNS name. This way the lookup for <code class=\"language-text\">service-a.in.example.com</code> will effectively resolve to multiple IPs in different availability zones.</p>\n<p>With the above configuration in place we can call an HTTP API exposed privately by a load balanced service running inside VPC on ECS cluster using the most natural way i.e. a DNS name.</p>","fields":{"slug":"/how-to-call-a-load-balanced-ecs-service/","tagSlugs":["/tag/aws/","/tag/ecs/","/tag/cloudformation/","/tag/elb/","/tag/cloudform/"]},"excerpt":"A service running ECS can call plethora of AWS APIs. It can read messages from queues, publish messages to SNS topics, query a database. These are all valid ways to communicate with the service. However, often the most appropriate way is to call the service by an HTTP API. In this post Iâ€™ll describe how to configure anâ€¦","frontmatter":{"date":"2018-03-06T00:00:00.000Z","description":null,"tags":["aws","ecs","cloudformation","elb","cloudform"],"title":"How to call a load balanced ECS service?","socialImage":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAwAE/8QAFQEBAQAAAAAAAAAAAAAAAAAAAQL/2gAMAwEAAhADEAAAAcz50qCil//EABkQAAIDAQAAAAAAAAAAAAAAAAABAhIhMf/aAAgBAQABBQK8UXSG0RWYS7//xAAWEQADAAAAAAAAAAAAAAAAAAAAARL/2gAIAQMBAT8BhEo//8QAFxEAAwEAAAAAAAAAAAAAAAAAAAESAv/aAAgBAgEBPwG9Fs//xAAaEAACAgMAAAAAAAAAAAAAAAAAMQEREBLh/9oACAEBAAY/AkXrFHMIR//EABsQAQACAgMAAAAAAAAAAAAAAAEAIRExQWGB/9oACAEBAAE/IRKK8lIM+WLbwdQDkgxprUQQ/9oADAMBAAIAAwAAABBvD//EABYRAAMAAAAAAAAAAAAAAAAAAAEQUf/aAAgBAwEBPxATV//EABURAQEAAAAAAAAAAAAAAAAAABBh/9oACAECAQE/ELD/AP/EABsQAQADAQADAAAAAAAAAAAAAAEAESFBMWGh/9oACAEBAAE/EE7KcUaS5cgdfWORqpepZ9gCgHhInWjilqLwE//Z","aspectRatio":1.5,"src":"/static/ec257d456bb857219a90eb6a0e5b6758/f422e/containers.jpg","srcSet":"/static/ec257d456bb857219a90eb6a0e5b6758/40426/containers.jpg 240w,\n/static/ec257d456bb857219a90eb6a0e5b6758/9104c/containers.jpg 480w,\n/static/ec257d456bb857219a90eb6a0e5b6758/f422e/containers.jpg 640w","sizes":"(max-width: 640px) 100vw, 640px"}}}}}},"pageContext":{"slug":"/how-to-call-a-load-balanced-ecs-service/"}}}