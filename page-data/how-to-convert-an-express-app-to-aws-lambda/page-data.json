{"componentChunkName":"component---src-templates-post-template-tsx","path":"/how-to-convert-an-express-app-to-aws-lambda/","result":{"data":{"markdownRemark":{"id":"d069bc39-f5a5-53e7-9195-df9f7262479e","html":"<p>In this post we will see how to convert an existing <a href=\"https://expressjs.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">express</a> application to AWS Lambda. This can help reduce AWS bill even by an order of magnitude. We will also use <a href=\"https://github.com/bright/cloudform\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">cloudform</a> to describe the <a href=\"https://aws.amazon.com/cloudformation/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">CloudFormation</a> stack.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 465px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/46bc2ff2509d5263f6fb5067702578ae/51ce3/express-js.webp\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/webp;base64,UklGRkAAAABXRUJQVlA4IDQAAAAQAwCdASoUAAYAPtFUpEuoJKOhsAgBABoJaQAAetHZgAAA/vILBEmvF5np5yiEVejvgAAA'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/46bc2ff2509d5263f6fb5067702578ae/8ac56/express-js.webp 240w,\n/static/46bc2ff2509d5263f6fb5067702578ae/51ce3/express-js.webp 465w\"\n          sizes=\"(max-width: 465px) 100vw, 465px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/46bc2ff2509d5263f6fb5067702578ae/8ac56/express-js.webp 240w,\n/static/46bc2ff2509d5263f6fb5067702578ae/51ce3/express-js.webp 465w\"\n          sizes=\"(max-width: 465px) 100vw, 465px\"\n          type=\"image/webp\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/46bc2ff2509d5263f6fb5067702578ae/51ce3/express-js.webp\"\n          alt=\"lambda\"\n          title=\"lambda\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n  </a>\n    </span></p>\n<h2 id=\"an-express-app\" style=\"position:relative;\"><a href=\"#an-express-app\" aria-label=\"an express app permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>An express app</h2>\n<p>For our example to be complete we need an express application. Let’s use a single <code class=\"language-text\">index.js</code> file to define it:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">apiRoutes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> routes <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">express<span class=\"token punctuation\">.</span>Router</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    routes<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/v1/version'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>version<span class=\"token operator\">:</span> <span class=\"token string\">'1'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    routes<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/v1/echo'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> routes<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token function\">apiRoutes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Listening on 3000</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The above application has only 2 endpoints: </p>\n<ul>\n<li><code class=\"language-text\">GET /v1/version</code> returns API version</li>\n<li><code class=\"language-text\">POST /v1/echo</code> sends back the request body</li>\n</ul>\n<p>We start the application as any other node app with <code class=\"language-text\">node index.js</code>.</p>\n<h2 id=\"convert-the-express-app-to-aws-lambda\" style=\"position:relative;\"><a href=\"#convert-the-express-app-to-aws-lambda\" aria-label=\"convert the express app to aws lambda permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Convert the express app to AWS Lambda</h2>\n<p><a href=\"https://docs.aws.amazon.com/lambda/latest/dg/nodejs-prog-model-handler.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">The AWS Lambda Node.js</a> runtime model differs from a simple <code class=\"language-text\">node fileName.js</code> invocation. For the AWS Lambda to invoke our application code we need to structure it appropriately. Thankfully the <a href=\"https://github.com/awslabs/aws-serverless-express\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">aws-serverless-express</a> module adapts express to AWS Lambda Node.js runtime model.</p>\n<p>Let’s adapt our <code class=\"language-text\">index.js</code> file to support <code class=\"language-text\">aws-serverless-express</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> isInLambda <span class=\"token operator\">=</span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">LAMBDA_TASK_ROOT</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isInLambda<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> serverlessExpress <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'aws-serverless-express'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> serverlessExpress<span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">main</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event<span class=\"token punctuation\">,</span> context</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> serverlessExpress<span class=\"token punctuation\">.</span><span class=\"token function\">proxy</span><span class=\"token punctuation\">(</span>server<span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    app<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Listening on 3000</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The <code class=\"language-text\">main</code> function is called by the AWS Lambda Node.js runtime. Note that we’ve used <a href=\"https://docs.aws.amazon.com/lambda/latest/dg/current-supported-versions.html#lambda-environment-variables\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">LAMBDA_TASK_ROOT</code></a> environment variable to detect if the app is running inside AWS Lambda. It is better to split the express application setup and <code class=\"language-text\">listen</code> call into separate files and use 2 different <em>main</em> files e.g. <code class=\"language-text\">development.js</code> calling <code class=\"language-text\">listen(port)</code> and <code class=\"language-text\">lambda.js</code> using <code class=\"language-text\">aws-serverless-express</code>. However, this would complicate our example unnecessarily.</p>\n<h2 id=\"deploy-the-express-app-to-aws-lambda\" style=\"position:relative;\"><a href=\"#deploy-the-express-app-to-aws-lambda\" aria-label=\"deploy the express app to aws lambda permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deploy the express app to AWS Lambda</h2>\n<p>I already showed <a href=\"/deploy-lambda-with-cloudformation\">how we can deploy lambda with cloudform</a>. We will use the previous example as a base:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> cloudform<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> Lambda<span class=\"token punctuation\">,</span> <span class=\"token constant\">IAM</span><span class=\"token punctuation\">,</span> Fn<span class=\"token punctuation\">,</span> ApiGateway<span class=\"token punctuation\">,</span> Refs<span class=\"token punctuation\">,</span>  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'cloudform'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> FunctionProperties <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'cloudform/types/lambda/function'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> readFileSync <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'fs'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span>\n    LambdaExecutionRole <span class=\"token operator\">=</span> <span class=\"token string\">'LambdaExecutionRole'</span><span class=\"token punctuation\">,</span>\n    ExpressMain <span class=\"token operator\">=</span> <span class=\"token string\">'ExpressMain'</span><span class=\"token punctuation\">,</span>\n    RestApi <span class=\"token operator\">=</span> <span class=\"token string\">'RestApi'</span><span class=\"token punctuation\">,</span>\n    RestApiMainResource <span class=\"token operator\">=</span> <span class=\"token string\">'RestApiMainResource'</span><span class=\"token punctuation\">,</span>\n    PackageKey <span class=\"token operator\">=</span> <span class=\"token string\">'PackageKey'</span><span class=\"token punctuation\">,</span>\n    RestApiDeployment <span class=\"token operator\">=</span> <span class=\"token string\">'RestApiDeployment'</span><span class=\"token punctuation\">,</span>\n    RestApiMethod <span class=\"token operator\">=</span> <span class=\"token string\">'RestApiMethod'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token function\">cloudform</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    Parameters<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        PackageKey<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            Type<span class=\"token operator\">:</span> <span class=\"token string\">'String'</span><span class=\"token punctuation\">,</span>\n            Default<span class=\"token operator\">:</span> <span class=\"token string\">'express-lambda.zip'</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    Resources<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">[</span>ExpressMain<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Lambda<span class=\"token punctuation\">.</span>Function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            Code<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> S3Bucket<span class=\"token operator\">:</span> <span class=\"token string\">'bright-tmp'</span><span class=\"token punctuation\">,</span> S3Key<span class=\"token operator\">:</span> Fn<span class=\"token punctuation\">.</span><span class=\"token function\">Ref</span><span class=\"token punctuation\">(</span>PackageKey<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            Handler<span class=\"token operator\">:</span> <span class=\"token string\">\"index.main\"</span><span class=\"token punctuation\">,</span>\n            Role<span class=\"token operator\">:</span> Fn<span class=\"token punctuation\">.</span><span class=\"token function\">GetAtt</span><span class=\"token punctuation\">(</span>LambdaExecutionRole<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Arn\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            Runtime<span class=\"token operator\">:</span> <span class=\"token string\">\"nodejs6.10\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span>LambdaExecutionRole<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IAM<span class=\"token punctuation\">.</span>Role</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            AssumeRolePolicyDocument<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                Statement<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n                    Effect<span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n                    Principal<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> Service<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"lambda.amazonaws.com\"</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                    Action<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"sts:AssumeRole\"</span><span class=\"token punctuation\">]</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            ManagedPolicyArns<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        PermissionToInvokeLambda<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Lambda<span class=\"token punctuation\">.</span>Permission</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            Action<span class=\"token operator\">:</span> <span class=\"token string\">'lambda:InvokeFunction'</span><span class=\"token punctuation\">,</span>\n            FunctionName<span class=\"token operator\">:</span> Fn<span class=\"token punctuation\">.</span><span class=\"token function\">GetAtt</span><span class=\"token punctuation\">(</span>ExpressMain<span class=\"token punctuation\">,</span> <span class=\"token string\">'Arn'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            Principal<span class=\"token operator\">:</span> <span class=\"token string\">'apigateway.amazonaws.com'</span><span class=\"token punctuation\">,</span>\n            SourceArn<span class=\"token operator\">:</span> Fn<span class=\"token punctuation\">.</span><span class=\"token function\">Join</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token string\">'arn:aws:execute-api:'</span><span class=\"token punctuation\">,</span> Refs<span class=\"token punctuation\">.</span>Region<span class=\"token punctuation\">,</span> <span class=\"token string\">':'</span><span class=\"token punctuation\">,</span> Refs<span class=\"token punctuation\">.</span>AccountId<span class=\"token punctuation\">,</span> <span class=\"token string\">':'</span><span class=\"token punctuation\">,</span> Fn<span class=\"token punctuation\">.</span><span class=\"token function\">Ref</span><span class=\"token punctuation\">(</span>RestApi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'/*'</span><span class=\"token punctuation\">]</span>\n            <span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token operator\">...</span> <span class=\"token comment\">// Rest Api Gateway see below</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>For the AWS Lambda function source we use a zip file hosted in a S3 Bucket named <code class=\"language-text\">packages</code> at key specified in the template parameter <code class=\"language-text\">PackageKey</code>. The package zip file must contain all application source code including <code class=\"language-text\">node_modules</code>. We also define <code class=\"language-text\">PermissionToInvokeLambda</code> so that API Gateway can invoke the lambda function.</p>\n<h2 id=\"add-api-gateway-to-call-aws-lambda\" style=\"position:relative;\"><a href=\"#add-api-gateway-to-call-aws-lambda\" aria-label=\"add api gateway to call aws lambda permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Add API Gateway to call AWS Lambda</h2>\n<p>To be able to invoke the AWS Lambda function using HTTP protocol we will use <a href=\"https://aws.amazon.com/api-gateway/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">API Gateway</a>. There are multiple ways of setting up the API gateway but we will use an appoach that is simplest in my opinion.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token punctuation\">[</span>RestApi<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApiGateway<span class=\"token punctuation\">.</span>RestApi</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> Name<span class=\"token operator\">:</span> <span class=\"token string\">\"Express API\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">[</span>RestApiMainResource<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApiGateway<span class=\"token punctuation\">.</span>Resource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    RestApiId<span class=\"token operator\">:</span> Fn<span class=\"token punctuation\">.</span><span class=\"token function\">Ref</span><span class=\"token punctuation\">(</span>RestApi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    ParentId<span class=\"token operator\">:</span> Fn<span class=\"token punctuation\">.</span><span class=\"token function\">GetAtt</span><span class=\"token punctuation\">(</span>RestApi<span class=\"token punctuation\">,</span> <span class=\"token string\">'RootResourceId'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    PathPart<span class=\"token operator\">:</span> <span class=\"token string\">\"{proxy+}\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">[</span>RestApiMethod<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApiGateway<span class=\"token punctuation\">.</span>Method</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    HttpMethod<span class=\"token operator\">:</span> <span class=\"token string\">'ANY'</span><span class=\"token punctuation\">,</span>\n    ResourceId<span class=\"token operator\">:</span> Fn<span class=\"token punctuation\">.</span><span class=\"token function\">Ref</span><span class=\"token punctuation\">(</span>RestApiMainResource<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    RestApiId<span class=\"token operator\">:</span> Fn<span class=\"token punctuation\">.</span><span class=\"token function\">Ref</span><span class=\"token punctuation\">(</span>RestApi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    AuthorizationType<span class=\"token operator\">:</span> <span class=\"token string\">'NONE'</span><span class=\"token punctuation\">,</span>\n    Integration<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        Type<span class=\"token operator\">:</span> <span class=\"token string\">\"AWS_PROXY\"</span><span class=\"token punctuation\">,</span>\n        IntegrationHttpMethod<span class=\"token operator\">:</span> <span class=\"token string\">\"POST\"</span><span class=\"token punctuation\">,</span>\n        Uri<span class=\"token operator\">:</span> Fn<span class=\"token punctuation\">.</span><span class=\"token function\">Sub</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ExpressMain.Arn}/invocations\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">[</span>RestApiDeployment<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ApiGateway<span class=\"token punctuation\">.</span>Deployment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    RestApiId<span class=\"token operator\">:</span> Fn<span class=\"token punctuation\">.</span><span class=\"token function\">Ref</span><span class=\"token punctuation\">(</span>RestApi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    StageName<span class=\"token operator\">:</span> <span class=\"token string\">'test'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>We first define a <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigateway-restapi.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">RestApi</code></a> which is a collection of resources with various configuration options describing the API. Next is the <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigateway-resource.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">RestApiMainResource</code></a> which depicts a single REST resource. However, in our case we use wildcard <code class=\"language-text\">PathPart</code> to match <strong>all</strong> paths. This way we can have a single resource encompassing all API endpoints. For the <code class=\"language-text\">RestApiMainResource</code> we also need to define a single <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigateway-method.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">RestApiMethod</code></a>. Note that the <code class=\"language-text\">HttpMethod</code> is set to <code class=\"language-text\">ANY</code> which matches all verbs. The <code class=\"language-text\">Integration</code> specifies that we would like to proxy requests to the <code class=\"language-text\">ExpressMain</code> AWS Lambda function. Last but not least we define a <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-apigateway-deployment.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">RestApiDeployment</code></a> so that we have an URL to call the API.</p>\n<p>It is handy to define <code class=\"language-text\">Outputs</code> in our template so that we can easily access the API url:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\">Outputs<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    RestApiUrl<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        Value<span class=\"token operator\">:</span> Fn<span class=\"token punctuation\">.</span><span class=\"token function\">Join</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>Fn<span class=\"token punctuation\">.</span><span class=\"token function\">Ref</span><span class=\"token punctuation\">(</span>RestApi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'.execute-api.'</span><span class=\"token punctuation\">,</span> Refs<span class=\"token punctuation\">.</span>Region<span class=\"token punctuation\">,</span> <span class=\"token string\">'.amazonaws.com/test'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"test-api-gateway-calling-aws-lambda\" style=\"position:relative;\"><a href=\"#test-api-gateway-calling-aws-lambda\" aria-label=\"test api gateway calling aws lambda permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Test API Gateway calling AWS Lambda</h2>\n<p>With our cloudform template deployed with a single command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws cloudformation update-stack <span class=\"token punctuation\">\\</span>\n  --stack-name lambda-example <span class=\"token punctuation\">\\</span>\n  --capabilities CAPABILITY_IAM <span class=\"token punctuation\">\\</span>\n  --template-body file://<span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span>./node_modules/.bin/cloudform aws-template.ts<span class=\"token punctuation\">)</span></code></pre></div>\n<p>We can also fetch the API url:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">API_URL</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>aws cloudformation describe-stacks <span class=\"token punctuation\">\\</span>\n  --stack-name lambda-example <span class=\"token punctuation\">\\</span>\n  --query <span class=\"token string\">'Stacks[0].Outputs[?OutputKey==<span class=\"token variable\"><span class=\"token variable\">`</span>RestApiUrl<span class=\"token variable\">`</span></span>].OutputValue'</span> <span class=\"token punctuation\">\\</span>\n  --output text<span class=\"token variable\">)</span></span></code></pre></div>\n<p>Finally, with the help of <a href=\"https://httpie.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">httpie</code></a> we can test our API:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">></span> http https://<span class=\"token variable\">${API_URL}</span>/v1/version\n\nHTTP/1.1 <span class=\"token number\">200</span> OK\nConnection: keep-alive\nContent-Length: <span class=\"token number\">15</span>\nContent-Type: application/json<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">charset</span><span class=\"token operator\">=</span>utf-8\nDate: Mon, <span class=\"token number\">28</span> May <span class=\"token number\">2018</span> <span class=\"token number\">19</span>:58:13 GMT\nVia: <span class=\"token number\">1.1</span> XXXXXXXXXXXXX.cloudfront.net <span class=\"token punctuation\">(</span>CloudFront<span class=\"token punctuation\">)</span>\nX-Amz-Cf-Id: <span class=\"token assign-left variable\">XXXXXXXXXXXXX</span><span class=\"token operator\">==</span>\nX-Amzn-Trace-Id: <span class=\"token assign-left variable\">Root</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>-5b0c5f54-806e190d437c7d31a4a0d4ba\nX-Cache: Miss from cloudfront\netag: W/<span class=\"token string\">\"f-sHigu4BMVa0IJ0LR3NDJ5y8l4sc\"</span>\nx-amz-apigw-id: HnPVQH4yjoEF8-w<span class=\"token operator\">=</span>\nx-amzn-Remapped-connection: close\nx-amzn-Remapped-content-length: <span class=\"token number\">15</span>\nx-amzn-Remapped-date: Mon, <span class=\"token number\">28</span> May <span class=\"token number\">2018</span> <span class=\"token number\">19</span>:58:13 GMT\nx-amzn-RequestId: 73eff8a6-62b1-11e8-907c-79117668835e\nx-powered-by: Express\n\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"version\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"1\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And a <code class=\"language-text\">POST</code> to the echo endpoint:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">http https://<span class=\"token variable\">${API_URL}</span>/v1/echo <span class=\"token assign-left variable\">message</span><span class=\"token operator\">=</span><span class=\"token string\">\"Hello 👋 My name is Piotr\"</span>\n\nHTTP/1.1 <span class=\"token number\">200</span> OK\nConnection: keep-alive\nContent-Length: <span class=\"token number\">41</span>\nContent-Type: application/json<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">charset</span><span class=\"token operator\">=</span>utf-8\nDate: Mon, <span class=\"token number\">28</span> May <span class=\"token number\">2018</span> <span class=\"token number\">20</span>:00:31 GMT\nVia: <span class=\"token number\">1.1</span> XXXXXXXXXXXXX.cloudfront.net <span class=\"token punctuation\">(</span>CloudFront<span class=\"token punctuation\">)</span>\nX-Amz-Cf-Id: <span class=\"token assign-left variable\">XXXXXXXXXXXXX</span><span class=\"token operator\">==</span>\nX-Amzn-Trace-Id: <span class=\"token assign-left variable\">Root</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>-5b0c5fdf-802178cceb5160684ef2cc34\nX-Cache: Miss from cloudfront\netag: W/<span class=\"token string\">\"29-SKqhJThIfjmVId6IIeTilD7Mkk0\"</span>\nx-amz-apigw-id: <span class=\"token assign-left variable\">HnPq5HeJjoEFuRQ</span><span class=\"token operator\">=</span>\nx-amzn-Remapped-connection: close\nx-amzn-Remapped-content-length: <span class=\"token number\">41</span>\nx-amzn-Remapped-date: Mon, <span class=\"token number\">28</span> May <span class=\"token number\">2018</span> <span class=\"token number\">20</span>:00:31 GMT\nx-amzn-RequestId: c67b41c0-62b1-11e8-a23f-c7cbebde15f2\nx-powered-by: Express\n\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"message\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Hello 👋 My name is Piotr\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"reduced-infrastructure-cost\" style=\"position:relative;\"><a href=\"#reduced-infrastructure-cost\" aria-label=\"reduced infrastructure cost permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reduced infrastructure cost</h2>\n<p>With the above setup we no longer have to pay for an always running EC2 instance. Our monthly bill depends on the number of requests that are executed against the exposed API. More than that, we get much better scalability characteristics, especially when we have nonlinear request rates. </p>","fields":{"slug":"/how-to-convert-an-express-app-to-aws-lambda/","tagSlugs":["/tag/aws/","/tag/cloudformation/","/tag/lambda/","/tag/cloudform/"]},"excerpt":"In this post we will see how to convert an existing express application to AWS Lambda. This can help reduce AWS bill even by an order of magnitude. We will also use cloudform to describe the CloudFormation stack.  An express app For our example to be complete we need an express application. Let’s use a single  file to…","frontmatter":{"date":"2018-05-29T00:00:00.000Z","description":null,"tags":["aws","cloudformation","lambda","cloudform"],"title":"How to convert an express app to AWS Lambda?","socialImage":{"childImageSharp":{"fluid":{"base64":"data:image/webp;base64,UklGRkAAAABXRUJQVlA4IDQAAAAQAwCdASoUAAYAPtFUpEuoJKOhsAgBABoJaQAAetHZgAAA/vILBEmvF5np5yiEVejvgAAA","aspectRatio":3.287671232876712,"src":"/static/46bc2ff2509d5263f6fb5067702578ae/7c7e3/express-js.webp","srcSet":"/static/46bc2ff2509d5263f6fb5067702578ae/9f4ce/express-js.webp 240w,\n/static/46bc2ff2509d5263f6fb5067702578ae/7c7e3/express-js.webp 465w","sizes":"(max-width: 465px) 100vw, 465px"}}}}}},"pageContext":{"slug":"/how-to-convert-an-express-app-to-aws-lambda/"}}}