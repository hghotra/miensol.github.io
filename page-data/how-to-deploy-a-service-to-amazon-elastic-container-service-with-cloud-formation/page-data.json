{"componentChunkName":"component---src-templates-post-template-tsx","path":"/how-to-deploy-a-service-to-amazon-elastic-container-service-with-cloud-formation/","result":{"data":{"markdownRemark":{"id":"6972a319-fc27-5462-8976-ce6014d9768c","html":"<p>Containers are becoming the standard way of deploying software. Every cloud vendor now offers one or multiple ways to run containers on their platform. Most of our clients uses AWS to host their SaaS solution. As part of a new development for one of our clients we have decided to move away from <a href=\"https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/Welcome.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Elastic Beanstalk</a> and embrace containers. Amazon <a href=\"https://aws.amazon.com/ecs/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Elastic Container Service</a> is an orchestration service that supports Docker containers and is generally available for over a year. Given our small development team it seemed like the best choice since it takes away most of the cluster management headaches. In this post I will describe how we deploy a container to ECS using <a href=\"https://aws.amazon.com/cloudformation/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">CloudFormation</a>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 640px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ec257d456bb857219a90eb6a0e5b6758/c08c5/containers.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAwAE/8QAFQEBAQAAAAAAAAAAAAAAAAAAAQL/2gAMAwEAAhADEAAAAcz50qCil//EABkQAAIDAQAAAAAAAAAAAAAAAAABAhIhMf/aAAgBAQABBQK8UXSG0RWYS7//xAAWEQADAAAAAAAAAAAAAAAAAAAAARL/2gAIAQMBAT8BhEo//8QAFxEAAwEAAAAAAAAAAAAAAAAAAAESAv/aAAgBAgEBPwG9Fs//xAAaEAACAgMAAAAAAAAAAAAAAAAAMQEREBLh/9oACAEBAAY/AkXrFHMIR//EABsQAQACAgMAAAAAAAAAAAAAAAEAIRExQWGB/9oACAEBAAE/IRKK8lIM+WLbwdQDkgxprUQQ/9oADAMBAAIAAwAAABBvD//EABYRAAMAAAAAAAAAAAAAAAAAAAEQUf/aAAgBAwEBPxATV//EABURAQEAAAAAAAAAAAAAAAAAABBh/9oACAECAQE/ELD/AP/EABsQAQADAQADAAAAAAAAAAAAAAEAESFBMWGh/9oACAEBAAE/EE7KcUaS5cgdfWORqpepZ9gCgHhInWjilqLwE//Z'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/ec257d456bb857219a90eb6a0e5b6758/8ac56/containers.webp 240w,\n/static/ec257d456bb857219a90eb6a0e5b6758/d3be9/containers.webp 480w,\n/static/ec257d456bb857219a90eb6a0e5b6758/0ba47/containers.webp 640w\"\n          sizes=\"(max-width: 640px) 100vw, 640px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/ec257d456bb857219a90eb6a0e5b6758/09b79/containers.jpg 240w,\n/static/ec257d456bb857219a90eb6a0e5b6758/7cc5e/containers.jpg 480w,\n/static/ec257d456bb857219a90eb6a0e5b6758/c08c5/containers.jpg 640w\"\n          sizes=\"(max-width: 640px) 100vw, 640px\"\n          type=\"image/jpeg\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/ec257d456bb857219a90eb6a0e5b6758/c08c5/containers.jpg\"\n          alt=\"containers\"\n          title=\"containers\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n  </a>\n    </span></p>\n<h2 id=\"ecs-cluster-definition\" style=\"position:relative;\"><a href=\"#ecs-cluster-definition\" aria-label=\"ecs cluster definition permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ECS Cluster definition</h2>\n<p>At <a href=\"https://brightinventions.pl/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Bright Inventions</a> we often use CloudFormation for infrastructure configuration since it allows us to version and track changes easily. The first piece of infrastructure we need is an <a href=\"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ECS_clusters.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ECS cluster</a>. A cluster is a logical group of tasks/containers running inside ECS. In particular, since we will be using <a href=\"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/launch_types.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">EC2 Launch Type</a>, a cluster can also be though of as a group of EC2 instances with an ECS Agent installed.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"ECSMainCluster\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AWS::ECS::Cluster\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Properties\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"ClusterName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"app-stack-main\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token property\">\"ECSAutoScalingGroup\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AWS::AutoScaling::AutoScalingGroup\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Properties\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"VPCZoneIdentifier\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"PrivateASubnet\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"PrivateBSubnet\"</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"LaunchConfigurationName\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ContainerHostInstances\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"MinSize\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"MaxSize\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"6\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"DesiredCapacity\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Tags\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token property\">\"Key\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"Value\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"app-stack-ecs\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"PropagateAtLaunch\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"CreationPolicy\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"ResourceSignal\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"Timeout\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"PT5M\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"UpdatePolicy\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"AutoScalingReplacingUpdate\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"WillReplace\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"true\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>As you can see above, the <code class=\"language-text\">ECSMainCluster</code> is mostly a declaration. What follows is an auto scaling group that will launch and manage EC2 instances. The <code class=\"language-text\">VPCZoneIdentifier</code> lists 2 VPC subnets created in separate availability zones. This is vital for availability as it causes the EC2 instances to run on physically separate hardware. For brevity, I’ve omitted their configuration from this post. However, if you are interested in this topic head over <a href=\"https://sookocheff.com/post/aws/how-to-create-a-vpc-using-cloudformation/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">to this post</a>. The specified <code class=\"language-text\">LaunchConfigurationName</code> named <code class=\"language-text\">ContainerHostInstances</code> details how the EC2 instance should look like.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"ContainerHostInstances\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AWS::AutoScaling::LaunchConfiguration\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Properties\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"ImageId\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ami-880d64f1\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"SecurityGroups\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ECSSecurityGroup\"</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"InstanceType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"t2.medium\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"IamInstanceProfile\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ECSHostEC2InstanceProfile\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"KeyName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"private-key-pair\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"UserData\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"Fn::Base64\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token property\">\"Fn::Join\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n                    <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token punctuation\">[</span>\n                        <span class=\"token string\">\"#!/bin/bash -xe\\n\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string\">\"echo ECS_CLUSTER=\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token punctuation\">{</span>\n                            <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ECSMainCluster\"</span>\n                        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string\">\" >> /etc/ecs/ecs.config\\n\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string\">\"yum install -y aws-cfn-bootstrap\\n\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string\">\"/opt/aws/bin/cfn-signal -e $? \"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string\">\"         --stack \"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token punctuation\">{</span>\n                            <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AWS::StackName\"</span>\n                        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string\">\"         --resource ECSAutoScalingGroup \"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string\">\"         --region \"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token punctuation\">{</span>\n                            <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AWS::Region\"</span>\n                        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string\">\"\\n\"</span>\n                    <span class=\"token punctuation\">]</span>\n                <span class=\"token punctuation\">]</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token property\">\"ECSHostEC2InstanceProfile\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AWS::IAM::InstanceProfile\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Properties\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"Path\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Roles\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ECSHostEC2Role\"</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>The first important property is the <code class=\"language-text\">ImageId</code> which uses <a href=\"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs-optimized_AMI.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Amazon ECS-optimized Linux AMI ID</a>. Next we have a security group that adds rules for incoming traffic on application ports. Next we have <code class=\"language-text\">IamInstanceProfile</code> which references an instance profile <code class=\"language-text\">ECSHostEC2InstanceProfile</code> that in turn <a href=\"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/instance_IAM_role.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">assumes a role policy required by the ECS Agent</a> to deploy and configure containers.\nInside <code class=\"language-text\">UserData</code> we define a shell script that informs ECS Agent about the cluster it is running in. I will omit <code class=\"language-text\">ECSHostEC2Role</code> definition since <a href=\"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/instance_IAM_role.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">it is well described in the documentation</a>.</p>\n<p>With the above we are now ready to deploy an ECS Cluster through CloudFormation template. However, a cluster without containers is pretty meaningless.</p>\n<h2 id=\"ecs-service-and-task-definition\" style=\"position:relative;\"><a href=\"#ecs-service-and-task-definition\" aria-label=\"ecs service and task definition permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ECS Service and Task definition</h2>\n<p>In AWS lingo <a href=\"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs_services.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">an ECS Service</a> describes a minimal configuration required to deploy and run a Task Definition. A <a href=\"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definitions.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Task Definition</a> in turn describes how to configure and run a set of containers that form a single logical component.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"EmailSenderService\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AWS::ECS::Service\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Properties\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"Cluster\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ECSMainCluster\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"DesiredCount\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"DeploymentConfiguration\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"MinimumHealthyPercent\"</span><span class=\"token operator\">:</span> <span class=\"token number\">50</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"Role\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ECSServiceRole\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"TaskDefinition\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"EmailSenderTask\"</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token property\">\"EmailSenderTask\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AWS::ECS::TaskDefinition\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Properties\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"Family\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"app-stack-email-sender\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"ContainerDefinitions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"Name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"app-stack-email-sender\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Essential\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"true\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Image\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"EmailSenderTaskDockerImage\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"LogConfiguration\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token property\">\"LogDriver\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"awslogs\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"Options\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token property\">\"awslogs-group\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"EmailSenderLogsGroup\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token property\">\"awslogs-region\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AWS::Region\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token property\">\"awslogs-stream-prefix\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"email-sender\"</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token property\">\"awslogs-datetime-format\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"%Y-%m-%d %H:%M:%S.%L\"</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"PortMappings\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span> <span class=\"token property\">\"ContainerPort\"</span><span class=\"token operator\">:</span> <span class=\"token number\">8080</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token property\">\"Environment\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n                <span class=\"token property\">\"Name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"DEPLOY_ENV\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token property\">\"Value\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token property\">\"Ref\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"DeployEnv\"</span> <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token property\">\"EmailSenderLogsGroup\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"AWS::Logs::LogGroup\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Properties\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"LogGroupName\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"app-stack-email-sender\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"RetentionInDays\"</span><span class=\"token operator\">:</span> <span class=\"token number\">14</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The <code class=\"language-text\">EmailSenderService</code> is pretty straightforward to understand. The <code class=\"language-text\">EmailSenderTask</code> defines a single container. The <code class=\"language-text\">app-stack-email-sender</code> task definition states that the <code class=\"language-text\">Image</code> is a reference to a parameter passed in to the CloudFormation template when creating or updating the stack. Its value must <a href=\"https://docs.docker.com/engine/reference/commandline/pull/#pull-from-a-different-registry\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">be a name of a Docker image</a> that can be pulled by the ECS Agent. The repository can either be <a href=\"https://hub.docker.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">public</a> or private. When hosting your own, private Docker image repository you need to make sure the ECS Agent <a href=\"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/private-auth.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">has the correct credentials configured</a>. Thankfully there is <a href=\"https://aws.amazon.com/ecr/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Elastic Container Registry</a> which offers private repositories that are automatically configured when using ECS as long as <code class=\"language-text\">ECSHostEC2Role</code> policy <a href=\"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/instance_IAM_role.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">allows ECR related actions</a>.</p>\n<p>Next we have the <code class=\"language-text\">LogConfiguration</code> that pushes containers logs to the <code class=\"language-text\">EmailSenderLogsGroup</code> CloudWatch Log Group so that we can can inspect them through AWS Console. The <code class=\"language-text\">PortMappings</code> lists ports exposed by a running container. Note that we have not defined the host port and it will get assigned automatically. This is important when running multiple instances of the same container. I’ll describe it in a bit more detail in the next post. Last but not least the <code class=\"language-text\">Environment</code> section lists environment variables passed to the container instances on startup. Here we are referencing a <code class=\"language-text\">DeployEnv</code> stack parameter that allows us to inform the application running inside the container about the current deployment environment e.g. staging vs production.</p>\n<p>As you can see above it takes couple of steps to use CloudFormation to deploy a container to ECS. It is true that it requires more configuration than Elastic Beanstalk. However, it allows for better utilization of EC2 instances and an uniform approach to deployment and configuration regardless of the application technology used inside the container. Moreover it is more future proof as with few adjustments it should be possible to switch to <a href=\"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/launch_types.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Fargate Launch Mode</a>. Using this mode releases us from the burden of EC2 ECS cluster management tasks. Deploying more services and tasks will require separate CloudFormation resource definitions. However, with the help of <a href=\"https://brightinventions.pl/blog/introducing-cloudform-tame-aws-cloudformation-templates/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">cloudform</a> it easy keep the CloudFormation template DRY.</p>","fields":{"slug":"/how-to-deploy-a-service-to-amazon-elastic-container-service-with-cloud-formation/","tagSlugs":["/tag/aws/","/tag/ecs/","/tag/cloudformation/","/tag/zuul/"]},"excerpt":"Containers are becoming the standard way of deploying software. Every cloud vendor now offers one or multiple ways to run containers on their platform. Most of our clients uses AWS to host their SaaS solution. As part of a new development for one of our clients we have decided to move away from Elastic Beanstalk and…","frontmatter":{"date":"2018-02-19T00:00:00.000Z","description":null,"tags":["aws","ecs","cloudformation","zuul"],"title":"How to deploy a service to Amazon Elastic Container Service with CloudFormation?","socialImage":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAwAE/8QAFQEBAQAAAAAAAAAAAAAAAAAAAQL/2gAMAwEAAhADEAAAAcz50qCil//EABkQAAIDAQAAAAAAAAAAAAAAAAABAhIhMf/aAAgBAQABBQK8UXSG0RWYS7//xAAWEQADAAAAAAAAAAAAAAAAAAAAARL/2gAIAQMBAT8BhEo//8QAFxEAAwEAAAAAAAAAAAAAAAAAAAESAv/aAAgBAgEBPwG9Fs//xAAaEAACAgMAAAAAAAAAAAAAAAAAMQEREBLh/9oACAEBAAY/AkXrFHMIR//EABsQAQACAgMAAAAAAAAAAAAAAAEAIRExQWGB/9oACAEBAAE/IRKK8lIM+WLbwdQDkgxprUQQ/9oADAMBAAIAAwAAABBvD//EABYRAAMAAAAAAAAAAAAAAAAAAAEQUf/aAAgBAwEBPxATV//EABURAQEAAAAAAAAAAAAAAAAAABBh/9oACAECAQE/ELD/AP/EABsQAQADAQADAAAAAAAAAAAAAAEAESFBMWGh/9oACAEBAAE/EE7KcUaS5cgdfWORqpepZ9gCgHhInWjilqLwE//Z","aspectRatio":1.5,"src":"/static/ec257d456bb857219a90eb6a0e5b6758/f422e/containers.jpg","srcSet":"/static/ec257d456bb857219a90eb6a0e5b6758/40426/containers.jpg 240w,\n/static/ec257d456bb857219a90eb6a0e5b6758/9104c/containers.jpg 480w,\n/static/ec257d456bb857219a90eb6a0e5b6758/f422e/containers.jpg 640w","sizes":"(max-width: 640px) 100vw, 640px"}}}}}},"pageContext":{"slug":"/how-to-deploy-a-service-to-amazon-elastic-container-service-with-cloud-formation/"}}}