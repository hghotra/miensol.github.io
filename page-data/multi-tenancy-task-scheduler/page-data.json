{"componentChunkName":"component---src-templates-post-template-tsx","path":"/multi-tenancy-task-scheduler/","result":{"data":{"markdownRemark":{"id":"abc615be-7865-5ecf-a34e-92c6e7d0b0fe","html":"<p><a href=\"/spring-mvc-multi-tenacy\">Last time I showed</a> how to extend Spring default request handler adapter so that we are able to schedule or reject incoming requests. The goal of the <code class=\"language-text\">TenantTaskCoordinator</code> is to:</p>\n<ul>\n<li>queue requests for processing </li>\n<li>limit the maximum number of concurrently processed requests</li>\n<li>reject requests after the maximum queue size is reached</li>\n<li>interrupt processing of a request upon an upstream subscription disposal</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 640px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/84438e01403d72940530a0f6a1e38c27/c08c5/sorting.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMCBAX/xAAVAQEBAAAAAAAAAAAAAAAAAAACAf/aAAwDAQACEAMQAAABsxQkLUEin//EABoQAAMAAwEAAAAAAAAAAAAAAAECAwAREiH/2gAIAQEAAQUCahFOzieii7cdZMkL/8QAGREAAgMBAAAAAAAAAAAAAAAAAAIBETFB/9oACAEDAQE/AVeuE6f/xAAVEQEBAAAAAAAAAAAAAAAAAAABAP/aAAgBAgEBPwFIv//EABwQAAIBBQEAAAAAAAAAAAAAAAABERASITKBkf/aAAgBAQAGPwJqeGzMj9IudP/EABwQAAMBAAIDAAAAAAAAAAAAAAERIQAxQWFxgf/aAAgBAQABPyECC8NgpUytq8nORM6fMpcqX1lk27//2gAMAwEAAgADAAAAEFsv/8QAFxEBAQEBAAAAAAAAAAAAAAAAAQARIf/aAAgBAwEBPxDR2PUl/8QAFxEAAwEAAAAAAAAAAAAAAAAAAAEhQf/aAAgBAgEBPxB+MSU//8QAGxABAQADAQEBAAAAAAAAAAAAAREAITFBUfD/2gAIAQEAAT8QdvV5JAr5cZZA1umfjLcHQbNeYnbTQ2Py3RlAIXuVIETeXALpkuf/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/84438e01403d72940530a0f6a1e38c27/8ac56/sorting.webp 240w,\n/static/84438e01403d72940530a0f6a1e38c27/d3be9/sorting.webp 480w,\n/static/84438e01403d72940530a0f6a1e38c27/0ba47/sorting.webp 640w\"\n          sizes=\"(max-width: 640px) 100vw, 640px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/84438e01403d72940530a0f6a1e38c27/09b79/sorting.jpg 240w,\n/static/84438e01403d72940530a0f6a1e38c27/7cc5e/sorting.jpg 480w,\n/static/84438e01403d72940530a0f6a1e38c27/c08c5/sorting.jpg 640w\"\n          sizes=\"(max-width: 640px) 100vw, 640px\"\n          type=\"image/jpeg\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/84438e01403d72940530a0f6a1e38c27/c08c5/sorting.jpg\"\n          alt=\"Assigning resources\"\n          title=\"Assigning resources\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n  </a>\n    </span></p>\n<h2 id=\"tenant-task-coordinator-execute-method\" style=\"position:relative;\"><a href=\"#tenant-task-coordinator-execute-method\" aria-label=\"tenant task coordinator execute method permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tenant task coordinator execute method</h2>\n<p>Our entry point into <code class=\"language-text\">TenantTaskCoordinator</code> is a single method <code class=\"language-text\">fun &lt;T : Any&gt; execute(job: Callable&lt;T&gt;): Mono&lt;T&gt;</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\">    <span class=\"token keyword\">fun</span> <span class=\"token operator\">&lt;</span>T <span class=\"token operator\">:</span> Any<span class=\"token operator\">></span> <span class=\"token function\">execute</span><span class=\"token punctuation\">(</span>job<span class=\"token operator\">:</span> Callable<span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Mono<span class=\"token operator\">&lt;</span>T<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> Mono<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> outsideSink <span class=\"token operator\">-></span>\n            <span class=\"token keyword\">val</span> _workInProgressWasDecremented <span class=\"token operator\">=</span> <span class=\"token function\">AtomicBoolean</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">fun</span> <span class=\"token function\">decrementOnce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>_workInProgressWasDecremented<span class=\"token punctuation\">.</span><span class=\"token function\">compareAndSet</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    currentWorkInProgressCounter<span class=\"token punctuation\">.</span><span class=\"token function\">decrementAndGet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">val</span> workInProgress <span class=\"token operator\">=</span> currentWorkInProgressCounter<span class=\"token punctuation\">.</span><span class=\"token function\">incrementAndGet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>workInProgress <span class=\"token operator\">></span> maximumWorkInProgress<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                outsideSink<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token function\">TooManyTasks</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Work in progress <span class=\"token interpolation variable\">$workInProgress</span> exceeds <span class=\"token interpolation variable\">$maximumWorkInProgress</span> jobs in <span class=\"token interpolation variable\">$name</span>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token function\">decrementOnce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">val</span> singleJob <span class=\"token operator\">=</span> Mono<span class=\"token punctuation\">.</span><span class=\"token function\">fromCallable</span><span class=\"token punctuation\">(</span>job<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">doAfterTerminate</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token function\">decrementOnce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span>\n\n                <span class=\"token keyword\">val</span> delayedTask <span class=\"token operator\">=</span> <span class=\"token function\">Task</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> singleJob <span class=\"token keyword\">as</span> Mono<span class=\"token operator\">&lt;</span>Any<span class=\"token operator\">></span><span class=\"token punctuation\">,</span> outsideSink <span class=\"token keyword\">as</span> MonoSink<span class=\"token operator\">&lt;</span>Any<span class=\"token operator\">></span><span class=\"token punctuation\">)</span>\n\n                outsideSink<span class=\"token punctuation\">.</span><span class=\"token function\">onCancel</span> <span class=\"token punctuation\">{</span>\n                    delayedTask<span class=\"token punctuation\">.</span><span class=\"token function\">outsideCancel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token function\">decrementOnce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span>\n                \n                taskSink<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span>delayedTask<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>The first step is to return <code class=\"language-text\">Mono&lt;T&gt;</code> which is simply done with <a href=\"https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Mono.html#create-java.util.function.Consumer-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">Mono.create</code></a>. The <code class=\"language-text\">sink</code> we get passed is used to control the outcome observed from outside. It also allows for registering an <a href=\"https://projectreactor.io/docs/core/release/api/reactor/core/publisher/MonoSink.html#onCancel-reactor.core.Disposable-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">onCancel</code></a> callback invoked when the upstream cancels its subscription. </p>\n<p>The <code class=\"language-text\">_workInProgressWasDecremented</code> is used to guard and decrement the <code class=\"language-text\">currentWorkInProgressCounter</code> in a thread safe fashion. We first check whether we have immediately exceeded the maximum number of queued jobs. If the threshold is reached, we notify the observer about the error with <a href=\"https://projectreactor.io/docs/core/release/api/reactor/core/publisher/MonoSink.html#error-java.lang.Throwable-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">outsideSink.error</code></a>. </p>\n<p>If we have enough capacity to a perform <code class=\"language-text\">job</code>, we convert it to a reactive world with <a href=\"https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Mono.html#fromCallable-java.util.concurrent.Callable-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">Mono.fromCallable</code></a> and attach a <a href=\"https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Mono.html#doAfterTerminate-java.lang.Runnable-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">doAfterTerminate</code></a> callback that decrements the work in progress counter. The <code class=\"language-text\">Task</code> class links <code class=\"language-text\">singleJob</code> and <code class=\"language-text\">outsideSink</code> so that they are both accessible while processing. Finally, we schedule the <code class=\"language-text\">task</code> through <code class=\"language-text\">taskSink.next(delayedTask)</code>.</p>\n<h2 id=\"task-coordinator-state\" style=\"position:relative;\"><a href=\"#task-coordinator-state\" aria-label=\"task coordinator state permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Task coordinator state</h2>\n<p>Let’s have a look at the task coordinator state variables and how they are initialized:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> <span class=\"token function\">TenantTaskCoordinator</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> scheduler<span class=\"token operator\">:</span> Scheduler<span class=\"token punctuation\">,</span>\n                            <span class=\"token keyword\">val</span> maximumConcurrency<span class=\"token operator\">:</span> Int <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n                            <span class=\"token keyword\">val</span> maximumQueueSize<span class=\"token operator\">:</span> Int <span class=\"token operator\">=</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span>\n                            <span class=\"token keyword\">val</span> name<span class=\"token operator\">:</span> String <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> AutoCloseable <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> maximumWorkInProgress <span class=\"token operator\">=</span> maximumQueueSize <span class=\"token operator\">+</span> maximumConcurrency\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> maxBufferSize <span class=\"token operator\">=</span> maximumWorkInProgress <span class=\"token operator\">*</span> <span class=\"token number\">2</span>\n\n    <span class=\"token keyword\">val</span> currentWorkInProgressCounter <span class=\"token operator\">=</span> <span class=\"token function\">AtomicInteger</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">lateinit</span> <span class=\"token keyword\">var</span> taskSink<span class=\"token operator\">:</span> FluxSink<span class=\"token operator\">&lt;</span>Task<span class=\"token operator\">></span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> taskSource <span class=\"token operator\">=</span> Flux<span class=\"token punctuation\">.</span>create<span class=\"token operator\">&lt;</span>Task<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> taskSink <span class=\"token operator\">=</span> it <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> FluxSink<span class=\"token punctuation\">.</span>OverflowStrategy<span class=\"token punctuation\">.</span>BUFFER<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> processSinkOnErrorResume <span class=\"token operator\">=</span> <span class=\"token function\">processSinkWithLimitedConcurrency</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">onErrorResume</span> <span class=\"token punctuation\">{</span> error<span class=\"token operator\">:</span> Throwable<span class=\"token operator\">?</span> <span class=\"token operator\">-></span>\n            LOG<span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"name={} Error processing sink with limited concurrency\"</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span>\n            <span class=\"token function\">processSinkWithLimitedConcurrency</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span></code></pre></div>\n<p>The first interesting part is how we setup <code class=\"language-text\">taskSink</code> by using <a href=\"https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Flux.html#create-java.util.function.Consumer-reactor.core.publisher.FluxSink.OverflowStrategy-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">Flux.create</code></a>. For clarity, we explicitly pass <code class=\"language-text\">FluxSink.OverflowStrategy.BUFFER</code> so that tasks are buffered in case they outpace the processor. The <code class=\"language-text\">name</code> is used to get better log messages. Finally, we call <code class=\"language-text\">processSinkWithLimitedConcurrency</code> to start task processing using the given <code class=\"language-text\">scheduler</code>. Interestingly the <code class=\"language-text\">onErrorResume</code> restarts the processing in case we have a bug.</p>\n<h2 id=\"task-coordinator-concurrent-processing\" style=\"position:relative;\"><a href=\"#task-coordinator-concurrent-processing\" aria-label=\"task coordinator concurrent processing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Task coordinator concurrent processing</h2>\n<p>The most important and tricky to figure out part is to correctly process jobs. It took me several back and forth steps until I got the order of reactive API calls right. </p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\">    <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">processSinkWithLimitedConcurrency</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Flux<span class=\"token operator\">&lt;</span>Any<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> taskSource\n            <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">!</span>it<span class=\"token punctuation\">.</span>isCancelled <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">flatMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> task <span class=\"token operator\">-></span>\n                task<span class=\"token punctuation\">.</span>work\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">doOnError</span><span class=\"token punctuation\">(</span>task<span class=\"token operator\">::</span>onError<span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">doOnSuccess</span><span class=\"token punctuation\">(</span>task<span class=\"token operator\">::</span>onSuccess<span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">subscribeOn</span><span class=\"token punctuation\">(</span>scheduler<span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">timeout</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">.</span>outsideTimeout<span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">onErrorReturn</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> maximumConcurrency<span class=\"token punctuation\">,</span> maxBufferSize<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>First, we filter out tasks that are already cancelled. Then, we use <a href=\"https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Flux.html#flatMap-java.util.function.Function-int-int-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">flatMap</code></a> overload to process tasks with given maximum concurrency. The <code class=\"language-text\">flatMap</code> callback delegates most of the work to the mentioned <code class=\"language-text\">Task</code> instance. The <code class=\"language-text\">onErrorReturn</code> effectively suppresses any errors that might occur during <code class=\"language-text\">task</code> execution. Let’s see how the inner <code class=\"language-text\">Task</code> class looks like:</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">data</span> <span class=\"token keyword\">class</span> <span class=\"token function\">Task</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">val</span> name<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n                            <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> job<span class=\"token operator\">:</span> Mono<span class=\"token operator\">&lt;</span>Any<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n                            <span class=\"token keyword\">val</span> outsideSink<span class=\"token operator\">:</span> MonoSink<span class=\"token operator\">&lt;</span>Any<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n                            <span class=\"token annotation builtin\">@field:Volatile</span> <span class=\"token keyword\">var</span> isCancelled<span class=\"token operator\">:</span> Boolean <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token keyword\">val</span> work<span class=\"token operator\">:</span> Mono<span class=\"token operator\">&lt;</span>Any<span class=\"token operator\">></span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isCancelled<span class=\"token punctuation\">)</span> Mono<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> job\n\n        <span class=\"token keyword\">lateinit</span> <span class=\"token keyword\">var</span> outsideTimeoutSink<span class=\"token operator\">:</span> MonoSink<span class=\"token operator\">&lt;</span>Task<span class=\"token operator\">></span>\n        <span class=\"token keyword\">val</span> outsideTimeout <span class=\"token operator\">=</span> Mono<span class=\"token punctuation\">.</span>create<span class=\"token operator\">&lt;</span>Task<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span> outsideTimeoutSink <span class=\"token operator\">=</span> it <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">fun</span> <span class=\"token function\">outsideCancel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            isCancelled <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n            outsideTimeoutSink<span class=\"token punctuation\">.</span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">fun</span> <span class=\"token function\">onSuccess</span><span class=\"token punctuation\">(</span>result<span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            outsideSink<span class=\"token punctuation\">.</span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token keyword\">fun</span> <span class=\"token function\">onError</span><span class=\"token punctuation\">(</span>error<span class=\"token operator\">:</span> Throwable<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            LOG<span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Task.onError {}\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span>\n            outsideSink<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>The <code class=\"language-text\">job</code> argument is the <code class=\"language-text\">Callable</code> passed to the <code class=\"language-text\">execute</code> method. The <code class=\"language-text\">outsideTimeout</code> signals when the <code class=\"language-text\">task</code> instance subscription is cancelled. The signal is propagated inside <code class=\"language-text\">processSinkWithLimitedConcurrency</code> with a <a href=\"https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Mono.html#timeout-org.reactivestreams.Publisher-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">Mono.timeout</code></a> call and breaks the <code class=\"language-text\">task</code> processing. Last but not least the <code class=\"language-text\">onSuccess</code> and <code class=\"language-text\">onError</code> simply push the result or error to the <code class=\"language-text\">outsideSink</code> effectively notifying the observer of the result. </p>\n<p>The <a href=\"https://gist.github.com/miensol/1e2b203a128cdc428f3b0c598e515bd6\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">TenantTaskCoordinator</code></a> was not simple to figure out given the requirements mentioned at the begging of the post. I’m pleased with the final result although I must say it was not intuitive to figure out how to combine all the nuts and bolts of <a href=\"https://projectreactor.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Reactor</a> library to achieve the desired outcome.</p>","fields":{"slug":"/multi-tenancy-task-scheduler/","tagSlugs":["/tag/spring/","/tag/mvc/","/tag/spring-boot/","/tag/multi-tenant/","/tag/reactive/","/tag/reactor/"]},"excerpt":"Last time I showed how to extend Spring default request handler adapter so that we are able to schedule or reject incoming requests. The goal of the  is to: queue requests for processing  limit the maximum number of concurrently processed requests reject requests after the maximum queue size is reached interrupt…","frontmatter":{"date":"2018-01-04T22:14:00.000Z","description":null,"tags":["spring","mvc","spring boot","multi-tenant","reactive","reactor"],"title":"Multi tenancy task scheduler","socialImage":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMCBAX/xAAVAQEBAAAAAAAAAAAAAAAAAAACAf/aAAwDAQACEAMQAAABsxQkLUEin//EABoQAAMAAwEAAAAAAAAAAAAAAAECAwAREiH/2gAIAQEAAQUCahFOzieii7cdZMkL/8QAGREAAgMBAAAAAAAAAAAAAAAAAAIBETFB/9oACAEDAQE/AVeuE6f/xAAVEQEBAAAAAAAAAAAAAAAAAAABAP/aAAgBAgEBPwFIv//EABwQAAIBBQEAAAAAAAAAAAAAAAABERASITKBkf/aAAgBAQAGPwJqeGzMj9IudP/EABwQAAMBAAIDAAAAAAAAAAAAAAERIQAxQWFxgf/aAAgBAQABPyECC8NgpUytq8nORM6fMpcqX1lk27//2gAMAwEAAgADAAAAEFsv/8QAFxEBAQEBAAAAAAAAAAAAAAAAAQARIf/aAAgBAwEBPxDR2PUl/8QAFxEAAwEAAAAAAAAAAAAAAAAAAAEhQf/aAAgBAgEBPxB+MSU//8QAGxABAQADAQEBAAAAAAAAAAAAAREAITFBUfD/2gAIAQEAAT8QdvV5JAr5cZZA1umfjLcHQbNeYnbTQ2Py3RlAIXuVIETeXALpkuf/2Q==","aspectRatio":1.5,"src":"/static/84438e01403d72940530a0f6a1e38c27/f422e/sorting.jpg","srcSet":"/static/84438e01403d72940530a0f6a1e38c27/40426/sorting.jpg 240w,\n/static/84438e01403d72940530a0f6a1e38c27/9104c/sorting.jpg 480w,\n/static/84438e01403d72940530a0f6a1e38c27/f422e/sorting.jpg 640w","sizes":"(max-width: 640px) 100vw, 640px"}}}}}},"pageContext":{"slug":"/multi-tenancy-task-scheduler/"}}}