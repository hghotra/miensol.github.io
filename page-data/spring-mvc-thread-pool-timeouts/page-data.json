{"componentChunkName":"component---src-templates-post-template-tsx","path":"/spring-mvc-thread-pool-timeouts/","result":{"data":{"markdownRemark":{"id":"699ba7e2-9e74-599d-af8a-49e29da80986","html":"<p>Last time we reviewed <a href=\"/http-client-timeouts\">how to configure HTTP client timeouts</a>. This time let us focus on the other side of the HTTP request i.e. server. There is pretty much always a thread pool involved when we write a Spring MVC application. The thread pool configuration will vary depending on particular servlet container (Tomcat, Undertow, Jetty) so we have to watch out for subtle differences. However, most if not all of them will use a thread pool with fixed maximum size. As we already know, a pool of resources might get exhausted. In particular, a thread pool is more likely to get exhausted if we do not control timeouts diligently.  </p>\n<h2 id=\"threads-involved-in-a-spring-mvc-request-handling\" style=\"position:relative;\"><a href=\"#threads-involved-in-a-spring-mvc-request-handling\" aria-label=\"threads involved in a spring mvc request handling permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Threads involved in a Spring MVC request handling</h2>\n<p>A typical servlet container will use one or more thread pools to handle a request. In particular one of the thread pools is used to execute the Spring MVC part of request handling. Let us call this thread pool the request worker thread pool. The request worker thread pool will have a default maximum size:</p>\n<ul>\n<li>Tomcat: <code class=\"language-text\">server.tomcat.max-threads</code> controlling <a href=\"https://tomcat.apache.org/tomcat-8.5-doc/config/http.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">maxThreads</code></a> with a default of 200</li>\n<li>Undertow: <code class=\"language-text\">server.undertow.worker-threads</code> controlling <a href=\"http://undertow.io/undertow-docs/undertow-docs-1.2.0/listeners.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">WORKER_TASK_CORE_THREADS</code></a> with a default of <a href=\"https://github.com/undertow-io/undertow/blob/b6a87a4b4a467b297363c46747c344faaee15ded/core/src/main/java/io/undertow/Undertow.java#L419\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">availableProcessors() * 8</code></a></li>\n<li>Jetty: There is no Spring configuration property available currently. One can customize the Jetty Thread Pool through code and jetty specific configuration though. The default maximum number of worker threads is 200.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 960px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f95db4989dadc903421245f5abdd40c3/c5fc9/thread-pool.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIEBf/EABYBAQEBAAAAAAAAAAAAAAAAAAEAAv/aAAwDAQACEAMQAAABjaVnN5jk/wD/xAAbEAACAgMBAAAAAAAAAAAAAAABAwACERITIf/aAAgBAQABBQLNAd1TquD1S6jYnJ//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAaEAACAgMAAAAAAAAAAAAAAAAAARAhESKh/9oACAEBAAY/Aha9Hlxdx//EABkQAQADAQEAAAAAAAAAAAAAAAEAESFBMf/aAAgBAQABPyFrNMophcs1saKpW/J1enYBcC5ZLP/aAAwDAQACAAMAAAAQHC//xAAWEQEBAQAAAAAAAAAAAAAAAAAAEQH/2gAIAQMBAT8QmI//xAAWEQEBAQAAAAAAAAAAAAAAAAAAEQH/2gAIAQIBAT8Qq6//xAAaEAEBAAMBAQAAAAAAAAAAAAABEQAhQTFR/9oACAEBAAE/EFZHGkNKvzozDkJYC4zzUw5UpTjJEqB1iqfOut4oOq5//9k='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n        <source\n          srcset=\"/static/f95db4989dadc903421245f5abdd40c3/8ac56/thread-pool.webp 240w,\n/static/f95db4989dadc903421245f5abdd40c3/d3be9/thread-pool.webp 480w,\n/static/f95db4989dadc903421245f5abdd40c3/e46b2/thread-pool.webp 960w,\n/static/f95db4989dadc903421245f5abdd40c3/34186/thread-pool.webp 1118w\"\n          sizes=\"(max-width: 960px) 100vw, 960px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/f95db4989dadc903421245f5abdd40c3/09b79/thread-pool.jpg 240w,\n/static/f95db4989dadc903421245f5abdd40c3/7cc5e/thread-pool.jpg 480w,\n/static/f95db4989dadc903421245f5abdd40c3/6a068/thread-pool.jpg 960w,\n/static/f95db4989dadc903421245f5abdd40c3/c5fc9/thread-pool.jpg 1118w\"\n          sizes=\"(max-width: 960px) 100vw, 960px\"\n          type=\"image/jpeg\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          src=\"/static/f95db4989dadc903421245f5abdd40c3/6a068/thread-pool.jpg\"\n          alt=\"Thread pool\"\n          title=\"Thread pool\"\n          loading=\"lazy\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        />\n      </picture>\n  </a>\n    </span></p>\n<h2 id=\"what-happens-when-the-request-processing-thread-pool-is-empty\" style=\"position:relative;\"><a href=\"#what-happens-when-the-request-processing-thread-pool-is-empty\" aria-label=\"what happens when the request processing thread pool is empty permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What happens when the request processing thread pool is empty?</h2>\n<p> Once the request processing thread pool is empty, the servlet container will typically queue the requests. The queue is processed by the request processing thread pool. Queueing up requests is consuming server memory and sockets thus there typically is a limit after which a new incoming request is going to be immediately rejected.</p>\n<ul>\n<li>Tomcat: <code class=\"language-text\">server.tomcat.accept-count</code> Maximum queue length for incoming connection requests when all possible request processing threads are in use. <a href=\"https://tomcat.apache.org/tomcat-8.5-doc/config/http.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">The default value is 100</a>.</li>\n<li>Undertow: As far as I can tell by default the requests will be queued and the only bound is system capacity. There is <a href=\"http://undertow.io/undertow-docs/undertow-docs-1.2.0/#built-in-handlers\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Request Limiting Handler</a> available though that allows configuring maximum concurrent requests as well as maximum queue size. </li>\n<li>Jetty: By default will queue requests using unbounded queue. You can configure it though <a href=\"https://wiki.eclipse.org/Jetty/Howto/High_Load\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">as documented</a>:</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Configure</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>Server<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>org.eclipse.jetty.server.Server<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Set</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>ThreadPool<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>New</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>org.eclipse.jetty.util.thread.QueuedThreadPool<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n        <span class=\"token comment\">&lt;!-- specify a bounded queue --></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Arg</span><span class=\"token punctuation\">></span></span>\n           <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>New</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>java.util.concurrent.ArrayBlockingQueue<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n              <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Arg</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>int<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>6000<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Arg</span><span class=\"token punctuation\">></span></span>\n           <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>New</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Arg</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Set</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>minThreads<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>10<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Set</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Set</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>maxThreads<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>200<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Set</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Set</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>detailedDump<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>false<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Set</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>New</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Set</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Configure</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Queuing requests is necessary in the most commons scenarios to handle temporary spikes in load. For example, if your application can handle 100 requests per second, and if you can allow it to recover from one minute of excessive high load, you can set the queue capacity to 60*100=6000.</p>\n<h2 id=\"how-is-the-request-processing-thread-pool-related-to-timeouts\" style=\"position:relative;\"><a href=\"#how-is-the-request-processing-thread-pool-related-to-timeouts\" aria-label=\"how is the request processing thread pool related to timeouts permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How is the request processing thread pool related to timeouts?</h2>\n<p>Let us assume that the thread pool (max) size is 100 and that on average a request takes 1 second to process. In such server we can thus handle 100 requests per second (rps). Any requests over the rps limit is going to be queued. Now imagine we have a single type of request that for some reason takes much longer to process than usual e.g. 120 seconds due to some dependent service issue. When such request is processed, it will first block subsequent requesting processing threads until all of them are <em>busy waiting</em>. Depending on the limit of queue size and system capacity our server will soon start rejecting <strong>all new requests</strong>. It is worth noting that the <em>slow</em> requests are also going to be put in queue after thread pool capacity is reached. </p>\n<p>One of the ways to mitigate the issue and speed up system recovery is <strong>to apply timeouts</strong>. When a timeout for a particular request elapses ideally few things should happen:</p>\n<ul>\n<li>the client should be notified about the error (<a href=\"https://en.wikipedia.org/wiki/List_of_HTTP_status_codes\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">503, 504 or 408</a> depending on the use case)</li>\n<li>the request should be removed from the processing queue</li>\n<li>the thread processing the requests should be interrupted </li>\n</ul>\n<p> Let’s review what options are available.</p>\n<ul>\n<li>\n<p>Tomcat has <a href=\"http://tomcat.apache.org/tomcat-8.5-doc/config/valve.html#Stuck_Thread_Detection_Valve\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Stuck Thread Detection Valve</a>:</p>\n<blockquote>\n<p>This valve allows to detect requests that take a long time to process, which might indicate that the thread that is processing it is stuck. Additionally it can optionally interrupt such threads to try and unblock them.\nThe valve has 2 configuration options:</p>\n</blockquote>\n</li>\n<li><code class=\"language-text\">threshold</code>: Minimum duration in seconds after which a thread is considered stuck. Default is 600 seconds. </li>\n<li><code class=\"language-text\">interruptThreadThreshold</code>: Minimum duration in seconds after which a stuck thread should be interrupted to attempt to “free” it.</li>\n</ul>\n<p><em>AFAIK the valve only applies to requests that did start processing by the thread pool.</em></p>\n<ul>\n<li>Undertow and Jetty do not allow for setting a request timeout directly. They both do have <em>idle</em> connection detection and can timeout it accordingly. Unfortunately since HTTP/2 multiplexing the timeouts options may not be suitable to timeout a single request. </li>\n<li>In Spring MVC there is no way to configure a timeout unless you use <a href=\"https://spring.io/guides/gs/async-method/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">async method</a>. With async method one can use <code class=\"language-text\">spring.mvc.async.request-timeout=</code> to set amount of time (in milliseconds) before asynchronous request handling times out. However, using Async Servlet with Spring MVC requires changing the controller methods return types.</li>\n</ul>\n<h2 id=\"there-is-no-standard-request-timeout-configuration\" style=\"position:relative;\"><a href=\"#there-is-no-standard-request-timeout-configuration\" aria-label=\"there is no standard request timeout configuration permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>There is no standard request timeout configuration</h2>\n<p>There are only couple of options available to set encompass request handling with a timeout. This is partially due to historical reasons. The servlet container specification did not consider timeouts until Async Servlet was defined. Another reason is that the there is no way <a href=\"https://docs.oracle.com/javase/1.5.0/docs/guide/misc/threadPrimitiveDeprecation.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">to safely <em>stop</em> a thread</a> that a framework could use. The application code needs to cooperate to safely terminate the request handling execution. In the next post we will show how to add a request timeout to a Spring MVC application.</p>","fields":{"slug":"/spring-mvc-thread-pool-timeouts/","tagSlugs":["/tag/spring/","/tag/mvc/","/tag/spring-boot/","/tag/thread-pool/","/tag/timeout/"]},"excerpt":"Last time we reviewed how to configure HTTP client timeouts. This time let us focus on the other side of the HTTP request i.e. server. There is pretty much always a thread pool involved when we write a Spring MVC application. The thread pool configuration will vary depending on particular servlet container (Tomcat…","frontmatter":{"date":"2017-11-21T22:14:00.000Z","description":null,"tags":["spring","mvc","spring boot","thread-pool","timeout"],"title":"Request timeouts in Spring MVC","socialImage":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIEBf/EABYBAQEBAAAAAAAAAAAAAAAAAAEAAv/aAAwDAQACEAMQAAABjaVnN5jk/wD/xAAbEAACAgMBAAAAAAAAAAAAAAABAwACERITIf/aAAgBAQABBQLNAd1TquD1S6jYnJ//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAaEAACAgMAAAAAAAAAAAAAAAAAARAhESKh/9oACAEBAAY/Aha9Hlxdx//EABkQAQADAQEAAAAAAAAAAAAAAAEAESFBMf/aAAgBAQABPyFrNMophcs1saKpW/J1enYBcC5ZLP/aAAwDAQACAAMAAAAQHC//xAAWEQEBAQAAAAAAAAAAAAAAAAAAEQH/2gAIAQMBAT8QmI//xAAWEQEBAQAAAAAAAAAAAAAAAAAAEQH/2gAIAQIBAT8Qq6//xAAaEAEBAAMBAQAAAAAAAAAAAAABEQAhQTFR/9oACAEBAAE/EFZHGkNKvzozDkJYC4zzUw5UpTjJEqB1iqfOut4oOq5//9k=","aspectRatio":1.5,"src":"/static/f95db4989dadc903421245f5abdd40c3/a6352/thread-pool.jpg","srcSet":"/static/f95db4989dadc903421245f5abdd40c3/40426/thread-pool.jpg 240w,\n/static/f95db4989dadc903421245f5abdd40c3/9104c/thread-pool.jpg 480w,\n/static/f95db4989dadc903421245f5abdd40c3/a6352/thread-pool.jpg 960w,\n/static/f95db4989dadc903421245f5abdd40c3/8e829/thread-pool.jpg 1118w","sizes":"(max-width: 960px) 100vw, 960px"}}}}}},"pageContext":{"slug":"/spring-mvc-thread-pool-timeouts/"}}}