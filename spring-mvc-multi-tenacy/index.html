<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.60c3ca86afa5e5c4da02.css">html{font-size:100}body{margin:0 0 0 calc(100vw - 100%);color:#222;line-height:1.625;font-size:1rem;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}body,h1,h2,h3,h4,h5,h6{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif}h1,h2,h3,h4,h5,h6{font-weight:600}h1{font-size:2.5rem;line-height:3.25rem;margin-top:6.5rem;margin-bottom:1.625rem}h2{font-size:1.6875rem;line-height:2.4375rem}h2,h3{margin-top:3.25rem;margin-bottom:.8125rem}h3{font-size:1.375rem;line-height:1.625rem}h4{font-size:1.2rem;margin-top:2.4375rem}h4,h5{line-height:1.625rem;margin-bottom:.8125rem}h5,h6{font-size:1rem;margin-top:4.0625rem}h6{line-height:1.625rem;margin-bottom:.8125rem}img{max-width:100%;margin:inherit auto}hr,img{border:0;display:block}hr{color:#222;height:1.625rem;margin:3.25rem auto;background-size:100% 26px;background-image:linear-gradient(180deg,transparent 1px,transparent 11px,#222 0,#222 15px,transparent 0,transparent 26px);width:6.25rem}a{color:#5d93ff;text-decoration:none}a:active,a:focus,a:hover{color:#f7a046}b,strong{font-weight:600}ul{list-style:square;margin-bottom:1.625rem}ul li{padding:0 .3125rem;margin-bottom:.625rem}p{line-height:1.625rem;margin-bottom:1.625rem}blockquote{padding:0;text-align:center}figure{display:block;width:100%;height:auto}figcaption{line-height:1.21875rem;margin-top:.40625rem;color:#222;font-size:.875rem;font-style:italic;margin-bottom:0;text-align:center}.anchor{margin-left:-1.875rem!important;padding-right:.875rem!important}@media screen and (min-width:685px){figure.float-left,figure.float-right{max-width:19.375rem;padding:0 1.625rem}.float-right{float:right}.float-left{float:left}}blockquote{background:#ededed;border-left:8px solid #5d93ff;box-shadow:0 3px 15px rgba(0,0,0,.15);color:#222;font-size:1.1em;font-style:italic;font-weight:300;line-height:1.6;margin:0;padding:1.2em;position:relative;vertical-align:super;z-index:0;overflow:hidden;text-align:start}blockquote:before{color:#5d93ff;content:"\201C";font-size:5em;left:0;position:absolute;top:-35px}blockquote p:before{color:#ddd;content:"\201C";font-size:50em;line-height:.65em;right:.095em;position:absolute;z-index:-1}blockquote span{color:#5d93ff;display:block;font-size:1.4em;font-weight:300;letter-spacing:.0625rem;margin-top:.5em}code[class*=language-],pre[class*=language-]{color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#073642}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{color:#657b83;background:#eee8d5}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.Author-module--author__photo--36xCH{display:inline-block;margin-bottom:0;border-radius:50%;background-clip:padding-box}.Author-module--author__title--2CaTb{font-size:1.125rem;font-weight:600;line-height:1.82813rem;margin:.8125rem 0}.Author-module--author__title-link--Yrism{color:#222}.Author-module--author__title-link--Yrism:focus,.Author-module--author__title-link--Yrism:hover{color:#222}.Author-module--author__subtitle--cAaEB{color:#888;line-height:1.625rem;margin-bottom:1.625rem}.Icon-module--icon--Gpyvw{display:inline-block;width:1em;height:1em;stroke-width:0;stroke:currentColor;fill:currentColor;font-style:normal;font-weight:400;speak:none;margin-right:.2em;text-align:center;font-variant:normal;text-transform:none;line-height:1em;margin-left:.2em;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.Contacts-module--contacts--1rGd1{margin-bottom:1.625rem}.Contacts-module--contacts__list--3OgdW{display:flex;flex-flow:row wrap;flex-grow:0;flex-shrink:0;list-style:none;padding:0;margin:.625rem -.1875rem;width:8.75rem}.Contacts-module--contacts__list-item--16p9q{padding:0;margin:.25rem;display:flex;align-content:center;align-items:center;justify-content:center;height:2.1875rem;width:2.1875rem;line-height:2.1875rem;border-radius:50%;text-align:center;border:1px solid #ebebeb}.Contacts-module--contacts__list-item-link--2MIDn{border:0;display:flex;color:#222}.Contacts-module--contacts__list-item-link--2MIDn:focus,.Contacts-module--contacts__list-item-link--2MIDn:hover{color:#5d93ff}.Copyright-module--copyright--1ariN{color:#b6b6b6;font-size:.875rem}.Menu-module--menu--Efbin{margin-bottom:1.625rem}.Menu-module--menu__list--31Zeo{list-style:none;padding:0;margin:0}.Menu-module--menu__list-item--1lJ6B{padding:0;margin:.625rem 0}.Menu-module--menu__list-item-link--10Ush{font-size:1rem;color:#222;font-weight:400;border:0}.Menu-module--menu__list-item-link--10Ush:focus,.Menu-module--menu__list-item-link--10Ush:hover{color:#5d93ff;border-bottom:1px solid #5d93ff}.Menu-module--menu__list-item-link--active--2CbUO{color:#222;border-bottom:1px solid #222}.Sidebar-module--sidebar--X4z2p{width:100%}.Sidebar-module--sidebar__inner--Jdc5s{position:relative;padding:1.5625rem 1.25rem 0}@media screen and (min-width:685px){.Sidebar-module--sidebar--X4z2p{width:calc(41.625% - 1.09375rem)}.Sidebar-module--sidebar--X4z2p:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Sidebar-module--sidebar--X4z2p:last-child{margin-right:0}.Sidebar-module--sidebar--X4z2p:nth-child(12n){margin-right:0;float:right}.Sidebar-module--sidebar--X4z2p:nth-child(12n+1){clear:both}.Sidebar-module--sidebar__inner--Jdc5s{padding:1.875rem 1.25rem 0}.Sidebar-module--sidebar__inner--Jdc5s:after{background:#e6e6e6;background:linear-gradient(180deg,#e6e6e6 0,#e6e6e6 48%,#fff);position:absolute;content:"";width:.0625rem;height:33.75rem;top:30px;right:-10px;bottom:0}}@media screen and (min-width:960px){.Sidebar-module--sidebar--X4z2p{width:calc(33.3% - 1.25rem)}.Sidebar-module--sidebar--X4z2p:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Sidebar-module--sidebar--X4z2p:last-child{margin-right:0}.Sidebar-module--sidebar--X4z2p:nth-child(3n){margin-right:0;float:right}.Sidebar-module--sidebar--X4z2p:nth-child(3n+1){clear:both}.Sidebar-module--sidebar__inner--Jdc5s{padding:2.5rem}}.Layout-module--layout--3Pyz6{max-width:66.875rem;margin-left:auto;margin-right:auto}.Layout-module--layout--3Pyz6:before{content:"";display:table}.Layout-module--layout--3Pyz6:after{content:"";display:table;clear:both}.Feed-module--feed__item--2D5rE{margin-bottom:2.03125rem}.Feed-module--feed__item--2D5rE:last-child{margin-bottom:.8125rem}.Feed-module--feed__item-title--3nigr{font-size:1.6875rem;line-height:2.4375rem;margin-top:0;margin-bottom:.8125rem}.Feed-module--feed__item-title-link--iFMRs{color:#222}.Feed-module--feed__item-title-link--iFMRs:focus,.Feed-module--feed__item-title-link--iFMRs:hover{color:#222;border-bottom:1px solid #222}.Feed-module--feed__item-description--1uO8e{font-size:1rem;line-height:1.625rem;margin-bottom:1.21875rem}.Feed-module--feed__item-meta-time--3t1fg{font-size:.875rem;color:#222;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-divider--N-Q0A{margin:0 .3125rem}.Feed-module--feed__item-meta-category-link--23f8F{font-size:.875rem;color:#f7a046;font-weight:600;text-transform:uppercase}.Feed-module--feed__item-meta-category-link--23f8F:focus,.Feed-module--feed__item-meta-category-link--23f8F:hover{color:#5d93ff}.Feed-module--feed__item-readmore--1u6bI{font-size:1rem;color:#5d93ff}.Feed-module--feed__item-readmore--1u6bI:focus,.Feed-module--feed__item-readmore--1u6bI:hover{color:#5d93ff;border-bottom:1px solid #5d93ff}.Page-module--page--2nMky{margin-bottom:3.25rem}.Page-module--page__inner--2M_vz{padding:1.5625rem 1.25rem}.Page-module--page__title--GPD8L{font-size:2.5rem;font-weight:600;line-height:3.25rem;margin-top:0;margin-bottom:2.35625rem}.Page-module--page__body--Ic6i6{font-size:1rem;line-height:1.625rem;margin:0 0 1.625rem}@media screen and (min-width:685px){.Page-module--page--2nMky{width:calc(58.275% - .78125rem)}.Page-module--page--2nMky:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Page-module--page--2nMky:last-child{margin-right:0}.Page-module--page--2nMky:nth-child(12n){margin-right:0;float:right}.Page-module--page--2nMky:nth-child(12n+1){clear:both}.Page-module--page__inner--2M_vz{padding:1.875rem 1.25rem}}@media screen and (min-width:960px){.Page-module--page--2nMky{width:calc(66.6% - .625rem)}.Page-module--page--2nMky:nth-child(1n){float:left;margin-right:1.875rem;clear:none}.Page-module--page--2nMky:last-child{margin-right:0}.Page-module--page--2nMky:nth-child(3n){margin-right:0;float:right}.Page-module--page--2nMky:nth-child(3n+1){clear:both}.Page-module--page__inner--2M_vz{padding:2.5rem 2.1875rem}}.Pagination-module--pagination--2H3nO{margin-top:3.25rem;display:flex}.Pagination-module--pagination__prev--bet5s{width:50%;text-align:left}.Pagination-module--pagination__prev-link--1Nzs6{color:#f7a046;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__prev-link--1Nzs6:focus,.Pagination-module--pagination__prev-link--1Nzs6:hover{color:#5d93ff}.Pagination-module--pagination__prev-link--disable--Yklx9{pointer-events:none;color:#bbb}.Pagination-module--pagination__next--3hFiN{width:50%;text-align:right}.Pagination-module--pagination__next-link--3FUtA{color:#f7a046;font-size:1.625rem;font-weight:700}.Pagination-module--pagination__next-link--3FUtA:focus,.Pagination-module--pagination__next-link--3FUtA:hover{color:#5d93ff}.Pagination-module--pagination__next-link--disable--30UwZ{pointer-events:none;color:#bbb}.Author-module--author--2Yefr{border-top:1px solid #e6e6e6;max-width:40rem;padding-top:1.25rem;line-height:1.625rem;margin-top:1.625rem;margin-bottom:3.25rem}.Author-module--author__bio-contact--8_j8F{display:block;text-decoration:underline}@media screen and (min-width:685px){.Author-module--author--2Yefr{margin-left:auto;margin-right:auto}}.Content-module--content--3p512{max-width:59.0625rem;padding:0 .9375rem;margin:0 auto}.Content-module--content__title--2BDW9{font-size:2rem;max-width:40rem;font-weight:600;text-align:center;line-height:2.68125rem;margin:1.625rem auto 0}.Content-module--content__body--2TrQ- figure{margin-bottom:1.625rem}.Content-module--content__body--2TrQ- figure blockquote{font-style:italic;text-align:center;margin-top:0;padding:1.625rem 0}.Content-module--content__body--2TrQ- figure blockquote p{max-width:40rem;font-size:1.6817rem;margin-top:0;margin-bottom:1.625rem;line-height:2.4375rem}.Content-module--content__body--2TrQ- a{text-decoration:underline}.Content-module--content__body--2TrQ- *{max-width:40rem;margin-left:auto;margin-right:auto}.Content-module--content__body--2TrQ- img{max-width:100%}@media screen and (min-width:960px){.Content-module--content--3p512{padding:0}.Content-module--content__title--2BDW9{font-size:3rem;line-height:3.65625rem;margin-top:3.65625rem;margin-bottom:2.4375rem}.Content-module--content__body--2TrQ-,.Content-module--content__body--2TrQ- p{font-size:1.125rem;line-height:1.82813rem;margin-bottom:1.82813rem}}.Meta-module--meta__date--29eD7{font-style:italic}.Tags-module--tags--1L_ct{margin-bottom:.8125rem}.Tags-module--tags__list--91FqN{list-style:none;margin:0 -.625rem;padding:0}.Tags-module--tags__list-item--1M30P{display:inline-block;margin:.625rem .3125rem}.Tags-module--tags__list-item-link--3SL_8{display:inline-block;height:2.1875rem;padding:0 1.5rem;line-height:2.1875rem;border:1px solid #e6e6e6;text-decoration:none;border-radius:1.25rem;color:#222}.Tags-module--tags__list-item-link--3SL_8:focus,.Tags-module--tags__list-item-link--3SL_8:hover{color:#5d93ff}.Post-module--post__comments--25y6I,.Post-module--post__footer--3WzWU{max-width:40rem;margin:0 auto;padding:0 .9375rem}.Post-module--post__home-button--16Kl0{display:block;max-width:5.625rem;height:2.1875rem;padding:0 1.5rem;line-height:2.1875rem;text-align:center;color:#222;border:1px solid #e6e6e6;border-radius:1.25rem;font-size:1rem;font-weight:400;margin-left:auto;margin-right:auto;margin-top:1.625rem}.Post-module--post__home-button--16Kl0:focus,.Post-module--post__home-button--16Kl0:hover{color:#5d93ff}@media screen and (min-width:960px){.Post-module--post__comments--25y6I,.Post-module--post__footer--3WzWU{padding:0}.Post-module--post__home-button--16Kl0{position:fixed;max-width:auto;margin:0;top:30px;left:30px}}</style><meta name="generator" content="Gatsby 2.21.9"/><link rel="alternate" type="application/rss+xml" title="Piotr Mionskowski" href="/feed.xml"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-49294874-1"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-49294874-1', {"send_page_view":false});
      }
      </script><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link rel="icon" href="/favicon-32x32.png?v=6c7ff033d8d3a409da0f2d709d5b2f23"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#F7A046"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=6c7ff033d8d3a409da0f2d709d5b2f23"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=6c7ff033d8d3a409da0f2d709d5b2f23"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=6c7ff033d8d3a409da0f2d709d5b2f23"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=6c7ff033d8d3a409da0f2d709d5b2f23"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=6c7ff033d8d3a409da0f2d709d5b2f23"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=6c7ff033d8d3a409da0f2d709d5b2f23"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=6c7ff033d8d3a409da0f2d709d5b2f23"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=6c7ff033d8d3a409da0f2d709d5b2f23"/><title data-react-helmet="true">Multi tenancy in Spring MVC - Piotr Mionskowski</title><meta data-react-helmet="true" name="description" content="One of our clients aimed to replace old, often DOS based, point of sale systems with a cloud based, SaaS modeled solution. At Bright Inventions we have developed all required components including AWS based back-end processing requests originating from multiple clients. Each business that uses the SaaS point of sale can…"/><meta data-react-helmet="true" property="og:site_name" content="Multi tenancy in Spring MVC - Piotr Mionskowski"/><meta data-react-helmet="true" property="og:image" content="https://miensol.pl//[object Object]"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:title" content="Multi tenancy in Spring MVC - Piotr Mionskowski"/><meta data-react-helmet="true" name="twitter:description" content="One of our clients aimed to replace old, often DOS based, point of sale systems with a cloud based, SaaS modeled solution. At Bright Inventions we have developed all required components including AWS based back-end processing requests originating from multiple clients. Each business that uses the SaaS point of sale can…"/><meta data-react-helmet="true" name="twitter:image" content="https://miensol.pl//[object Object]"/><link as="script" rel="preload" href="/webpack-runtime-81078feff732a01ca8b6.js"/><link as="script" rel="preload" href="/framework-ff21b39501fa5007c91d.js"/><link as="script" rel="preload" href="/532a2f07-5faf1395916999ba184f.js"/><link as="script" rel="preload" href="/app-6174af72088d24da11e8.js"/><link as="script" rel="preload" href="/styles-8636a280cbc61d53ad10.js"/><link as="script" rel="preload" href="/c39ba592b6b5047a9857340a927d4f5e647ac87b-a4bdae0c130dc607cbb4.js"/><link as="script" rel="preload" href="/70ba16277e1f8ff187315c677a20c57a8b12f94a-076ebef65155af783aeb.js"/><link as="script" rel="preload" href="/component---src-templates-post-template-tsx-c32fd150628cfd6dfdcc.js"/><link as="fetch" rel="preload" href="/page-data/spring-mvc-multi-tenacy/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="Layout-module--layout--3Pyz6"><div><a class="Post-module--post__home-button--16Kl0" href="/">All Articles</a><div><div class="Content-module--content--3p512"><h1 class="Content-module--content__title--2BDW9">Multi tenancy in Spring MVC</h1><div class="Content-module--content__body--2TrQ-"><p>One of our clients aimed to replace old, often DOS based, point of sale systems with a cloud based, SaaS modeled solution. <a href="%7B%7B%20site.url%20%7D%7D">At Bright Inventions</a> we have developed all required components including AWS based back-end processing requests originating from multiple clients. Each business that uses the SaaS point of sale can be considered a tenant in a multi-tenant environment. There many aspects involved when developing multi-tenant application with <a href="http://blog.memsql.com/database-multi-tenancy-in-the-cloud-and-beyond/" target="_blank" rel="nofollow noopener noreferrer">data isolation and partitioning being the most discussed topic</a>. However, today I would like to focus on computational and resource isolation aspect. </p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 640px;"
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/65e9deab4d4cfc809010da9861f98e48/c08c5/feeding-animals.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAMEAQL/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAABYvucvMLP/8QAGBABAQEBAQAAAAAAAAAAAAAAAQIAAwT/2gAIAQEAAQUCZgBhxG6cqrT5kxKb/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGxAAAQQDAAAAAAAAAAAAAAAAAAERITICMXH/2gAIAQEABj8CkVlbpYjIsbP/xAAaEAADAAMBAAAAAAAAAAAAAAAAAREhQYFx/9oACAEBAAE/Ibd2ntM1ZOei6xXTJs6NAklH/9oADAMBAAIAAwAAABDYL//EABURAQEAAAAAAAAAAAAAAAAAABAh/9oACAEDAQE/EIf/xAAVEQEBAAAAAAAAAAAAAAAAAAAQIf/aAAgBAgEBPxCn/8QAHBABAAMAAgMAAAAAAAAAAAAAAQARITFBUWGB/9oACAEBAAE/EDwXoLQeMlmYEuEWyoGrGSw1OlkQX7J5hFfKf//Z'); background-size: cover; display: block;"
  ></span>
  <picture>
        <source
          srcset="/static/65e9deab4d4cfc809010da9861f98e48/8ac56/feeding-animals.webp 240w,
/static/65e9deab4d4cfc809010da9861f98e48/d3be9/feeding-animals.webp 480w,
/static/65e9deab4d4cfc809010da9861f98e48/0ba47/feeding-animals.webp 640w"
          sizes="(max-width: 640px) 100vw, 640px"
          type="image/webp"
        />
        <source
          srcset="/static/65e9deab4d4cfc809010da9861f98e48/09b79/feeding-animals.jpg 240w,
/static/65e9deab4d4cfc809010da9861f98e48/7cc5e/feeding-animals.jpg 480w,
/static/65e9deab4d4cfc809010da9861f98e48/c08c5/feeding-animals.jpg 640w"
          sizes="(max-width: 640px) 100vw, 640px"
          type="image/jpeg"
        />
        <img
          class="gatsby-resp-image-image"
          src="/static/65e9deab4d4cfc809010da9861f98e48/c08c5/feeding-animals.jpg"
          alt="Multiple consumers"
          title="Multiple consumers"
          loading="lazy"
          style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        />
      </picture>
  </a>
    </span></p>
<h2 id="controlled-resource-usage" style="position:relative;"><a href="#controlled-resource-usage" aria-label="controlled resource usage permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Controlled resource usage</h2>
<p>In the discussed case each tenant would have multiple iOS based API clients. The exact number varies from 1 to couple of dozens. Each iOS application would be open constantly throughout a sales day and execute frequent requests against the back-end API. In the iOS application there was a code that polls the server for data changes in frequent and regular intervals. Unfortunately a bug slipped through a code review and caused the app to ask the server for changes around 50 times per second instead of once in half of a minute. The bug caused an explosion of API requests issued by a single API client with a throughput 10 to 100 times bigger than expected. To make things worse the rate at which the bug increased polling frequency exceeded back-end the scaling out policy. Soon all request processing threads were busy processing requests issued by only a small percentile of API clients. </p>
<p>In a multi-tenant application one needs to take special care to prevent tenant “A” from affecting, even indirectly, tenant “B” operations. We have failed that requirement on the CPU/thread pool level and that caused the support lines to be hot. </p>
<h2 id="reverse-proxy-request-rate-limit" style="position:relative;"><a href="#reverse-proxy-request-rate-limit" aria-label="reverse proxy request rate limit permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Reverse proxy request rate limit</h2>
<p>The first solution that comes to mind is to apply a per API client request rate limiting. In fact this solution is so common that it is available as a configuration opt-in in many servers. For instance <a href="https://www.nginx.com/blog/rate-limiting-nginx/" target="_blank" rel="nofollow noopener noreferrer">in NGINX you could do</a>:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">limit_req_zone $binary_remote_addr zone=mylimit:10m rate=10r/s;

server {
    location /login/ {
        limit_req zone=mylimit burst=20;

        proxy_pass http://my_upstream;
    }
}</code></pre></div>
<p>The above would only allow up to 10 request per second from the same IP address. Any request that comes in at higher rate would be queued up to specified capacity (<code class="language-text">burst=20</code>). Any request above the limit would get rejected with 503 status code. </p>
<p>The nginx approach is battle tested and fairly easy to apply. Instead of using IP address it would be better to group requests by a tenant identifier. However, it may not be easy to determine exactly which tenant is making the request unless the information is easily available in the request headers. For that matter it is good to consider sending the API client identification using a custom HTTP header. For instance if the API client provides <code class="language-text">X-Tenant-Id: tenant.1</code> you can use it as <code class="language-text">limit_req_zone $http_x_tenant_id zone=mylimit:10m rate=10r/s;</code>. When using JWT, you often can determine <em>who</em> is making the request by parsing the <code class="language-text">Authorization</code> header value. </p>
<h2 id="spring-mvc-request-rate-limit" style="position:relative;"><a href="#spring-mvc-request-rate-limit" aria-label="spring mvc request rate limit permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Spring MVC request rate limit</h2>
<p>It is often not feasible to apply the request rate limit at the reverse proxy level. In such scenario we can apply the limit inside Spring MVC application. For start one can try suing <a href="http://www.oracle.com/technetwork/java/filters-137243.html" target="_blank" rel="nofollow noopener noreferrer">Servlet Filter</a>. <a href="https://stackoverflow.com/questions/10127472/servlet-filter-very-simple-rate-limiting-filter-allowing-bursts" target="_blank" rel="nofollow noopener noreferrer">There are several solutions</a> available including a <a href="https://www.eclipse.org/jetty/javadoc/9.4.7.v20170914/org/eclipse/jetty/servlets/DoSFilter.html" target="_blank" rel="nofollow noopener noreferrer">DoSFilter that is part of Jetty project</a>.</p>
<p>Using a ready-made Servlet Filter is often sufficient especially when the available customization options suit our needs. In case of our client however, we wanted the limits to depend on the <em>size</em> of the client. In other words the more service you buy, the more resources are available to you. Moreover, I wanted to have a have fine-grained control at <strong>a controller action</strong> level. To my surprise such behavior was not easy to accomplish using <a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/servlet/AsyncHandlerInterceptor.html" target="_blank" rel="nofollow noopener noreferrer">AsyncHandlerInterceptor</a>. Fortunately I did find a way to achieve a desired result using a mix of extensibility points and hacks. </p>
<p>The first step is to customize <a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/servlet/mvc/method/annotation/RequestMappingHandlerAdapter.html" target="_blank" rel="nofollow noopener noreferrer"><code class="language-text">RequestMappingHandlerAdapter</code></a> used by Spring MVC to transform <code class="language-text">@RequestMapping</code> annotation into handler classes. The following configuration class in Kotlin achieves just that:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token annotation builtin">@Configuration</span>
<span class="token keyword">class</span> WebMvcConfiguration <span class="token operator">:</span> <span class="token function">DelegatingWebMvcConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token annotation builtin">@Autowired</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> mvcProperties<span class="token operator">:</span> WebMvcProperties<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>

    <span class="token annotation builtin">@Inject</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> reactiveRequestCommandFactory<span class="token operator">:</span> ReactiveRequestCommandFactory
    <span class="token annotation builtin">@Inject</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> reactiveRequestsProperties<span class="token operator">:</span> ReactiveRequestsConfiguration<span class="token punctuation">.</span>RequestsProperties

    <span class="token annotation builtin">@Bean</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">requestMappingHandlerAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> RequestMappingHandlerAdapter <span class="token punctuation">{</span>
        <span class="token comment">//copy pasted from WebMvcConfigurationSupport</span>
        <span class="token keyword">val</span> argumentResolvers <span class="token operator">=</span> ArrayList<span class="token operator">&lt;</span>HandlerMethodArgumentResolver<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">addArgumentResolvers</span><span class="token punctuation">(</span>argumentResolvers<span class="token punctuation">)</span>

        <span class="token keyword">val</span> returnValueHandlers <span class="token operator">=</span> ArrayList<span class="token operator">&lt;</span>HandlerMethodReturnValueHandler<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">addReturnValueHandlers</span><span class="token punctuation">(</span>returnValueHandlers<span class="token punctuation">)</span>

        <span class="token keyword">val</span> adapter <span class="token operator">=</span> <span class="token function">RateLimitingRequestMappingHandlerAdapter</span><span class="token punctuation">(</span>reactiveRequestCommandFactory<span class="token punctuation">,</span> reactiveRequestsProperties<span class="token punctuation">)</span>

        adapter<span class="token punctuation">.</span><span class="token function">setContentNegotiationManager</span><span class="token punctuation">(</span><span class="token function">mvcContentNegotiationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        adapter<span class="token punctuation">.</span>messageConverters <span class="token operator">=</span> messageConverters
        adapter<span class="token punctuation">.</span>webBindingInitializer <span class="token operator">=</span> configurableWebBindingInitializer
        adapter<span class="token punctuation">.</span>customArgumentResolvers <span class="token operator">=</span> argumentResolvers

        adapter<span class="token punctuation">.</span>customReturnValueHandlers <span class="token operator">=</span> returnValueHandlers

        <span class="token keyword">val</span> requestBodyAdvices <span class="token operator">=</span> ArrayList<span class="token operator">&lt;</span>RequestBodyAdvice<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        requestBodyAdvices<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">JsonViewRequestBodyAdvice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        adapter<span class="token punctuation">.</span><span class="token function">setRequestBodyAdvice</span><span class="token punctuation">(</span>requestBodyAdvices<span class="token punctuation">)</span>

        <span class="token keyword">val</span> responseBodyAdvices <span class="token operator">=</span> ArrayList<span class="token operator">&lt;</span>ResponseBodyAdvice<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        responseBodyAdvices<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">JsonViewResponseBodyAdvice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        adapter<span class="token punctuation">.</span><span class="token function">setResponseBodyAdvice</span><span class="token punctuation">(</span>responseBodyAdvices<span class="token punctuation">)</span>

        <span class="token function">configureAsync</span><span class="token punctuation">(</span>adapter<span class="token punctuation">)</span>


        adapter<span class="token punctuation">.</span><span class="token function">setIgnoreDefaultModelOnRedirect</span><span class="token punctuation">(</span>mvcProperties<span class="token operator">?</span><span class="token punctuation">.</span>isIgnoreDefaultModelOnRedirect <span class="token operator">!=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> adapter
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">configureAsync</span><span class="token punctuation">(</span>adapter<span class="token operator">:</span> RequestMappingHandlerAdapter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//expose field publicly</span>
        <span class="token keyword">val</span> configurer <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span> <span class="token function">AsyncSupportConfigurer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getCallableInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getCallableInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getDeferredResultInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getDeferredResultInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token function">configureAsyncSupport</span><span class="token punctuation">(</span>configurer<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>configurer<span class="token punctuation">.</span>taskExecutor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            adapter<span class="token punctuation">.</span><span class="token function">setTaskExecutor</span><span class="token punctuation">(</span>configurer<span class="token punctuation">.</span>taskExecutor<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>configurer<span class="token punctuation">.</span>timeout <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            adapter<span class="token punctuation">.</span><span class="token function">setAsyncRequestTimeout</span><span class="token punctuation">(</span>configurer<span class="token punctuation">.</span>timeout<span class="token operator">!!</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        adapter<span class="token punctuation">.</span><span class="token function">setCallableInterceptors</span><span class="token punctuation">(</span>configurer<span class="token punctuation">.</span>callableInterceptors<span class="token punctuation">)</span>
        adapter<span class="token punctuation">.</span><span class="token function">setDeferredResultInterceptors</span><span class="token punctuation">(</span>configurer<span class="token punctuation">.</span>deferredResultInterceptors<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Note that we are injecting <code class="language-text">reactiveRequestCommandFactory</code> and <code class="language-text">reactiveRequestsProperties</code> and pass them into our core <code class="language-text">RateLimitingRequestMappingHandlerAdapter</code>. All other code is a mostly a copy-paste from <code class="language-text">DelegatingWebMvcConfiguration</code> base class.</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token annotation builtin">@Target</span><span class="token punctuation">(</span>AnnotationTarget<span class="token punctuation">.</span>CLASS<span class="token punctuation">,</span> AnnotationTarget<span class="token punctuation">.</span>FUNCTION<span class="token punctuation">)</span>
<span class="token keyword">annotation</span> <span class="token keyword">class</span> <span class="token function">RequestCommand</span><span class="token punctuation">(</span>
    <span class="token keyword">val</span> enabled<span class="token operator">:</span> Boolean <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token keyword">val</span> timeoutInMillis<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token number">60_000</span>
<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token function">RateLimitingRequestMappingHandlerAdapter</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> reactiveRequestCommandFactory<span class="token operator">:</span> ReactiveRequestCommandFactory<span class="token punctuation">,</span>
                                               <span class="token keyword">private</span> <span class="token keyword">val</span> reactiveRequestProperties<span class="token operator">:</span> ReactiveRequestsConfiguration<span class="token punctuation">.</span>RequestsProperties<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">RequestMappingHandlerAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> handlerMethodConfigurationsCache <span class="token operator">=</span> ConcurrentHashMap<span class="token operator">&lt;</span>HandlerMethod<span class="token punctuation">,</span> RequestCommandConfiguration<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">createInvocableHandlerMethod</span><span class="token punctuation">(</span>handlerMethod<span class="token operator">:</span> HandlerMethod<span class="token punctuation">)</span><span class="token operator">:</span> ServletInvocableHandlerMethod<span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> configuration <span class="token operator">=</span> <span class="token function">requestCommandConfigurationFor</span><span class="token punctuation">(</span>handlerMethod<span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token keyword">when</span> <span class="token punctuation">{</span>
            configuration<span class="token punctuation">.</span>enabled <span class="token operator">&amp;&amp;</span> reactiveRequestProperties<span class="token punctuation">.</span>enabled <span class="token operator">-></span> <span class="token function">CommandInvocableHandlerMethod</span><span class="token punctuation">(</span>handlerMethod<span class="token punctuation">,</span> reactiveRequestCommandFactory<span class="token punctuation">,</span> configuration<span class="token punctuation">)</span>
            <span class="token keyword">else</span> <span class="token operator">-></span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">createInvocableHandlerMethod</span><span class="token punctuation">(</span>handlerMethod<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">requestCommandConfigurationFor</span><span class="token punctuation">(</span>handlerMethod<span class="token operator">:</span> HandlerMethod<span class="token punctuation">)</span><span class="token operator">:</span> RequestCommandConfiguration <span class="token punctuation">{</span>
        <span class="token keyword">return</span> handlerMethodConfigurationsCache<span class="token punctuation">.</span><span class="token function">getOrPut</span><span class="token punctuation">(</span>handlerMethod<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> method <span class="token operator">=</span> handlerMethod<span class="token punctuation">.</span><span class="token function">getMethodAnnotation</span><span class="token punctuation">(</span>RequestCommand<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
            <span class="token keyword">val</span> methodOrController <span class="token operator">=</span> method <span class="token operator">?:</span> AnnotatedElementUtils<span class="token punctuation">.</span><span class="token function">findMergedAnnotation</span><span class="token punctuation">(</span>handlerMethod<span class="token punctuation">.</span>beanType<span class="token punctuation">,</span> RequestCommand<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
            methodOrController<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{</span> <span class="token function">RequestCommandConfiguration</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token operator">?:</span> RequestCommandConfiguration<span class="token punctuation">.</span>Default
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Inside of <code class="language-text">createInvocableHandlerMethod</code> we get the configuration for the <code class="language-text">handlerMethod</code> determined by Spring MVC. The <code class="language-text">handlerMethod</code> denotes a controller action. Then we decide if we should use the rate limiting handler or fallback to the default one. In case we need to apply rate limiting we switch the invocation to use custom <code class="language-text">CommandInvocableHandlerMethod</code>:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">CommandInvocableHandlerMethod</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> handlerMethod<span class="token operator">:</span> HandlerMethod<span class="token punctuation">,</span>
                                    <span class="token keyword">private</span> <span class="token keyword">val</span> requestCommandFactory<span class="token operator">:</span> RequestCommandFactory<span class="token punctuation">,</span>
                                    <span class="token keyword">private</span> <span class="token keyword">val</span> configuration<span class="token operator">:</span> RequestCommandConfiguration<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">ServletInvocableHandlerMethod</span><span class="token punctuation">(</span>handlerMethod<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> returnValueHandlers<span class="token operator">:</span> HandlerMethodReturnValueHandlerComposite

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">invokeForRequest</span><span class="token punctuation">(</span>request<span class="token operator">:</span> NativeWebRequest<span class="token operator">?</span><span class="token punctuation">,</span> mavContainer<span class="token operator">:</span> ModelAndViewContainer<span class="token operator">?</span><span class="token punctuation">,</span> <span class="token keyword">vararg</span> providedArgs<span class="token operator">:</span> Any<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> Any <span class="token punctuation">{</span>
        <span class="token comment">// same as super.invokeForRequest(request, mavContainer, *providedArgs)</span>
        <span class="token comment">// but with request passed to do invoke</span>
        <span class="token keyword">val</span> args <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>getMethodArgumentValuesCallable<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> mavContainer<span class="token punctuation">,</span> providedArgs<span class="token punctuation">)</span>
        <span class="token keyword">val</span> result <span class="token operator">=</span> <span class="token function">doInvokeWithRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
        <span class="token keyword">return</span> result
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">doInvokeWithRequest</span><span class="token punctuation">(</span>request<span class="token operator">:</span> NativeWebRequest<span class="token operator">?</span><span class="token punctuation">,</span> args<span class="token operator">:</span> Array<span class="token operator">&lt;</span><span class="token keyword">out</span> Any<span class="token operator">?</span><span class="token operator">></span><span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> Any <span class="token punctuation">{</span>
        <span class="token keyword">val</span> nativeRequest <span class="token operator">=</span> request<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getNativeRequest</span><span class="token punctuation">(</span>HttpServletRequest<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>

        <span class="token comment">// If the response has already set error status code tomcat will not wait for async result</span>
        <span class="token keyword">return</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nativeRequest <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> nativeRequest<span class="token punctuation">.</span>dispatcherType <span class="token operator">==</span> DispatcherType<span class="token punctuation">.</span>REQUEST<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> callSuper <span class="token operator">=</span> Callable <span class="token punctuation">{</span>
                <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">doInvoke</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>args <span class="token operator">?:</span> <span class="token function">emptyArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">val</span> job <span class="token operator">=</span> callSuper

            <span class="token keyword">val</span> context <span class="token operator">=</span> <span class="token function">RequestCommandContext</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> handlerMethod<span class="token punctuation">,</span> SecurityContextHolder<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> job<span class="token punctuation">)</span>

            <span class="token keyword">val</span> result <span class="token operator">=</span> requestCommandFactory<span class="token punctuation">.</span><span class="token function">createSingle</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>

            <span class="token function">MonoDeferredResult</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">doInvoke</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>args <span class="token operator">?:</span> <span class="token function">emptyArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">setHandlerMethodReturnValueHandlers</span><span class="token punctuation">(</span>returnValueHandlers<span class="token operator">:</span> HandlerMethodReturnValueHandlerComposite<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>returnValueHandlers <span class="token operator">=</span> returnValueHandlers<span class="token operator">!!</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setHandlerMethodReturnValueHandlers</span><span class="token punctuation">(</span>returnValueHandlers<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">wrapConcurrentResult</span><span class="token punctuation">(</span>result<span class="token operator">:</span> Any<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> ServletInvocableHandlerMethod <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">ConcurrentResultHandlerMethod</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token function">ConcurrentResultMethodParameter</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token operator">..</span><span class="token punctuation">.</span></code></pre></div>
<p>The above code is using <em>private</em> <a href="https://github.com/spring-projects/spring-framework/blob/cc74a28/spring-web/src/main/java/org/springframework/web/method/support/InvocableHandlerMethod.java#L147" target="_blank" rel="nofollow noopener noreferrer"><code class="language-text">getMethodArgumentValues</code></a> API to achieve the desired behavior‼ The <code class="language-text">doInvokeWithRequest</code> checks if an asynchronous dispatch should be performed and if so creates a <a href="https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Mono.html" target="_blank" rel="nofollow noopener noreferrer"><code class="language-text">Mono</code></a> that denotes the result of the controller action method invocation. <code class="language-text">RequestCommandContext</code> stores the information about target controller action method and current security context. The security context needs to be preserved when invoking the controller action on a different thread. The <a href="https://gist.github.com/miensol/cca73d158ce8e7664ed653a30fc8dc70" target="_blank" rel="nofollow noopener noreferrer"><code class="language-text">ConcurrentResultHandlerMethod</code></a> extends <code class="language-text">ServletInvocableHandlerMethod</code> to add support for using <code class="language-text">Mono</code> on regular, synchronous controller action. The core logic of rate limiting is delegated to <code class="language-text">ReactiveRequestCommandFactory</code>:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token keyword">interface</span> ReactiveRequestCommandFactory <span class="token punctuation">{</span>
    <span class="token keyword">fun</span> <span class="token function">createSingle</span><span class="token punctuation">(</span>context<span class="token operator">:</span> RequestCommandContext<span class="token punctuation">)</span><span class="token operator">:</span> Mono<span class="token operator">&lt;</span>Optional<span class="token operator">&lt;</span>Any<span class="token operator">></span><span class="token operator">></span>
<span class="token punctuation">}</span></code></pre></div>
<p>The factory responsibilty it to convert a request context into an async result. Spring MVC 5 <a href="https://docs.spring.io/spring-framework/docs/5.0.0.BUILD-SNAPSHOT/spring-framework-reference/html/web-reactive.html" target="_blank" rel="nofollow noopener noreferrer">has built in support for Reactor</a> hence we decided to use this implementation of <a href="http://www.reactive-streams.org/" target="_blank" rel="nofollow noopener noreferrer">Reactive Streams specification</a>. The <code class="language-text">ReactiveRequestCommandFactory</code> looks as follows:</p>
<div class="gatsby-highlight" data-language="kotlin"><pre class="language-kotlin"><code class="language-kotlin"><span class="token annotation builtin">@Component</span>
<span class="token keyword">class</span> <span class="token function">ReactorRequestCommandFactory</span><span class="token punctuation">(</span>
    threadPoolPropertiesCalculator<span class="token operator">:</span> ThreadPoolPropertiesCalculator<span class="token punctuation">,</span>
    <span class="token annotation builtin">@param:Named</span><span class="token punctuation">(</span><span class="token string">"reactiveRequestsScheduler"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> reactiveRequestsScheduler<span class="token operator">:</span> Schedule
<span class="token punctuation">)</span> <span class="token operator">:</span> ReactiveRequestCommandFactory <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> threadPoolPropertiesCalculator <span class="token operator">=</span> <span class="token function">HystrixConfigurationAwarePropertiesCalculator</span><span class="token punctuation">(</span>threadPoolPropertiesCalculator<span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> tenants <span class="token operator">=</span> ConcurrentHashMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> TenantTaskCoordinator<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">createSingle</span><span class="token punctuation">(</span>context<span class="token operator">:</span> RequestCommandContext<span class="token punctuation">)</span><span class="token operator">:</span> Mono<span class="token operator">&lt;</span>Optional<span class="token operator">&lt;</span>Any<span class="token operator">></span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> properties <span class="token operator">=</span> threadPoolPropertiesCalculator<span class="token punctuation">.</span><span class="token function">newThreadPoolProperties</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>

        <span class="token keyword">val</span> taskCoordinator <span class="token operator">=</span> tenants<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span>threadPoolName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">TenantTaskCoordinator</span><span class="token punctuation">(</span>reactiveRequestsScheduler<span class="token punctuation">,</span>
                maximumConcurrency <span class="token operator">=</span> properties<span class="token punctuation">.</span>maximumThreads<span class="token punctuation">,</span>
                maximumQueueSize <span class="token operator">=</span> properties<span class="token punctuation">.</span>maximumQueueSize<span class="token punctuation">,</span>
                name <span class="token operator">=</span> properties<span class="token punctuation">.</span>threadPoolName
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">val</span> optionalCallable <span class="token operator">=</span> <span class="token function">OptionalCallable</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>job<span class="token punctuation">)</span>
        <span class="token keyword">val</span> configureRequestAttributes <span class="token operator">=</span> <span class="token function">SpringServletRequestAttributesCallable</span><span class="token punctuation">(</span>optionalCallable<span class="token punctuation">)</span>
        <span class="token keyword">val</span> configureLocale <span class="token operator">=</span> <span class="token function">SpringLocaleContextCallable</span><span class="token punctuation">(</span>configureRequestAttributes<span class="token punctuation">)</span>
        <span class="token keyword">val</span> securityCallable <span class="token operator">=</span> <span class="token function">DelegatingSecurityContextCallable</span><span class="token punctuation">(</span>configureLocale<span class="token punctuation">,</span> context<span class="token punctuation">.</span>securityContext<span class="token punctuation">)</span>

        <span class="token keyword">return</span> taskCoordinator<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>securityCallable<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span>Duration<span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span>timeoutInMillis<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">OptionalCallable</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> <span class="token keyword">inner</span><span class="token operator">:</span> RequestHandlerJob<span class="token punctuation">)</span> <span class="token operator">:</span> Callable<span class="token operator">&lt;</span>Optional<span class="token operator">&lt;</span>Any<span class="token operator">></span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Optional<span class="token operator">&lt;</span>Any<span class="token operator">></span> <span class="token operator">=</span> Optional<span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span><span class="token keyword">inner</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The <code class="language-text">ThreadPoolPropertiesCalculator</code> calculates how concurrent threads and how big the requests queue should be for particular tenant or tenants group. Then for each tenant group, in particular a single tenant, we create a <code class="language-text">TenantTaskCoordinator</code> responsible for calculating and enforcing limits on concurrently handled requests. Further down we decorate the <code class="language-text">Callable</code> representing the actual request handling with security delegation, locale configuration and request attributes setup. Finally, we ask the <code class="language-text">TenantTaskCoordinator</code> to execute the decorated job with a configured timeout.</p>
<p>The last piece of the puzzle, namely <code class="language-text">TenantTaskCoordinator</code> requires a separate blog post so stay tuned.</p></div></div></div><div class="Post-module--post__footer--3WzWU"><div><p class="Meta-module--meta__date--29eD7">Published <!-- -->12 Dec 2017</p></div><div class="Tags-module--tags--1L_ct"><ul class="Tags-module--tags__list--91FqN"><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/spring/">spring</a></li><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/mvc/">mvc</a></li><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/spring-boot/">spring boot</a></li><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/multi-tenant/">multi-tenant</a></li><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/reactive/">reactive</a></li><li class="Tags-module--tags__list-item--1M30P"><a class="Tags-module--tags__list-item-link--3SL_8" href="/tag/reactor/">reactor</a></li></ul></div><div class="Author-module--author--2Yefr"><p>TDD fan eager to learn new things. Always focused, always eager to ask why?<a class="Author-module--author__bio-contact--8_j8F" href="mailto:piotr.mionskowski@gmail.com" rel="noopener noreferrer" target="_blank"><strong>Piotr Mionskowski</strong></a></p></div></div><div class="Post-module--post__comments--25y6I"><div><div id="disqus_thread"></div></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/spring-mvc-multi-tenacy/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-6174af72088d24da11e8.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-78521276b246725d0e0f.js"],"component---src-templates-categories-list-template-tsx":["/component---src-templates-categories-list-template-tsx-1443a27db8e607e06eaf.js"],"component---src-templates-category-template-tsx":["/component---src-templates-category-template-tsx-9b2527fed1bbc12d167a.js"],"component---src-templates-index-template-tsx":["/component---src-templates-index-template-tsx-90ea64a37c4d7b280402.js"],"component---src-templates-not-found-template-tsx":["/component---src-templates-not-found-template-tsx-3d89186c897c9782220b.js"],"component---src-templates-page-template-tsx":["/component---src-templates-page-template-tsx-daedb109729ccd084ce5.js"],"component---src-templates-post-template-tsx":["/component---src-templates-post-template-tsx-c32fd150628cfd6dfdcc.js"],"component---src-templates-tag-template-tsx":["/component---src-templates-tag-template-tsx-0485877a475bb21e2d32.js"],"component---src-templates-tags-list-template-tsx":["/component---src-templates-tags-list-template-tsx-82656016ea107e26a0f3.js"]};/*]]>*/</script><script src="/component---src-templates-post-template-tsx-c32fd150628cfd6dfdcc.js" async=""></script><script src="/70ba16277e1f8ff187315c677a20c57a8b12f94a-076ebef65155af783aeb.js" async=""></script><script src="/c39ba592b6b5047a9857340a927d4f5e647ac87b-a4bdae0c130dc607cbb4.js" async=""></script><script src="/styles-8636a280cbc61d53ad10.js" async=""></script><script src="/app-6174af72088d24da11e8.js" async=""></script><script src="/532a2f07-5faf1395916999ba184f.js" async=""></script><script src="/framework-ff21b39501fa5007c91d.js" async=""></script><script src="/webpack-runtime-81078feff732a01ca8b6.js" async=""></script></body></html>